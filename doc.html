<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Der Schlagbaumverk</title>
<!-- 2016-01-30 Сб. 18:22 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="pyub" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 87 -*- -->
<!-- org-toggle-inline-images -->

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "overview");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Der Schlagbaumverk</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. <span class="done nilDONE">DONE</span> Состояние запуска подробно.&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ranma">ranma</span>&#xa0;<span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-2">2. <span class="done nilDONE">DONE</span> Обмен по TCP-IP&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-3">3. Теги&#xa0;&#xa0;&#xa0;<span class="tag"><span class="important">important</span></span></a></li>
<li><a href="#sec-4">4. Цель</a>
<ul>
<li><a href="#sec-4-1">4.1. Компоненты решения</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1. Контроллер</a></li>
<li><a href="#sec-4-1-2">4.1.2. Печатные платы</a></li>
<li><a href="#sec-4-1-3">4.1.3. Программное обеспечение</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. Описание функционирования</a>
<ul>
<li><a href="#sec-5-1">5.1. Общий принцип работы</a></li>
<li><a href="#sec-5-2">5.2. <span class="todo nilWAIT">WAIT</span> Парковочные места, тарифные зоны и сектора</a>
<ul>
<li><a href="#sec-5-2-1">5.2.1. <span class="todo nilWAIT">WAIT</span> Распределение паркомест</a></li>
<li><a href="#sec-5-2-2">5.2.2. <span class="todo nilWAIT">WAIT</span> Тарифная зона</a></li>
<li><a href="#sec-5-2-3">5.2.3. <span class="todo nilWAIT">WAIT</span> Сектор парковки</a></li>
</ul>
</li>
<li><a href="#sec-5-3">5.3. Логирование сообщений</a></li>
<li><a href="#sec-5-4">5.4. <span class="todo nilTODO">TODO</span> Состояния стойки при проезде&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-5-4-1">5.4.1. <span class="todo nilTODO">TODO</span> Состояние запуска (<code>poweron</code>)</a></li>
<li><a href="#sec-5-4-2">5.4.2. <span class="todo nilTODO">TODO</span> Состояние тестирования (<code>selftest</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="ranma">ranma</span></span></a></li>
<li><a href="#sec-5-4-3">5.4.3. <span class="done nilDONE">DONE</span> Состояние ожидания (<code>standby</code>)</a></li>
<li><a href="#sec-5-4-4">5.4.4. <span class="todo nilTODO">TODO</span> Подъезд машины к стойке (<code>finding</code>)</a></li>
<li><a href="#sec-5-4-5">5.4.5. <span class="todo nilTODO">TODO</span> Стойка в диалоговом режиме (<code>dialog</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-4-6">5.4.6. <span class="todo nilTODO">TODO</span> Инициация процедуры проезда (<code>init</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-4-7">5.4.7. <span class="todo nilTODO">TODO</span> Процедура проезда (<code>goon</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-4-8">5.4.8. <span class="todo nilTODO">TODO</span> Процедура завершения проезда (<code>fin</code>)</a></li>
<li><a href="#sec-5-4-9">5.4.9. <span class="todo nilTODO">TODO</span> Cостояние полной блокировки (<code>hardlock</code>)</a></li>
<li><a href="#sec-5-4-10">5.4.10. <span class="todo nilWAIT">WAIT</span> Процедура частичной блокировки (<code>softlock</code>)</a></li>
<li><a href="#sec-5-4-11">5.4.11. <span class="todo nilWAIT">WAIT</span> Процедура оплаты (<code>payment</code>)</a></li>
</ul>
</li>
<li><a href="#sec-5-5">5.5. <span class="todo nilTODO">TODO</span> Обработка сигналов и сообщений&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-5-5-1">5.5.1. <span class="todo nilTODO">TODO</span> Входящие сигналы с датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-5-2">5.5.2. <span class="todo nilTODO">TODO</span> Отмена проезда по чеку&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-5-3">5.5.3. <span class="todo nilTODO">TODO</span> Повторная печать въездного билета&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-5-4">5.5.4. Настройки администратора из web-интерфейса контроллера</a></li>
<li><a href="#sec-5-5-5">5.5.5. Тестирование и диагностика из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></a></li>
<li><a href="#sec-5-5-6">5.5.6. Настройки тарификации из web-интерфейса контроллера</a></li>
<li><a href="#sec-5-5-7">5.5.7. <span class="todo nilTODO">TODO</span> Действия посетителя&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-5-8">5.5.8. Сообщения переферийных устройств контроллеру</a></li>
</ul>
</li>
<li><a href="#sec-5-6">5.6. <span class="todo nilTODO">TODO</span> Алгоритмы проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-5-6-1">5.6.1. Алгоритм простого въезда по чеку <code>barcode</code> <code>enter</code></a></li>
<li><a href="#sec-5-6-2">5.6.2. <span class="todo nilTODO">TODO</span> Алгоритм простого выезда по чеку&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-6-3">5.6.3. <span class="todo nilTODO">TODO</span> Алгоритм проезда по карте СКУД&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-7">5.7. <span class="todo nilWAIT">WAIT</span> Усложнения алгоритмов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-5-7-1">5.7.1. <span class="todo nilTODO">TODO</span> Проезд по шлюзу / рампе</a></li>
<li><a href="#sec-5-7-2">5.7.2. <span class="todo nilWAIT">WAIT</span> Фотофиксация въезда</a></li>
<li><a href="#sec-5-7-3">5.7.3. <span class="todo nilWAIT">WAIT</span> Звуковое сопровождение</a></li>
</ul>
</li>
<li><a href="#sec-5-8">5.8. <span class="todo nilTODO">TODO</span> Алгоритмы работы с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-5-8-1">5.8.1. <span class="todo nilTODO">TODO</span> Работа с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-8-2">5.8.2. <span class="todo nilTODO">TODO</span> Процедура оплаты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-8-3">5.8.3. <span class="todo nilTODO">TODO</span> Процедура инкассации&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-8-4">5.8.4. <span class="todo nilTODO">TODO</span> Процедура закрытия смены&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-9">5.9. <span class="todo nilTODO">TODO</span> Роли пользователей системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-5-9-1">5.9.1. Суперадминистратор (root)</a></li>
<li><a href="#sec-5-9-2">5.9.2. Администратор (admin)</a></li>
<li><a href="#sec-5-9-3">5.9.3. <span class="todo nilTODO">TODO</span> Оператор&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-9-4">5.9.4. Бухгалтер</a></li>
<li><a href="#sec-5-9-5">5.9.5. Посетитель парковки</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6">6. Этапы, сроки, задачи</a>
<ul>
<li><a href="#sec-6-1">6.1. <span class="todo nilTODO">TODO</span> Этапы и сроки</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1. Пилотный функционал (до 1 марта 2016)</a></li>
<li><a href="#sec-6-1-2">6.1.2. Функционал второго этапа (с 1 марта 2016)</a></li>
</ul>
</li>
<li><a href="#sec-6-2">6.2. Задачи общего характера</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1. <span class="todo nilSTART">START</span> [pyub] Описание алгоритмов взаимодействия постетителя и АСПП</a></li>
<li><a href="#sec-6-2-2">6.2.2. <span class="todo nilWAIT">WAIT</span> [ranma] Отладка и интеграционное тестирование</a></li>
<li><a href="#sec-6-2-3">6.2.3. <span class="todo nilWAIT">WAIT</span> [all] Проверка элементов системы на макете прототипа</a></li>
</ul>
</li>
<li><a href="#sec-6-3">6.3. Задачи hardware</a>
<ul>
<li><a href="#sec-6-3-1">6.3.1. <span class="done nilDONE">DONE</span> [bda]Выбор микрокомпьютера для контроллера</a></li>
<li><a href="#sec-6-3-2">6.3.2. <span class="done nilDONE">DONE</span> [pyub] Покупка плат BeagleBone Black и Development Kit</a></li>
<li><a href="#sec-6-3-3">6.3.3. <span class="done nilDONE">DONE</span> [bda] Подбор редких комплектующих для платы расширения</a></li>
<li><a href="#sec-6-3-4">6.3.4. DONE [ranma] Дерганье ногами на BBB</a></li>
<li><a href="#sec-6-3-5">6.3.5. <span class="todo nilTODO">TODO</span> [bda] Подбор основной части комплектующих для платы расширения</a></li>
<li><a href="#sec-6-3-6">6.3.6. <span class="done nilDONE">DONE</span> [noa] Поиск и заказ идущих долго комплектующих</a></li>
<li><a href="#sec-6-3-7">6.3.7. <span class="todo nilSTART">START</span> Трассировка базовой платы</a></li>
<li><a href="#sec-6-3-8">6.3.8. <span class="todo nilSTART">START</span> Трассировка платы расширения расширения</a></li>
<li><a href="#sec-6-3-9">6.3.9. <span class="todo nilTODO">TODO</span> [unrimah ranma] - Обеспечить возможность дергать ногами GPIO при отправке JSON-а</a></li>
<li><a href="#sec-6-3-10">6.3.10. <span class="todo nilTODO">TODO</span> [unrimah ranma] - Обеспечить возможность управлять дисплеем через JSON</a></li>
<li><a href="#sec-6-3-11">6.3.11. <span class="todo nilTODO">TODO</span> [unrimah] RTC needed (battery etc.)</a></li>
<li><a href="#sec-6-3-12">6.3.12. <span class="todo nilWAIT">WAIT</span> [unrimah] Макетирование прототипа</a></li>
</ul>
</li>
<li><a href="#sec-6-4">6.4. Задачи software контроллер</a>
<ul>
<li><a href="#sec-6-4-1">6.4.1. <span class="todo nilTODO">TODO</span> Описать <code>happy-cases</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyubnrimah">pyubnrimah</span></span></a></li>
<li><a href="#sec-6-4-2">6.4.2. <span class="todo nilTODO">TODO</span> Составление исполняемой спецификации, внесение описаний работы и кейсов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-3">6.4.3. <span class="done nilDONE">DONE</span> Выделить состояния контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-4-4">6.4.4. <span class="todo nilTODO">TODO</span> Список событий контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-4-5">6.4.5. <span class="todo nilTODO">TODO</span> Составить конечный автомат&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-6">6.4.6. <span class="todo nilSTART">START</span> Декларативное описание конечных автоматов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-7">6.4.7. <span class="todo nilSTART">START</span> Написание генератора кода модели системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-8">6.4.8. <span class="todo nilSTART">START</span> Ручная верификация работы системы на модели&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-9">6.4.9. <span class="todo nilSTART">START</span> Расширение модели рабочим кодом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-10">6.4.10. <span class="todo nilSTART">START</span> Автоматическая верификация работы системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-11">6.4.11. <span class="todo nilSTART">START</span> Тестирование рабочего кода на прототипе устройства&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
<li><a href="#sec-6-4-12">6.4.12. <span class="todo nilTODO">TODO</span> Создание UI web-интерфейса для настройки контроллера</a></li>
</ul>
</li>
<li><a href="#sec-6-5">6.5. Задачи периферии контроллера</a>
<ul>
<li><a href="#sec-6-5-1">6.5.1. <span class="todo nilTODO">TODO</span> Создание списка периферии и сведение документации по ней&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-6-6">6.6. Задачи сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a>
<ul>
<li><a href="#sec-6-6-1">6.6.1. <span class="todo nilWAIT">WAIT</span> Разработка структуры БД</a></li>
<li><a href="#sec-6-6-2">6.6.2. <span class="todo nilWAIT">WAIT</span> Разработка софтверной части для сервера</a></li>
<li><a href="#sec-6-6-3">6.6.3. <span class="todo nilWAIT">WAIT</span> Разработка интерйефса сервера</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. <span class="todo nilWAIT">WAIT</span> Протоколы обмена данными&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-7-1">7.1. Принцип построения сети и взаимодействрия контроллеров и сервера</a></li>
<li><a href="#sec-7-2">7.2. Принцип автономной работы контроллера</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Контроллер</a>
<ul>
<li><a href="#sec-8-1">8.1. Гибкость и оптимизация</a></li>
<li><a href="#sec-8-2">8.2. Аппаратная часть</a>
<ul>
<li><a href="#sec-8-2-1">8.2.1. <span class="done nilDONE">DONE</span> Выбор микрокомпьютера</a></li>
<li><a href="#sec-8-2-2">8.2.2. <span class="todo nilTODO">TODO</span> Принципиальная схема контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span>&#xa0;<span class="noa">noa</span></span></a></li>
<li><a href="#sec-8-2-3">8.2.3. <span class="todo nilTODO">TODO</span> Вписать в таблицы данные по потреблению переферии, сигнальным уровням и необходимости изоляции&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></a></li>
<li><a href="#sec-8-2-4">8.2.4. <span class="todo nilWAIT">WAIT</span> Схемотехника базовой платы</a></li>
<li><a href="#sec-8-2-5">8.2.5. <span class="todo nilWAIT">WAIT</span> Схемотехника плат расширения</a></li>
<li><a href="#sec-8-2-6">8.2.6. <span class="todo nilWAIT">WAIT</span> Оптимизация цены решения</a></li>
</ul>
</li>
<li><a href="#sec-8-3">8.3. <span class="todo nilTODO">TODO</span> Периферийное оборудование&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-8-3-1">8.3.1. Дисплей монохромный</a></li>
<li><a href="#sec-8-3-2">8.3.2. Дисплей цветной сенсорный</a></li>
<li><a href="#sec-8-3-3">8.3.3. Клавиатура</a></li>
<li><a href="#sec-8-3-4">8.3.4. Термопринтеры</a></li>
<li><a href="#sec-8-3-5">8.3.5. ККМ</a></li>
<li><a href="#sec-8-3-6">8.3.6. Сканеры штриховых кодов</a></li>
<li><a href="#sec-8-3-7">8.3.7. Приёмники купюр</a></li>
<li><a href="#sec-8-3-8">8.3.8. Диспнесеры купюр</a></li>
<li><a href="#sec-8-3-9">8.3.9. Приёмник монет</a></li>
<li><a href="#sec-8-3-10">8.3.10. Хоппер (диспенсер монет)</a></li>
<li><a href="#sec-8-3-11">8.3.11. Ресайклер купюр</a></li>
<li><a href="#sec-8-3-12">8.3.12. Ресайклер монет</a></li>
<li><a href="#sec-8-3-13">8.3.13. Считыватели карт EM-Marine, Mifare</a></li>
<li><a href="#sec-8-3-14">8.3.14. Приёмник карт</a></li>
<li><a href="#sec-8-3-15">8.3.15. Диспенсер карт</a></li>
<li><a href="#sec-8-3-16">8.3.16. Ресайклер карт</a></li>
<li><a href="#sec-8-3-17">8.3.17. Терминал банковских карт</a></li>
<li><a href="#sec-8-3-18">8.3.18. Транспондер DSRC</a></li>
</ul>
</li>
<li><a href="#sec-8-4">8.4. Зависимости периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></a>
<ul>
<li><a href="#sec-8-4-1">8.4.1. Дисплей монохромный</a></li>
<li><a href="#sec-8-4-2">8.4.2. Дисплей цветной</a></li>
<li><a href="#sec-8-4-3">8.4.3. Сенсор дисплея</a></li>
<li><a href="#sec-8-4-4">8.4.4. Клавиатура</a></li>
<li><a href="#sec-8-4-5">8.4.5. Термопринтеры</a></li>
<li><a href="#sec-8-4-6">8.4.6. ККМ</a></li>
<li><a href="#sec-8-4-7">8.4.7. Сканеры штриховых кодов</a></li>
<li><a href="#sec-8-4-8">8.4.8. Приёмники купюр</a></li>
<li><a href="#sec-8-4-9">8.4.9. Диспнесеры купюр</a></li>
<li><a href="#sec-8-4-10">8.4.10. Приёмник монет</a></li>
<li><a href="#sec-8-4-11">8.4.11. Хоппер (диспенсер монет)</a></li>
<li><a href="#sec-8-4-12">8.4.12. Ресайклер купюр</a></li>
<li><a href="#sec-8-4-13">8.4.13. Ресайклер монет</a></li>
<li><a href="#sec-8-4-14">8.4.14. Считыватели карт EM-Marine, Mifare</a></li>
<li><a href="#sec-8-4-15">8.4.15. Приёмник карт</a></li>
<li><a href="#sec-8-4-16">8.4.16. Диспенсер карт</a></li>
<li><a href="#sec-8-4-17">8.4.17. Ресайклер карт</a></li>
<li><a href="#sec-8-4-18">8.4.18. Терминал банковских карт</a></li>
<li><a href="#sec-8-4-19">8.4.19. Транспондер DSRC</a></li>
</ul>
</li>
<li><a href="#sec-8-5">8.5. Подключение периферии к контроллеру</a></li>
<li><a href="#sec-8-6">8.6. Список сообщений на дисплей</a>
<ul>
<li><a href="#sec-8-6-1">8.6.1. Периферийные устройства контроллера и протоколы связи</a></li>
<li><a href="#sec-8-6-2">8.6.2. Выводы на аудио оборудование</a></li>
<li><a href="#sec-8-6-3">8.6.3. Выводы на сухой контакт реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></a></li>
<li><a href="#sec-8-6-4">8.6.4. Вводы сигналов с датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrumah">unrumah</span></span></a></li>
<li><a href="#sec-8-6-5">8.6.5. Вводы с кнопок</a></li>
<li><a href="#sec-8-6-6">8.6.6. Кроссировка RJ45 для подключения внешних устройств</a></li>
<li><a href="#sec-8-6-7">8.6.7. Оценка максимального кол-ва подключений устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrumah">unrumah</span></span></a></li>
<li><a href="#sec-8-6-8">8.6.8. Стандартные комплекты периферийных устройств</a></li>
<li><a href="#sec-8-6-9">8.6.9. Максимальная комплектация, оплата совмещённая с выездной стойкой в вариантах на чеках и картах.</a></li>
</ul>
</li>
<li><a href="#sec-8-7">8.7. Программная платформа</a>
<ul>
<li><a href="#sec-8-7-1">8.7.1. <span class="todo nilTODO">TODO</span> Архитектура программного обеспечения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="ranma">ranma</span></span></a></li>
<li><a href="#sec-8-7-2">8.7.2. <span class="todo nilTODO">TODO</span> Работа с библиотеками</a></li>
<li><a href="#sec-8-7-3">8.7.3. <span class="todo nilWAIT">WAIT</span> Драйвера периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></a></li>
<li><a href="#sec-8-7-4">8.7.4. <span class="todo nilTODO">TODO</span> Операционная система&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></a></li>
<li><a href="#sec-8-7-5">8.7.5. <span class="todo nilTODO">TODO</span> Протоколы периферии</a></li>
<li><a href="#sec-8-7-6">8.7.6. <span class="todo nilTODO">TODO</span> Резервирование системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></a></li>
<li><a href="#sec-8-7-7">8.7.7. <span class="todo nilTODO">TODO</span> Web-интерфейс для настройки контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a></li>
</ul>
</li>
<li><a href="#sec-8-8">8.8. <span class="done nilDONE">DONE</span> Первичный запуск контроллера</a>
<ul>
<li><a href="#sec-8-8-1">8.8.1. <span class="done nilDONE">DONE</span> Подключение к BBB по ssh</a></li>
<li><a href="#sec-8-8-2">8.8.2. <span class="done nilDONE">DONE</span> Компиляция и запуск HelloWorld на BBB</a></li>
<li><a href="#sec-8-8-3">8.8.3. <span class="done nilDONE">DONE</span> Установка и базовый запуск nginx</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-9">9. <span class="todo nilTODO">TODO</span> Серверная часть&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></a>
<ul>
<li><a href="#sec-9-1">9.1. <span class="todo nilTODO">TODO</span> Общие положения</a></li>
<li><a href="#sec-9-2">9.2. <span class="todo nilTODO">TODO</span> Основной функционал сервера:</a></li>
<li><a href="#sec-9-3">9.3. <span class="todo nilWAIT">WAIT</span> База данных</a></li>
<li><a href="#sec-9-4">9.4. <span class="todo nilTODO">TODO</span> Web-интерфейс сервера</a></li>
<li><a href="#sec-9-5">9.5. <span class="todo nilWAIT">WAIT</span> Агреггирующий сервер</a></li>
</ul>
</li>
<li><a href="#sec-10">10. <span class="todo nilTODO">TODO</span> Дополнительные аппаратно-програмные модули</a>
<ul>
<li>
<ul>
<li><a href="#sec-10-0-1">10.0.1. <span class="todo nilTODO">TODO</span> Модуль <code>платной парковки</code></a></li>
<li><a href="#sec-10-0-2">10.0.2. <span class="todo nilTODO">TODO</span> Модуль <code>СКУД</code></a></li>
<li><a href="#sec-10-0-3">10.0.3. <span class="todo nilWAIT">WAIT</span> Модуль для <code>работы с абонементами</code></a></li>
<li><a href="#sec-10-0-4">10.0.4. <span class="todo nilWAIT">WAIT</span> Модуль для <code>работы по дебетовым картам</code></a></li>
<li><a href="#sec-10-0-5">10.0.5. <span class="todo nilWAIT">WAIT</span> Модуль <code>акцептирования</code></a></li>
<li><a href="#sec-10-0-6">10.0.6. <span class="todo nilWAIT">WAIT</span> Модуль <code>арендаторов</code></a></li>
<li><a href="#sec-10-0-7">10.0.7. <span class="todo nilTODO">TODO</span> Модуль <code>кассира</code></a></li>
<li><a href="#sec-10-0-8">10.0.8. <span class="todo nilWAIT">WAIT</span> Модуль <code>бухгалтера</code></a></li>
<li><a href="#sec-10-0-9">10.0.9. <span class="todo nilWAIT">WAIT</span> Модуль <code>фотофиксации</code></a></li>
<li><a href="#sec-10-0-10">10.0.10. <span class="todo nilWAIT">WAIT</span> Модуль <code>распознания номеров</code></a></li>
<li><a href="#sec-10-0-11">10.0.11. <span class="todo nilTODO">TODO</span> Модуль <code>дуплексной IP связи</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-11">11. <span class="todo nilWAIT">WAIT</span> Интеграция со сторонними решениями</a>
<ul>
<li><a href="#sec-11-1">11.1. <span class="todo nilWAIT">WAIT</span> Выгрузка данных в 1С</a></li>
<li><a href="#sec-11-2">11.2. <span class="todo nilWAIT">WAIT</span> Интеграция с 1С</a></li>
<li><a href="#sec-11-3">11.3. <span class="todo nilWAIT">WAIT</span> Интеграция со сторонним биллингом</a></li>
<li><a href="#sec-11-4">11.4. <span class="todo nilWAIT">WAIT</span> Интеграция с NOW!</a></li>
<li><a href="#sec-11-5">11.5. <span class="todo nilWAIT">WAIT</span> Интеграция с SOLVO</a></li>
<li><a href="#sec-11-6">11.6. <span class="todo nilWAIT">WAIT</span> API для создания библиотек</a></li>
</ul>
</li>
<li><a href="#sec-12">12. <span class="todo nilWAIT">WAIT</span> Тестирование</a>
<ul>
<li><a href="#sec-12-1">12.1. <span class="todo nilTODO">TODO</span> Описать полный цикл работы системы с обработкой ошибок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-13">13. <span class="todo nilTODO">TODO</span> Глоссарий</a>
<ul>
<li><a href="#sec-13-1">13.1. Сигнал</a></li>
<li><a href="#sec-13-2">13.2. Сообщение</a></li>
<li><a href="#sec-13-3">13.3. Событие</a></li>
<li><a href="#sec-13-4">13.4. Состояние</a></li>
<li><a href="#sec-13-5">13.5. Процедура</a></li>
<li><a href="#sec-13-6">13.6. Датчик</a>
<ul>
<li><a href="#sec-13-6-1">13.6.1. Датчик присутствия автомобиля</a></li>
<li><a href="#sec-13-6-2">13.6.2. Датчик (фотоэлемент) безопасности</a></li>
<li><a href="#sec-13-6-3">13.6.3. Датчик контроля состояния стрелы шлакбаума</a></li>
</ul>
</li>
<li><a href="#sec-13-7">13.7. <span class="todo nilTODO">TODO</span> Стойка&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-8">13.8. Периферийные устройства</a></li>
<li><a href="#sec-13-9">13.9. Касса</a></li>
<li><a href="#sec-13-10">13.10. Проездной документ</a>
<ul>
<li><a href="#sec-13-10-1">13.10.1. Категории:</a></li>
<li><a href="#sec-13-10-2">13.10.2. Статусы:</a></li>
</ul>
</li>
<li><a href="#sec-13-11">13.11. Контроллер</a></li>
<li><a href="#sec-13-12">13.12. Системы навигациии</a></li>
<li><a href="#sec-13-13">13.13. <span class="todo nilTODO">TODO</span> Сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-14">13.14. Время</a></li>
<li><a href="#sec-13-15">13.15. Группы</a></li>
<li><a href="#sec-13-16">13.16. Парковка</a></li>
<li><a href="#sec-13-17">13.17. <span class="todo nilTODO">TODO</span> Посетитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-18">13.18. <span class="todo nilTODO">TODO</span> Деление парковкочных мест&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-19">13.19. <span class="todo nilTODO">TODO</span> Тариф&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-20">13.20. <span class="todo nilTODO">TODO</span> Роли&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-21">13.21. <span class="todo nilTODO">TODO</span> Внешний носитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-22">13.22. <span class="todo nilTODO">TODO</span> УДПА&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-23">13.23. <span class="todo nilTODO">TODO</span> Процесс&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-24">13.24. <span class="todo nilTODO">TODO</span> Рампа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-25">13.25. <span class="todo nilTODO">TODO</span> Шлюз&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-13-26">13.26. <span class="todo nilTODO">TODO</span> Реверсивный проезд&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-14">14. Данные по первому поколению системы</a>
<ul>
<li><a href="#sec-14-1">14.1. <span class="done nilDONE">DONE</span> Старая версия сервера</a></li>
</ul>
</li>
<li><a href="#sec-15">15. Сущности</a>
<ul>
<li><a href="#sec-15-1">15.1. Функции для кодогенерации сущностей</a></li>
</ul>
</li>
<li><a href="#sec-16">16. Тесты</a></li>
<li><a href="#sec-17">17. Сборка</a>
<ul>
<li><a href="#sec-17-1">17.1. Каркас проекта</a></li>
<li><a href="#sec-17-2">17.2. Пакеты</a></li>
<li><a href="#sec-17-3">17.3. Подготовка к старту</a></li>
<li><a href="#sec-17-4">17.4. Точка входа</a></li>
<li><a href="#sec-17-5">17.5. Copyright</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
[TODO:all] - Супервизор и логика его работы. Супервизор перезапускает неотвечающие
сервисы. Лучше запускать с нижнего уровня, чтобы бизнес-логика уже имела возможность
опрашивать оборудование.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> Состояние запуска подробно.&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ranma">ranma</span>&#xa0;<span class="rigidus">rigidus</span></span></h2>
<div class="outline-text-2" id="text-1">
<p>
[COMMENT:rigidus] - Отформатировал и добавил комментарии
</p>

<p>
Пока лежит здесь, чтобы у всех на виду. После утверждения всеми, переедет на свое
место.
</p>

<ul class="org-ul">
<li>Включается питание, загружается ОС.
</li>
<li>Запускается скрипт-супервизор, который контролирует наличие и независание
запущенных процессов: нижний уровень, бизнес-логика, веб-морда, nginx и других,
если будут.
[COMMENT:rigidus] - Что там с systemd? Кто-то уже имеет опыт как его гтовить?
</li>
<li>Каждое наше приложение - это клиент какого-либо сервера или сам сервер и сразу
после старта оно должно установить клиентские взаимосвязи: на сегодня бизнес-логика
должна установить соединение с нижним уровнем и веб-морда тоже должна установить
соединение с нижним уровнем. Только после установления локальных взаимосвязей можно
продолжать работу.
[COMMENT:rigidus] - Неверно. Мы работаем на уровне сообщений, поэтому не требуется
устанавливать связь, держать канал и прочее. Достаточно просто отправить сообщение
на endpoint.
</li>
<li>Нижний уровень сразу после старта, считает настройки устройств из базы и создаст в
памяти систему объектов, которая будет поддерживать уровень представления реальных
устройств для уровня бизнес-логики.
</li>
<li>Нижний уровень проводит инициализацию и пинг устройств. Выставляет статусы и
отправляет события о состоянии устройств бизнес-логике, когда та подключится, как
клиент.
[COMMENT:rigidus] - Неверно в части "подключается как клиент". Бизнес-логика просто
посылает асинхронные сообщения.
</li>
<li>Если бизнес-логика подключилась до завершения инициализации устройств, то на любой
запрос она будет получать сообщение вида: { status:"Power-on" }.
</li>
<li>После выдачи сообщения о состоянии устройств, нижний уровень перейдет в {
status:"Work-ready" }.  Других статусов для нижнего уровня пока не видно.
</li>
<li>В случае, если были ошибки, то для каждого неправильно работающего устройства
нижний уровень выдаст отдельное сообщение о статусе ошибки. То же самое произойдет
и в процессе работы в любой момент, если устройство перестало отвечать на пинги,
если устройство не отвечает (или неправильно отвечает) на команды, если устройство
само выдало событие об ошибках.
</li>
<li>Бизнес-логика анализирует наличие и состояния устройств, по результатам анализа
может проводить дополнительное тестирование, и выбирает алгоритм работы.
</li>
<li>Переход в состояние, соответствующее выбранному алгоритму: Stand-by, Ready, Lock,
etc.
</li>
<li>Рестарт приложения в процессе работы должен выполняться аналогично старту.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> <span class="done DONE">DONE</span> Обмен по TCP-IP&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h2>
<div class="outline-text-2" id="text-2">
<p>
Взаимодействие между бизнес-логикой и нижним уровнем происходит так (далее на
примере):
</p>
<ul class="org-ul">
<li><p>
Бизнес-логике нужно открыть шлагбаум. Она делает GET или POST-запрос на
localhost:8080/Shlagbaum указывая в заголовке "Host: HardwareLayer". В POST-е
может лежать json с дополнительными параметрами. Например:
</p>
<pre class="example">
{
  id : 12345
  isdone : "confirm_please"
}
</pre>
</li>
<li>Запрос принимает nginx и пробрасывает на endpoint где его обработает веб-сервер
Ранмы, разберет JSON, сориентируется что за шлагбаум стоит на стойке и выработает
последовательность дерганий за GPIO, чтобы открыть шлагбаум так, чтобы тот
например прекратил открываться по достижении концевика. А если шлагбаум концевика
не имеет, то просто держит высокий уровень на нужной ногу GPIO нужное кол-во
секунд. Для этого (уточнить модель шлагбаума) он невозбранно пользуется
подключением к PostgreSql.
</li>
<li><p>
После того как действие завершено, обработчик на нижем уровне посылает сообщение
бизнес логике, делая POST-запрос на localhost:8080/confirm, указывая в заголовке
"Host: BusinesLogicLayer"
</p>
<pre class="example">
{
  id : 12345
  status : "no_problem"
}
</pre>
</li>
<li>Запрос принимает nginx и пробрасывает на эндпойнт, где его обработает лисповый
сервер Ригидуса, закроет себе таску и поставит галочку, что на этот раз шлагбаум
не заело. После чего он может отправить сообщение, что машина номер такой-то
проехала на аггрегирующий сервер - точно таким-же образом.
</li>
</ul>


<link rel="stylesheet" type="text/css" href="/css/css.css" />

<p>
Техническое задание и спецификация на разработку аппаратно-программного комплекса АСПП
(Автоматизированная Система Платной Парковки)
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Теги&#xa0;&#xa0;&#xa0;<span class="tag"><span class="important">important</span></span></h2>
<div class="outline-text-2" id="text-3">
<p>
Я вкурил теги и понял, что <code>по крайней мере в заголовках</code> ими лучше пользоваться чем
поиском по [TODO:pyub] и подобным вещам. Сейчас я постараюсь донести это понимание до
вас:
</p>

<p>
Итак, каждом заголовку можно поставить теги. Это делается с помощью комбинации <code>C-c
  C-q</code>, которая вызывает функцию <code>(org-set-tags-command)</code>
</p>

<p>
Теги пишутся в правой колонке, которой управляет переменная org-tags-column, у
меня, по умолчанию, она равна 77.
</p>

<p>
Если ввести <code>C-u C-c C-q</code> все теги в документе будут выровнены (по возможности) по
этой колонке.
</p>

<p>
Теги автоматически перестраиваются после изменения порядка столбцов, двигания
разделов и присвоения меток TODO, START и других. Кроме того, теги не нарушают поиск
ссылок на разделы, в отличии от наших вставок [TODO:unrimah] в раздел, после чего
все ссылки на этот раздел "ломаются".
</p>

<p>
Можно ставить несколько тегов на один раздел например так: :pyub:unrimah:
</p>

<p>
Чтобы быстро найти все разделы с каким либо тегом нужно нажать <code>C-/ m</code> или, еще
проще - <code>C-u \</code>, что вызывает функцию <code>(org-match-sparse-tree)</code>, которая прямо в
текущем файле подсветит вам разделы, которые имеют этот тег.
</p>

<p>
Однако иногда удобнее получить список всех этих разделов и дальше ходить по нему. Для
этого существует мега-полезная комбинация <code>C-c a &lt; m</code>, которая из текущего буфера (или
даже из его выделенной области) сформирует список разделов, имеющих теги, которые вы
укажете и выведет в отдельный буфер, который покажет вам. Этот буфер можно будет
обновлять прямо в нем, нажимая <code>C-u r</code> о чем собственно и будет написано у него
наверху. И внутри этого буфера можно будет бродить по всем интересующим разделам,
который будут открываться в вашем исходном буфере.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Цель</h2>
<div class="outline-text-2" id="text-4">
<p>
Создаем решение для оснащения платных парковок.
</p>

<p>
Функции:
</p>
<ul class="org-ul">
<li>контроль доступа посетителей к парковочному пространству
</li>
<li>монетизация от этой услуги
</li>
</ul>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Компоненты решения</h3>
<div class="outline-text-3" id="text-4-1">
</div><div id="outline-container-sec-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> Контроллер</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Это комплексное программно-аппартаное решение, состоящее из нескольких физически
разделяемых печатных плат и ПО к ним.
</p>

<p>
<code>Функции контроллера</code>:
</p>
<ul class="org-ul">
<li>Подключение периферийного оборудования, на лету без перезагрузки.
</li>
<li><p>
Управление всеми вводами/выводами платы расширения, такими как:
</p>
<ul class="org-ul">
<li>датчики,
</li>
<li>торговое оборудованием
</li>
<li>релейные развязки
</li>
<li>и.т.п.
</li>
</ul>
<p>
Вводы / выводы платы и перечень оборудования описаны в разделах:
</p>
<ul class="org-ul">
<li><a href="#sec-8-6-1">Периферийные устройства контроллера и протоколы связи</a>
</li>
<li><a href="#sec-8-6-2">Выводы на аудио оборудование</a>
</li>
<li><a href="#sec-8-6-3">Выводы на сухой контакт реле</a>
</li>
</ul>
</li>
<li>Настройка работы всего периферийного оборудования (перед использованием) из
браузера по IP-адресу Описание в разделах:
<ul class="org-ul">
<li><a href="#sec-8-7-7">Web-интерфейс для настройки контроллера</a>
</li>
</ul>
</li>
<li>Гибкой переконфигурации поведения на ходу, при измении внешних условий и отказах
</li>
<li>Обеспечение возможности пообщаться с клиентом голосом. Для этого каждый
контроллер должен распознаваться в локальной сети как SIP-устройство
</li>
<li>Работа с IP камерами
<ul class="org-ul">
<li>Фотофиксация по событиям:
<ul class="org-ul">
<li>нажатие кнопки
</li>
<li>подъезд машины
</li>
</ul>
</li>
<li>Фотосьемку по временном интервале.
</li>
</ul>
</li>
<li>Осуществлять <i>фотофиксацию въезда автомобилей</i> по установленным событиям
</li>
<li>Распознавание номеров на сделанных фотографиях.
</li>
<li>Осуществление <a href="#sec-5-7-3">звукового сопровождения</a> действий пользователя
<ul class="org-ul">
<li>Проигрывание аудиозаписей по определенным событиям, (например, с SD-карты)
</li>
</ul>
</li>
<li><a href="#sec-5-3">Логирование сообщений</a> на сервер с SD-карту
</li>
<li>Аутентификация управляющего персонала (логин/пароль)
</li>
<li>Шифрование трафика при общении с сервером
</li>
<li><a href="#sec-7-2">Автономная работа</a> контроллера при отсутствии связи с сервером
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-1-2" class="outline-4">
<h4 id="sec-4-1-2"><span class="section-number-4">4.1.2</span> Печатные платы</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
<code>Управляющая плата</code> - печатная плата, представляющая из себя одноплатный
микрокомпьютер на базе микропроцессора архитектуры ARM Cortex-А7/A8/A9.
</p>

<p>
Допускается:
</p>
<ul class="org-ul">
<li>использование готовых решений одноплатных микрокомпьютеров
</li>
<li>варианты микропроцессоров с аналогичными характеристиками
</li>
<li>рассмотрение вариантов микропроцессоров отечественной разработки
</li>
</ul>

<p>
Для прототипирования выбран микрокомпьютер: <code>EMBEST BeagleBone Black Rev C</code> с
микропоцессором <code>ARM TI AM3358</code> (<a href="http://www.ti.com/product/AM3359">http://www.ti.com/product/AM3359</a>). В дальнейшем
предполагается оптимизация и адаптация данного решения под требования к контроллеру.
</p>

<p>
<code>Базовая плата</code> - печатная плата, реализующая базовый необходимый функционал связи
управляющей платы с периферийными устройствами стойки и другими элементами
автоматической парковки. На неё устанавливается управляющая плата и, при
необходимости, плата расширения.
</p>

<p>
<code>Плата расширения</code> - печатная плата, реализующая дополнительный специфический
функционал связи с периферийными устройствами и другим оборудованием автоматической
парковки, а также интеграции с другими системами. Возможна разработка нескольких
плат расширений с различным функционалом.
</p>
</div>
</div>

<div id="outline-container-sec-4-1-3" class="outline-4">
<h4 id="sec-4-1-3"><span class="section-number-4">4.1.3</span> Программное обеспечение</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
<code>Программное обеспечение контроллера</code> - операционная система на базе ядра Linux и
развёрнутое на ней сервисное программное обеспечение, реализующие функции
контроллера, c клиентским web-интерфейсом для настройки работы.
</p>

<p>
<code>Клиентский интерфейс контроллера</code> - web-интерфейс для конфигурирования и настрйоки
работы контроллера администратором, инженером пуско-наладки или разработчиком.
</p>

<p>
<code>Центральный сервер</code> - компьютер, на котором развёрнута программа управления
парковкой и хранится база данных со всеми настройками системы и пользователей, а
также история событий.
</p>

<p>
<code>Серверное ПО</code> - это программа управления парковкой, через которую осуществляется
настройка всех основных модулей системы и управление парковочной
системой. Серверное ПО имеет ядро (сервер приложений?, бэкенд?), базу данных под
управлением выбранной СУБД (PostgreSQL), интерфейс (фронтенд) и систему
лицензирования и защиты программных средств.
</p>

<p>
<code>Клиентский интерфейс сервера</code> - веб-интерфейс модуля сервера, к которому получает
доступ конечный пользователь системы.
</p>

<p>
<code>Клиентская программа</code> - отдельно устанавливаемое на ПК (рабочую станцию)
программное обеспечение, настраиваемое на взаимодействие с сервером, которое
использует конечный пользователь системы. Нужна для проброса ККМ.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Описание функционирования</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Общий принцип работы</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Клиент на автомобиле въезжает в зону действия <a href="#sec-13-6-1">датчика присутствия автомобиля</a>,
нажимает на кнопку и получает въездной документ - <code>билет со штрихкодом</code>. В будущем
планируется адаптировать систему также под использование другого типа въездного
документа - автоматически выдаваемые и изымаемые карты стандарта <code>Mifare+</code>.
</p>

<p>
В штрикоде зашифрована следующая информация:
</p>
<ul class="org-ul">
<li>уникальный номер билета в системе
</li>
<li>номер стойки через которую был совершен въезд
</li>
<li>номер сектора к которому относится стойка
</li>
<li>дата и время вьезда
</li>
<li>массогабаритные характеристики ТС посетителя (например, в таком формате: 0 -
легковой, 1 - средний, 2 - грузовик)
</li>
</ul>

<p>
<code>Штрихкод</code> должен быть зашифрован, чтобы избежать попыток подстановки данных со
стороны клиента. Также на каждой парковке должен использоваться уникальный ключ
шифрования, выставляемый в системе, во избежании использования одних и тех же
билетов на разных парковках.
</p>

<p>
В <code>билете</code> также открытым текстом напечатано:
</p>
<ul class="org-ul">
<li>уникальный номер билета в системе
</li>
<li>номер стойки через которую был совершен въезд
</li>
<li>номер сектора к которому относится стойка
</li>
<li>номер (название) тарифной зоны, если есть
</li>
<li>дата и время вьезда
</li>
<li>определённые массогабаритные характеристики ТС
</li>
<li>текущее время вьезда
</li>
<li>идентификатор места вьезда
</li>
<li>номер сектора парковки / тарифной зоны
</li>
<li>уникальный код билета (буквенно-цифровой)
</li>
</ul>

<p>
После того как пользователь забирает билет, открывается шлагбаум. Взятие билета
пользователем мы ослеживаем через протокол общения с принтером, который описан в
документации. Документация будет лежать тут: <a href="file://asp/devices/barcode_thermal_printer">devices/barcode<sub>thermal</sub><sub>printer</sub></a>
</p>

<p>
Во время проезда машины под стрелой шлагбаума его закрытие невозможно - наличие
автомобиля фиксируется фотоэлементом на линии стрелы и датчиком за ней. Это сухой
контакт, описан в разделе <i>выводы на сенсоры и кнопки</i>. По факту проезда шлагбаум
закрывается. После въезда начинается допустимое бесплатное время нахождения на
парковке.
</p>

<p>
Также имеется возможность попасть на парковку по бесконтактным картам доступа
Em-Marine, которые заранее программируются и выдаются клиентам (система СКУД для
постоянных клиентов и владельцев). Со считывателем СКД (Em-Marine Iron Logic Matrix
V / Matrix II EH) мы общаемся по протоколу "Wiegand 26".
</p>

<p>
/devices/wiegand<sub>26</sub> - описание протокола
/devices/em-marine<sub>reader</sub> - описание устройств на Em-Marine
/devices/mifare<sub>reader</sub> - описание устрйоств на Mifare+
</p>

<p>
[TODO:unrimah] Добавить в папки описания стандартов EM и MF
</p>

<p>
Далее посетитель парковки должен произвести оплату парковочного времени. Это возможно
сделать тремя осовными способами:
</p>
<ul class="org-ul">
<li>оплатить на автоматической кассе
</li>
<li>оплатить на ручной кассе (ПК на котором оператор в программе принимает оплату)
</li>
<li>акцептировать билет у одного из арендаторов (сбросить время или перевести его на
счёт арендатора)
</li>
</ul>
<p>
В рамках пилотного проекта мы делаем только оплату на ручной кассе, где кассир
сообщает системе о проведенной оплате через броузер.
</p>

<p>
В любом случае информация с билета считывается с помощью сканера штрих кодов (для
карт Mifare будет использоваться считыватель-программатор), либо на ПК вводом
буквенно-цифрового кода с билета. При считывании посетителю сообщается сумма оплаты,
которую он должен внести. По факту приёма оплаты печатается фискальный чек, он же
выездной билет, а въездной билет аннулируется. Кроме оплаты билет может быть
<i>акцептирован арендатором</i> с помощью специальной карты или <i>акцептирован</i> на ПК.
</p>

<p>
Стоимость парковки может варьироваться в зависимости от времени пребывания на ней,
тарифной сетки (разные тарифы в разное время суток и дни недели) и <i>тарифных зон</i> (на
одной парковке может быть несколько секторов, в каждом из которых парковка
оплачивается по разному, между ними стоят проездные стойки).
</p>

<p>
После оплаты устанавливается допустимое время нахождения на парковке до выезда. Если
посетитель находится больше времени, чем было установлено администратором парковки,
ему необходимо снова оплачивать время. Беслпатное время настраивается со всеми
тарифами в <i>web-интерфейсе контроллера</i> или сервера.
</p>

<p>
На выезде посетитель парковки при попадании автомобиля в зону действия датчика
присутствия подносит свой билет к сканеру штрих кодов и, если допустимое время
нахождения на парковке не истекло, ему позволяется покинуть парковку (в случае
Mifare карт карта вставляется в приемник и он её заглатывает). Также имеется
<i>возможность покинуть парковку по бесконтактным Em-Marine картам</i>
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> <span class="todo WAIT">WAIT</span> Парковочные места, тарифные зоны и сектора</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> <span class="todo WAIT">WAIT</span> Распределение паркомест</h4>
</div>
<div id="outline-container-sec-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> <span class="todo WAIT">WAIT</span> Тарифная зона</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
Необходимо реализовать гибкую систему тарифов, при этом постаравшись
максимально сохранить автномность системы в случае падения связи с
сервером.
</p>

<p>
Основные единые настройки бесплатного времени:
</p>
<ul class="org-ul">
<li>бесплатное время после въезда (мин)
</li>
<li>бесплатное время на выезд после оплаты (мин)
</li>
</ul>

<p>
Эти характеристики должны быть индивидуальны для разных секторов парковки. Т.е.,
например, в секторе открытого паркинга одни тарифы, а в секторе закрытого -
другие. Между секторами стоит проездная стойка со сканером штрих кодов (для Mifare
парковки это сделать проще в автономном режиме). При поднесении она переносит на
сервере и всех соседних стойках билет в другой сектор. При этом если машина отстояла
t1 времени в одном секторе, а потом поехала в другой, то данные по оплате
суммируется, а бесплатное время во втором секторе не считается.
</p>

<p>
Основые вещи:
</p>
<ul class="org-ul">
<li>Со скольки до скольки работает парковка (осуществляется впуск и выпуск)
Допустимо по картам СКУД пускать например круглосуточно, а по чекам - только днем
</li>
<li>Бесплатное время - время, которое машина может стоять на парковке до требования
оплаты. В течении его она может выехать бесплатно.
</li>
<li>Время на выезд - время за которое машина может покинуть парковку после оплаты
водителем в кассе. Если не успел - время на выезд не учитывается.
</li>
<li>Штраф - сумма, которая взимается с человека, если он потерял вьездной документ.
</li>
<li>Стоимость часов исходя из того, что имеются следующие основыне тарифные характеристики:
<ul class="org-ul">
<li>стоимость 1го..2го..23го..24го.. часа после истечения бесплатного времени
</li>
</ul>
</li>
<li>коэффициент стоймости в зависимости от времени суток (с 20:00 до 22:00 k=2, с 9:00 до 18:00 k=0,5)
</li>
<li>коэффицикнт стоймости в зависимости от дня недели (пн, вт, ср, чт, пт k2=1, сб,вс k2=2)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> <span class="todo WAIT">WAIT</span> Сектор парковки</h4>
<div class="outline-text-4" id="text-5-2-3">
<p>
Секторальность - например есть крытая и открытая система парковки, между ними
стойка. Если пользователь на ночь хочет на закрытую парковку - там другой тариф,
все это надо считать, суммируя. В пилотном проекте не делаем, но учитывать нужно
при программировании системы тарифов.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Логирование сообщений</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Контроллеры взаимодействуют между собой и сервером через отправку и получение
<i>сообщений</i>.
</p>

<p>
Все сообщения должны писаться в лог-файл. Основное место хранения лога работы
системы - сервер. Каждый контроллер ведёт свою отдельную историю, храня в своей
памяти сообщения за время t (или определённое кол-во сообщений), дублируя эти данные
на агрегирующий сервер, где они собираются в единый лог. В случае отсутствия связи
контроллер перестаёт удалять сервисные сообщения из своего лога, собирая "хвост"
вплоть до появления связи. Если место для сообщений заканчивается, а связь не
появилась - возможно удаление некритичных сообщений и запись на их место критичных.
</p>

<p>
Необходимо обеспечить постоянную запись истории работы системы:
</p>
<ul class="org-ul">
<li>проходящих штатно событий (например, события выезда, события выезд, произошедшей оплаты);
</li>
<li>кодов известных ошибок в работе контроллера и основного ПО;
</li>
<li>кодов известных ошибок в работе переферийного оборудования (обработка кодов ошибок из протоколов взаимодействия самих устройств);
</li>
<li>кодов известных ошибок возникающих при нарушении связи между контроллерами и / или сервером;
</li>
<li>сообщений о неизвестных ошибках.
</li>
</ul>

<p>
Контроллер держит в своей постоянной памяти на SD-карте единовременно лог событий не
превышающий установленное в <i>настройках логирования событий</i> количество записей. В нём
же управляется объем информации хранимой на SD-карте.
</p>

<p>
[TODO:pyub] Необходимо продумать, что мы делаем при отказе SD.
</p>

<p>
При этом он постоянно отправляет сообщения об ошибках на агрегирующий сервер, где
они систематизируются в доступном для оператора или администратора виде и хранятся
долгосрочно. Если связь нарушена, контроллер сохраняет сообщения сверх
установленного количеств записей вплоть до заполнения памяти.
</p>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> <span class="todo TODO">TODO</span> Состояния стойки при проезде&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-5-4">
<p>
defenition: <a href="#sec-13-7">Стойка</a>
</p>

<p>
Независимо от используемого комплекта периферийного оборудования контроллера при
въезде он может находится в следующих состояниях:
</p>

<table id="checkpoint_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Состояния конечного автомата стойки</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">selftest-to-lock</td>
<td class="left">selftest</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">selftest-to-standby</td>
<td class="left">selftest</td>
<td class="left">standby</td>
</tr>

<tr>
<td class="left">standby-to-lock</td>
<td class="left">standby</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">standby-to-finding</td>
<td class="left">standby</td>
<td class="left">finding</td>
</tr>

<tr>
<td class="left">finding-to-lock</td>
<td class="left">finding</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">finding-to-dialog</td>
<td class="left">finding</td>
<td class="left">dialog</td>
</tr>

<tr>
<td class="left">dialog-to-lock</td>
<td class="left">dialog</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">dialog-to-init</td>
<td class="left">dialog</td>
<td class="left">init</td>
</tr>

<tr>
<td class="left">init-to-lock</td>
<td class="left">init</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">init-to-goon</td>
<td class="left">init</td>
<td class="left">goon</td>
</tr>

<tr>
<td class="left">goon-to-lock</td>
<td class="left">goon</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">goon-to-fin</td>
<td class="left">goon</td>
<td class="left">fin</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение стойки как конечный автомат:
</p>


<div class="figure">
<p><img src="img/in-state.png" alt="in-state.png" />
</p>
</div>
</div>

<div id="outline-container-sec-5-4-1" class="outline-4">
<h4 id="sec-5-4-1"><span class="section-number-4">5.4.1</span> <span class="todo TODO">TODO</span> Состояние запуска (<code>poweron</code>)</h4>
<div class="outline-text-4" id="text-5-4-1">
<p>
<code>poweron</code> - состояние старта системы.
</p>

<p>
Запускаем:
nginx + нижний уровень + бизнес-логика + UI
</p>

<p>
Асинхронный запуск под контролем раннера [todo:unrimah] Опиши как всё это будет работать.
</p>

<p>
В данном состоянии проводится первичная проверка настроек бизнес-логики (то что мы
описываем на уровне <code>SettingsLayer</code>) и далее ожидается событие <code>devices-ready</code> или
<code>devices-error</code>, создаваемые по сумме итога инициализации устройств на нижнем уровне.
</p>

<p>
При событии <code>devices-ready</code> с нижнего уровня запрашивается список существующих
устройств и сравнивается со списком из <code>SettingsLayer</code> для проверки соответсвия
реально существующих (инициализированных) устройств списку настроенных в системе
устройств. В случае несоответствия списков переходим в состояние <code>hardlock</code>.
</p>

<p>
Находясь в состоянии <code>poweron</code> от ниженго уровня системы ются отчёты о
состоянии конкретных устройств. Система на уровне бизнес-логики определяет
дальнешиее алгоритмы работы с ними, согласуя в том числе работу комплектов
зависимых друг от друга устройств.
</p>
</div>
</div>

<div id="outline-container-sec-5-4-2" class="outline-4">
<h4 id="sec-5-4-2"><span class="section-number-4">5.4.2</span> <span class="todo TODO">TODO</span> Состояние тестирования (<code>selftest</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="ranma">ranma</span></span></h4>
<div class="outline-text-4" id="text-5-4-2">
<p>
В данном состоянии осуществляется тестирование всего периферийного оборудования по
кругу. Вход в это состояние возможен из любого другого состояния при получении
сообщения о сбое от нижнего уровня или команды разблокировки из UI (с кнопки
разблокировки на стойке или через web-интерфейс контроллера или через web-интерфейс
сервера).
</p>

<p>
Бизнес-логике по устройствам интересно следующее:
</p>
<ul class="org-ul">
<li>Существует ли физически устройство
</li>
<li>Существует ли в текущей конфигурации (чтобы узнать это запрашивать нижний уровень необязательно - PostgreSQL)
</li>
<li>Включено или выключено в UI (тоже)
</li>
<li>Работает ли оно нормально или с ошибками?
</li>
</ul>

<p>
[TODO:ranma] - Выявить ошибки, которые нижний уровень может самостоятельно решить
(например: отказ сканера - перезагрузка помогает)
[COMMENT:ranma] До пилотника я не могу взять на себя такие решения. Может в процессе что-то вылезет, буду иметь в виду.
</p>

<p>
[TODO:pyub] [TODO:unrimah] - Расставить устройства по приориету, в каком порядке разрабатывать
json-ы, чтобы Ранма не заебался сразу со всем.
[COMMENT:ranma] Не только json, но и реальные устройства по порядку.
</p>

<p>
[TODO:ranma:rigidus] Очень важно как можно раньше согласовать API - что и в каком
виде бизнес-логика получает от низкого уровня и что с этим делает. Ранма говорит,
что будет предоставлять с нижнего уровня наверх всю информацию по статусу
устройств, на уровне бизнес-логики надо лишь принимать решение. При этом всё
тестирование также будет осуществляться на нижнем уровне. В моей голове всё это не
очень клеится с тем, что мы обсудили. Прошу вас согласовать это и переписать
данный раздел.
[COMMENT:ranma] На нижнем уровне будет проводиться не все тестирование. Только наличие
устройства, если это возможно, и его инициализация.
</p>

<p>
Находясь в состоянии <code>selftest</code> от ниженго уровня системы получаются отчёты о
состоянии конкретных устройств. Система на уровне бизнес-логики определяет
дальнешие алгоритмы работы с ними, согласуя в том числе работу комплектов
зависимых друг от друга устройств [todo:noa] Поставить ссылку.
</p>

<p>
Если проходя через состояние <code>selftest</code> система сама пытается устранить неполадки.
[todo:ranma] Согласовать данный момент между бл и нижним уровнем.
</p>

<p>
В этот момент можно диагностировать критичные отказы ([todo:ranma]проработать виды
отказов) перед началом работы.  При обнаружении критичного отказа стойка
классифицирует отказ и немедленно переходит в состояние <code>hardlock</code> или <code>softlock</code>,
отсылая об этом сообщение на сервер.
</p>

<p>
Если тестирование оборудования прошло успешно, мы переходим к состоянию <code>standby</code>
или, в зависимости от <i>установленных настроек датчиков и реле</i>, в другие состояния.
</p>

<p>
[todo:pyub] заменить везде опросное на "опрашиваемое"
</p>

<p>
Точки входа в состояние:
</p>
<ul class="org-ul">
<li>включение стойки, т.е. на контроллер подано питание
</li>
<li>отсутствие ответа опрашиваемого оборудования [todo:pyub] ссылка на определение
</li>
<li>сигнал об ошибке от опрашиваемого оборудования
</li>
<li><code>root</code> принудительно перевел из UI [todo:pyub] описать опцию в описании UI
контроллера, важно - невозможность перевода в процессе исполнения задачи /
автомата или перехода между состояниями
</li>
</ul>

<p>
В состоянии <code>selftest</code> должны функционировать (в порядке запуска):
</p>
<ul class="org-ul">
<li>подсистема логировнаия
</li>
<li>обмен сообщениями с сервером
</li>
<li>SSH
</li>
<li>UI web-интерфейс контроллера
</li>
<li>подсистема <i>тестирования и диагностики из web-интерфейса контроллера</i> [todo:pyub] описать
</li>
</ul>
<p>
далее запускаются все остальные модули и периферийное оборудованние, которое
необходимо тестировать.
</p>

<p>
Стойка может быть выключена, но присутствовать в системе. Выключенная стойка не
получает и не реагирует ни на какие внешние воздействия. Управляющий сервер должен
иметь возможность отслеживать стойку в этом состоянии и включать/выключать ее при
необходимости.
</p>

<p>
В случае, если диагностирован некритичный отказ, информация о нем записывается в
конфигурацию, и об отказе информируется сервер.
</p>
</div>
</div>

<div id="outline-container-sec-5-4-3" class="outline-4">
<h4 id="sec-5-4-3"><span class="section-number-4">5.4.3</span> <span class="done DONE">DONE</span> Состояние ожидания (<code>standby</code>)</h4>
<div class="outline-text-4" id="text-5-4-3">
<p>
Режим работы в котором датчик стойки не видит автомобиля и не идёт никакой другой
процесс. В нём стойка реагирует на действия пользователя только сервисными
сообщениями, выводя на дисплей либо сообщение о том, что нет автомобиля, либо
сервисное сообщение о статусе карты/чека. Вся периферия неактивна.
</p>

<p>
Различие в алгоритмах режима ожидания главным образом заключается в том, что к стойкам
может быть подключен разный набор датчиков, соответственно условие перехода в
следующее состояние зависит от конкретного набора.
</p>

<p>
Также в зависимости от настроек пользователя по разному работает взаимодействие с
пользователем: если нет машины - стойка не реагирует на нажатия кнопок на ней, или
занимается продажей карточек и.т.п.
</p>

<p>
<i>Состояние ожидания (простой вьезд по чеку)</i> - для сценария вьезда с бумажными
билетами
</p>

<p>
В этом состянии стойка может обнаружить критичный отказ, в этом случае она
немедленно переходит в состояние <code>hardlock</code>, информируя об этом сервер
</p>
</div>
</div>

<div id="outline-container-sec-5-4-4" class="outline-4">
<h4 id="sec-5-4-4"><span class="section-number-4">5.4.4</span> <span class="todo TODO">TODO</span> Подъезд машины к стойке (<code>finding</code>)</h4>
<div class="outline-text-4" id="text-5-4-4">
<p>
Процесс управления сложной процедурой подъезда машины к стойке (через шлюз из двух
шлагбаумов, по рампе) и/или определения датчиком (петлей индуктивности,
фотоэлементом, датчиком магнитного поля) габаритов/массы автотранспортного
средства, а также контроля подъезда к стойке.
</p>

<p>
<i>Подьезд машины к стойке (<code>finding</code>)</i> для сценария вьезда с бумажными билетами
</p>

<p>
[TODO:pyub] - Критичный отказ возможен? Какие условия его возникновения? Как
обрабатываем такую ситуацию, если управляем машиной?
</p>
</div>
</div>

<div id="outline-container-sec-5-4-5" class="outline-4">
<h4 id="sec-5-4-5"><span class="section-number-4">5.4.5</span> <span class="todo TODO">TODO</span> Стойка в диалоговом режиме (<code>dialog</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-4-5">
<p>
После срабатывания датчика присутствия стойка начинает диалог с посетителем, выводя
на дисплей сообщения <code>display-dialog</code> о необходимости совершения действий, ошибок и
т.п. В этом режиме посетитель может совершить действия, которые в конечном счёте
может привести к большому списку различных ответов системы, запуска процедур и
изменений состояний.
</p>

<p>
[TODO:pyub] - дописать и перечислить все возможные действия, которые может
совершить пользователь, описать протокол взаимодействия для каждого из них
(поведение стойки в ответ на действия пользователя, варианты действий пользователя
в каждом узле протокола, и.т.п)
</p>

<p>
[comment:pyub] действия и реакция на них расписаны в описаниях для конкретных типов
стоек и конкретных типов оборудования.
</p>

<p>
На этом этапе осуществляется арбитраж в случае использования реверсивного проезда
(один шлагбаум на две стойки с разных сторон) или использования двух стоек для
левого и правого руля.
</p>

<p>
После срабатывания датчика присутствия стойка начинает диалог с посетителем, выводя
на дисплей сообщения о необходимости совершения действий, ошибок и т.п. Стойка
может сопровождать эти действия проигрыванием аудиозаписей для клиента.
</p>

<p>
После прикладывания пользователем въездного документа, либо оплатного документа,
либо карты СКУД, стойка совершает проверку возможности выезда, статуса оплаты и так
далее. На этом этапе осуществляется арбитраж в случае использования реверсивного
проезда (один шлагбаум на две стойки с разных сторон) или использования двух стоек
для левого и правого руля. Также на этом этапе выезд может быть совмещён с оплатой,
как на автоматическом кассовом терминале.
</p>

<p>
Разрешение для посетителя на пребывание на парковке в течение определенного
промежутка времени после оплаты задается арендатором. При этом клиентская программа
арендатора шлет информацию на центральный сервер, а центральный сервер сохраняет
информацию и транслирует ее контроллеру. Контроллер сохраняет полученную информацию
в памяти. При выезде автомобиля контроллер проверяет, истек срок пребывания на
парковке или нет, и разрешает или запрещает выезд. Время выезда передается на
центральный сервер.
</p>

<p>
Есть диалоговый режим, который при неплаченном проезде приводит к процедуре
оплаты. [TODO:pyub] - Описать и дать ссылку.
</p>

<p>
[TODO:pyub] - Критичный отказ возможен? Какие условия его возникновения? Как
обрабатываем такую ситуацию?
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-5-1"></a>Дисплей <code>display-dailog</code><br  /><ol class="org-ol"><li><a id="sec-5-4-5-1-1"></a><code>display-gialog-enter</code><br  /><ol class="org-ol"><li><a id="sec-5-4-5-1-1-1"></a>Дисплей <code>4lines</code><br  /><ol class="org-ol"><li><a id="sec-5-4-5-1-1-1-1"></a>barcode<br  /></li>
<li><a id="sec-5-4-5-1-1-1-2"></a>EM<br  /></li></ol>
</li></ol>
</li></ol>
</li></ol>
</div>

<div id="outline-container-sec-5-4-6" class="outline-4">
<h4 id="sec-5-4-6"><span class="section-number-4">5.4.6</span> <span class="todo TODO">TODO</span> Инициация процедуры проезда (<code>init</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-4-6">
<p>
После того, как посетителю разрешён въезд (из презентера устройства забран чек или
карта, или успешно проверен статус карты СКУД) контроллер инициирует процесс
открытия шлагбаума, замыкая соответсвующие реле и принимая сигналы с концевиков
шлагбаума (или давая выставленный в миллисекундах импульс, если концевиков нет).
</p>

<p>
[TODO:pyub] - Мне нужны описания сообщений, получаемых контроллером от устройств,
которые приводят к выходу из состояния <code>init</code>.
</p>

<p>
[TODO:pyub] - Что с критичным отказом в этом состянии? Условия возникновения, как
обрабатываем?
</p>
</div>
</div>

<div id="outline-container-sec-5-4-7" class="outline-4">
<h4 id="sec-5-4-7"><span class="section-number-4">5.4.7</span> <span class="todo TODO">TODO</span> Процедура проезда (<code>goon</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-4-7">
<p>
После открытия шлагбаума контроллер контролирует проезд машины под стрелой,
принимая сообщения с датчика безопасности (фотоэлемент на линии стрелы) и датчика
завершения проезда (петля индуктивности за стрелой, фотоэлемент, датчик МП). В эту
же процедуру может входит контроль проезда по рампе или через шлюз, находящийся за
стойкой.
</p>

<p>
[TODO:pyub] - Необходимо описать различия по рампе/шлюзу/реверсивному движению
(алгоритм движения, включаемые устройства, ожидание подтверждения проезда от
датчиков и.т.п.)
</p>

<p>
[TODO:pyub] - Мне нужны описания сообщений, получаемых контроллером от устройств,
которые приводят к выходу из состояния <code>goon</code>.
</p>

<p>
[TODO:pyub] - Что с критичным отказом в этом состянии? Условия возникновения, как
обрабатываем?
</p>
</div>
</div>

<div id="outline-container-sec-5-4-8" class="outline-4">
<h4 id="sec-5-4-8"><span class="section-number-4">5.4.8</span> <span class="todo TODO">TODO</span> Процедура завершения проезда (<code>fin</code>)</h4>
<div class="outline-text-4" id="text-5-4-8">
<p>
Процесс закрытия шлагбаума после проезда машины, отправки итоговых данных о
совершённом проезде на сервер и возвращения стойки в режим ожидания.
</p>

<p>
[TODO:pyub] - Надо описать различия по отправляемым на сервер данным от периферии и
настроек тарифных зон.
</p>

<p>
[TODO:pyub] - Мне нужны описания сообщений, получаемых контроллером от устройств,
которые приводят к выходу из состояния <code>fin</code>.
</p>

<p>
[TODO:pyub] - Что с критичным отказом в этом состянии? Условия возникновения, как
обрабатываем?
</p>
</div>
</div>

<div id="outline-container-sec-5-4-9" class="outline-4">
<h4 id="sec-5-4-9"><span class="section-number-4">5.4.9</span> <span class="todo TODO">TODO</span> Cостояние полной блокировки (<code>hardlock</code>)</h4>
<div class="outline-text-4" id="text-5-4-9">
<p>
При возникновении критичного отказа стойка может перевести себя в данное состояние,
заблокировав всё своё периферийное оборудование и завершив все процессы
взаимодействия с переферийным оборудованием для возмодности работы с этими
библиотеками и модулями.
</p>

<p>
В этом случае, в зависимости от алгоритма (например <code>barcode</code>) она выполняет
урезанный протокол взаимодействия, и не занимается своей основной задачей -
пропускать машины, а вместо этого, например только продает билеты, или даже
информирует посетителя о сбое работы.
</p>

<p>
[TODO:pyub] - В случае, если отказ некритичный, и стойка может управлять проездом
машин, то она не переходит в состояние <code>hardlock</code>, вместо этого модифицируется
алгоритм . К примеру, если отказал термопринтер, стойка может успешно пропускать
постоянных клиентов по картам, для этого мы просто меняем текущий алгоритм ее
работы, на что то вроде "проезд только по картам" - и это критичным отказом не
считается. Следовательно то что описано ниже - про частичную блокировку - нужно
вынести в другое место - полагаю в алгоритмы работы. При этом там, где мы описываем
различные отказы описать, при каком отказе один алгоритм текущей работы стойки
может поменяться на другой.
</p>

<p>
[TODO:pyub] - Раз стойка может быть выключена, то вероятно сервер может выключить
ее, отправив ей сообщение. Нужно описать в каких состояниях возможно выключение (мы
же не хотим вырубить стойку при проезде машины так, чтобы на нее рухнул шлагбаум?)
Полагаю, что во всех остальных состояниях стойка запоминает, что необходимо
выключиться, выполняет протокол до первого состояния где выключение возможно и
выключается. В этом случае я должен предусмотреть корректную реакцию на события во
всех этих состяниях.
</p>

<p>
Состояние, в которое переходит стойка в случае некорректной работы критичного для
работы системы опросного <i>периферийного устройства</i>. Для стоек, на которых нет
торгового оборудования (т.е.работы с деньгами) блокировка должна быть
частичной. Например, если заканчивается бумага в термопринтере, выводится сообщение
о том, что "Печать билета невозможна, обратитесь к персоналу парковки", но при этом
въезд по пластиковым билетам (картам) для постоянных клиентов по прежнему возможен.
</p>

<p>
В случае возникновения ситуации блокировки стойка регулярно отправляеет на сервер
сервисное сообщение о том, что она работает в нештатном режиме и требуется
произвести замену бумаги или ремонт устройства.
</p>
</div>
</div>

<div id="outline-container-sec-5-4-10" class="outline-4">
<h4 id="sec-5-4-10"><span class="section-number-4">5.4.10</span> <span class="todo WAIT">WAIT</span> Процедура частичной блокировки (<code>softlock</code>)</h4>
</div>
<div id="outline-container-sec-5-4-11" class="outline-4">
<h4 id="sec-5-4-11"><span class="section-number-4">5.4.11</span> <span class="todo WAIT">WAIT</span> Процедура оплаты (<code>payment</code>)</h4>
<div class="outline-text-4" id="text-5-4-11">
<p>
В пилотном проекте мы пострараемся избежать реализации этого.
</p>

<p>
Это состояние может быть активировано и после <code>dialog</code> и после <code>standby</code>. Может
быть касса, совмещенная с выездом, на ней есть и торговое
оборудование. Пользователь может прийти пешком из <code>standby</code> и оплатить или
подьехать - тогда входом может быть любое состояние и выходом может быть <code>standby</code>
или <code>init</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> <span class="todo TODO">TODO</span> Обработка сигналов и сообщений&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-5-5">
</div><div id="outline-container-sec-5-5-1" class="outline-4">
<h4 id="sec-5-5-1"><span class="section-number-4">5.5.1</span> <span class="todo TODO">TODO</span> Входящие сигналы с датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-5-1">
<p>
Принцип функционирования простых <code>датчиков</code>: в самом датчике замыкается реле, с
него на контроллер парковочной системы идёт ток 5/12/24 В (в зависимости от
устройства датчика). Пока ток идёт на <code>сенсорный ввод</code> контроллера, системное
значение сенсора <code>SX</code> = <code>1</code> (где X - номер датчика).  Когда тока нет на сенсоре -
<code>SX</code> = <code>0</code>.
</p>

<p>
Например: для <code>датчика присутствия</code> наличие сигнала (<code>1</code>) значит, что автомобиль
находится в зоне действия контура датчика. Если <code>0</code>, то автомобиля нет.
</p>

<p>
Для <code>датчика безопасности</code> отсутствие сигнала (<code>0</code>) означает, что на на линии
стрелы шлагбаума находится объект (луч разомкнут). Если <code>1</code>, то линия свободна.
</p>

<p>
Для <code>датчика контроля стрелы шлагбаума</code> - определение того, что стрела находится
в определённном положении:
есть сигнал с <code>концевика открытия</code> (<code>1</code>) - стрела поднята
есть сигнал с <code>концевика закрытия</code> (<code>1</code>) - стрела опущена
нет сигнала с обоих концевиков (<code>0</code>) - стрела в промежуточном состоянии
есть сигнал с обоих концевиков (<code>1</code>) - ошибка
</p>

<p>
В случае отказа сенсорного устройства администратор снимает соотвествующий
устройству флаг <i>настройках администратора в web-интерфейсе контроллера</i> и проверка сигнала на
данном сенсоре отключается. Если датчик отключён, все проверки, связанные с ним, не
выполняются.
</p>

<p>
[TODO:pyub] - Полагаю, такие вещи можно делать и автоматически, не привлекая
администратора. В алгоритмах работы, в каждом состоянии нужно описать что мы
делаем, получив отказ какого-то датчика.
</p>

<p>
Неисправность в работе простых датчиков никак не диагоностируется.  Если датчик или
линия связи неисправны - вместо изменения сигнала ничего ни происходит.
</p>

<p>
[TODO:pyub] - Однако в ряде случаев мы можем диагностировать неисправность, если
датчик сообщает нам что-то такое, чего не может быть в этом состоянии. Например,
если в <code>standby</code> шлагбаум не закрыт и не открыт. Или к примеру в <code>selftest</code> (сразу
после включения стойки), при закрытом шлакбауме фотоэлемент сообщает о присутствии
машины под ним.
</p>

<p>
Если на петле Б нет автомобиля - шлагбаум закрывается по выставлемому оператором
<code>таймауту закрытия шлагбаума</code>, отсчитываемому после получения сигнала о проезде с
датчика безопасности (фотоэлемент).
</p>

<p>
Если фотоэлемент и петля Б не функционируют одновременно - шлагбаум закрывается только
по выставляемому оператором  таймауту закрытия шлагбаума, отсчитываемому после прихода
сигнала об открытии шлагбаума.
</p>

<p>
Если отсуствуют или не работают <code>датчики статуса стрелы шлагбаума</code> (концевики
открытия/закрытия) - то при открытие шлагбаума напряжение на него подаётся в
соотвествии с настроенным <code>временим импульса открытия шлагбаума</code>, а при закрытии в
соответсвии с настроенным <code>временим импульса закрытия шлагбаума</code>. Статус концевиков
при этом не учитывается.
</p>

<p>
Тонкая настройка датчиков также оператором через <i>UI администратора контроллера</i> и
описана в разделе <i>Настройки работы датчиков и реле</i>
</p>
</div>
</div>

<div id="outline-container-sec-5-5-2" class="outline-4">
<h4 id="sec-5-5-2"><span class="section-number-4">5.5.2</span> <span class="todo TODO">TODO</span> Отмена проезда по чеку&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-5-2">
<p>
Если алгоритм въезда не завершён до конца, не важно на каком этапе это произошло,
то полученный билет аннулируется через время t.
</p>

<p>
[TODO:pyub] - важно описать все такие инварианты (прерывание алгортима вьезда) в
каждом из алгоритмов.
</p>
</div>
</div>

<div id="outline-container-sec-5-5-3" class="outline-4">
<h4 id="sec-5-5-3"><span class="section-number-4">5.5.3</span> <span class="todo TODO">TODO</span> Повторная печать въездного билета&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-5-3">
<p>
Для невозможности печати человеком без машины печати нового билета у въездной
стойки для бесплатного выезда, используется датчик магнитной петли А и алгоритм
перехода из режима ожидания в режим диалога при появлении машины в зоне датчика. В
случае, если билет всё-же печатается (например, для обмана системы используется
другая машина на въезде), то либо следующий въехавший автомобиль остаётся без
билета и посетитель вынужден оплачивать штраф, либо, если машина не въехала,
срабатывает <i>обработка отмены проезда по чеку</i>
</p>

<p>
[TODO:pyub] - Не могу перейти по этой ссылке
</p>

<p>
[TODO:pyub] - Следующий клиент мягко говоря не поймет, что мы используем его для
контроля мошенничества предыдущего клиента. Надо этот момент как-то переработать&#x2026;
</p>

<p>
[TODO:rigidus] - Немного не правильно сформулирова. Суть объясню устно когда
приедешь.
</p>

<p>
[TODO:pyub] - Нет уж, давай тут, чтобы в гите потом можно было найти
</p>
</div>
</div>

<div id="outline-container-sec-5-5-4" class="outline-4">
<h4 id="sec-5-5-4"><span class="section-number-4">5.5.4</span> Настройки администратора из web-интерфейса контроллера</h4>
<div class="outline-text-4" id="text-5-5-4">
</div><ol class="org-ol"><li><a id="sec-5-5-4-1"></a>Настройка торгового оборудования<br  /><ol class="org-ol"><li><a id="sec-5-5-4-1-1"></a><span class="todo TODO">TODO</span> Включить печать билетов термопринтером&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-5-5-4-1-1">
<p>
[TODO:pyub] Внести момент относительно информирования клиента о невозможности
въехать по билету при неисправности принтера
</p>

<p>
Если в комплекте оборудования <code>въездной стойки</code> есть <code>термопринтер</code> и в память
контроллера установлена библиотека для работы с ним, внутри системы взводится
флаг <code>printer-exist</code> и в настройках в web-интерфейсе самого контроллера становится
доступен флаг включения или отключения работы термопринтера.
</p>

<p>
При изменении значения этого флага сервер посылает стойке соотвествующие
сообщения и стойка включает или выключает термопринтер в своих настройках.
</p>

<p>
[TODO:rigidus] - Описать это в разделе web-интерфейса и обработчике сообщений
контроллером. Проверить все инварианты в случаях, когда термопринтер
есть/нет/сломан/починен.
</p>

<p>
<code>printer-on</code> - принтер включен и возможен въезд по бумажным билетам (флаг установлен)
<code>printer-off</code> - принтер отключен и въезд по бумажным билетам невозможен (флаг снят)
</p>

<p>
В случае наличия включённого термопринтера во всех состояниях стойки на дисплее
отображается сообщения, связанные с печатью и обработкой билета.
</p>

<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
[TODO:pyub] - чтобы описать это в коде я должен знать сообщения стойки для всех
состояний всех алгоритмов если принтер включен, если принтер выключен и если он
сломан.
</p>

<p>
Обработка ошибок в работе термопринтера:
<i>Обработка ошибок в работе термопринтера на въезде (<code>printer-problem</code>)</i>
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-5-4-2"></a>Настройки работы датчиков и реле<br  /><ol class="org-ol"><li><a id="sec-5-5-4-2-1"></a><span class="todo TODO">TODO</span> Включить проверку датчика магнитной петли А&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-1">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса машины по <code>датчику присутствия автомобиля А</code>.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-a</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-a</code> присвоен сенсорный ввод <code>S1</code>.
</p>

<p>
Состояние <code>detector-a</code> = <code>0</code> (не замкнуто реле, нет машины).
Состояние <code>detector-a</code> = <code>1</code> (замкнуто реле, машина на петле).
</p>

<p>
Если администратор отключает датчик присутствия автомобиля (снимает флаг), то
возникает событие <code>detector-a-disabled</code>.
</p>

<p>
Для алгоритма простого въезда по чекам в состоянии <code>standby</code>:
<i>Настройка: Выключена проверка датчика присутсвия автомобиля А</i>
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-2"></a><span class="todo TODO">TODO</span> Включить проверку датчика магнитной петли Б&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-2">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса машины по <code>датчику присутствия автомобиля Б</code>.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-b</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-b</code> присвоен сенсорный ввод <code>S2</code>.
</p>

<p>
Состояние <code>detector-b</code> = <code>0</code> (не замкнуто реле, нет машины).
Состояние <code>detector-b</code> = <code>1</code> (замкнуто реле, машина на петле).
</p>

<p>
Если администратор отключает датчик присутствия автомобиля (снимает флаг), то
возникает событие <code>detector-b-disabled</code>.
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-3"></a><span class="todo TODO">TODO</span> Включить проверку фотоэлемента безопасности&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-3">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика безопасности</code>, отвечающего за остановку закрытия стрелы
шлагбаума при наличии на линии фотоэлементов объекта.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-safety</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-safety</code> присвоен сенсорный ввод <code>S7</code>.
</p>

<p>
Состояние <code>detector-safety = =1</code> (не замкнуто реле, на линии
фотоэлементов нет объекта).
Состояние <code>detector-safety = =0</code> (замкнуто реле, на линии
фотоэлементов есть объект).
</p>

<p>
Если администратор отключает датчик безопасносоти (снимает флаг), то
возникает событие <code>detector-safety</code> -  <code>disabled</code>.
</p>

<p>
Если датчик безопасности отключён - в процедуре закрытия шлагбаума не
формируется событие <code>gate-stop</code> при наличии объекта на линии фотоэлемента в
процессе закрытия, и при начал процедуры закрытия не проверяются состояние <code>detector-safety</code>.
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-4"></a><span class="todo TODO">TODO</span> Включить работу с концевиком открытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-4">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика статуса стрелы шлагбаума</code> - <code>концевика открытия</code>,
отвечающего за контроль статуса стрелы шлагбаума и остановку движения стрелы по
факту её открытия.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-gate-open</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-gate-open</code> присвоен сенсорный ввод <code>S5</code>.
</p>

<p>
Состояние <code>detector-gate-open</code> = <code>1</code> (замкнуто реле, стрела шлагбаума открыта)
приводит к событию <code>gate-open</code>.
Состояние <code>detector-gate-open</code> = <code>0</code> (не замкнуто реле, стрела шлагбаума НЕ открыта).
</p>

<p>
Если администратор отключает датчик концевика открытия (снимает флаг), то
возникает событие <code>detector-gate-open-disabled</code>.
</p>

<p>
Если проверка концевика открытия отключена, то открытие шлагбаума и остановка
движения стрелы происходят по параметру <code>импульс открытия шлагбаума</code>.
</p>

<p>
См. <i>Настройка импульса открытия шлагбаума</i>
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-5"></a><span class="todo TODO">TODO</span> Включить работу с концевиком закрытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-5">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика статуса стрелы шлагбаума</code> - <code>концевика закрытия</code>,
отвечающего за контроль статуса стрелы шлагбаума и остановку движения стрелы по
факту её закрытия.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-gate-close</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-gate-close</code> присвоен сенсорный ввод <code>S6</code>.
</p>

<p>
Состояние <code>detector-gate-close</code> = <code>1</code> (замкнуто реле, стрела шлагбаума открыта)
приводит к событию <code>gate-close</code>.
Состояние <code>detector-gate-close</code> = <code>0</code> (не замкнуто реле, стрела шлагбаума НЕ
открыта).
</p>

<p>
Если администратор отключает датчик концевика закрытия (снимает флаг), то
возникает событие <code>detector-gate-close-disabled</code>.
</p>

<p>
Если проверка концевика закрытия отключена, то открытие шлагбаума и остановка
движения стрелы происходят по параметру <code>импульс закрытия шлагбаума</code>.
</p>

<p>
См. <i>Настройка импульса закрытия шлагбаума</i>
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-6"></a><span class="todo TODO">TODO</span> Настройка импульса открытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-6">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть поле настройки <code>импульса
      открытия шлагбаума</code> (<code>impulse-gate-open</code>) в котором можно в милисекундах
выставить время, в течении которого с реле открытия шлагбаума
(<code>relay-gate-open</code>) подаётся напряжение, т.е. стрела поднимается. Когда реле
размыкается - стрела останавливается и происходит событие <code>gate-open</code>.
</p>

<p>
Поле <code>impulse-gate-open</code> активно для ввода значения только если актвино событие
<code>detector-gate-open-disabled</code>, т.е <i>выключена работа с концевиком открытия шлагбаума</i>.
</p>

<p>
В настройках по умолчанию <code>impulse-gate-open</code> = 3000 ms.
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-7"></a><span class="todo TODO">TODO</span> Настройка импульса закрытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-7">
<p>
[TODO:rigidus] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть поле настройки <code>импульса
      закрытия шлагбаума</code> (<code>impulse-gate-close</code>) в котором можно в милисекундах
выставить время, в течении которого с реле закрытия шлагбаума
(<code>relay-gate-close</code>) подаётся напряжение, т.е. стрела опускается. Когда реле
размыкается - стрела останавливается и происходит событие <code>gate-close</code>.
</p>

<p>
Поле <code>impulse-gate-close</code> активно для ввода значения только если актвино событие
<code>detector-gate-close-disabled</code>, т.е <i>выключена работа с концевиком закрытия шлагбаума</i>.
</p>

<p>
В настройках по умолчанию <code>impulse-gate-close</code> = 3000 ms.
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-8"></a><span class="todo START">START</span> Включение контроля работы шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="noa">noa</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-8">
<p>
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
      [VRFY:pyub]
</p>

<p>
<code>=====</code>
&gt;&gt;&gt;&gt;&gt;&gt;&gt; b4ea4b2c099fbadc818e459ea5183bade6a0ea93
      В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
      <code>безопасного режима</code> работы шлагбаума <code>control-gate</code>, который управляет работой
      реле <code>relay-gate-stop</code>.
</p>

<p>
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
      В настройках по умолчанию безопасный режим включен  (<code>control-gate</code> -
      <code>enabled</code>), что разрешает работу шлагбаума с помощью реле <code>relay-gate-stop</code> активирую его
      перед <code>relay-gate-open</code> и <code>relay-gate-close</code> до момента получения события
      <code>gate-open</code> или <code>gate-close</code> или <code>gate-stop</code>
</p>

<p>
Безопасный режим выключен  (<code>control-gate</code> -
<code>disable</code>), что разрешает работу шлагбаума с помощью реле <code>relay-gate-stop</code> активирую его
постоянно, до момента получения события <code>gate-stop</code> размыкая его.
<code>=====</code>
В <code>безопасном режиме</code> работа шлагбаума разрешается только при подаче на него
исполняемого сигнала (например, открытия или закрытия).
</p>

<p>
      Пример:
      Если во время процедуры закрытия нам необходимо остановить шлагбаум по
      срабатыванию фотоэлемента безопансости [todo:noa], мы меняем статус <code>реле стоп</code>
      (зависит от настройки <i>Реле "стоп" нормально замкнуто</i>).
&gt;&gt;&gt;&gt;&gt;&gt;&gt; b4ea4b2c099fbadc818e459ea5183bade6a0ea93
</p>

<p>
Если безопасный режим включен(<code>control-gate</code> - <code>enabled</code>), то работа шлагбаума разрешена только при
одновремнной подаче команды на открытие или закрытие стрелы (<code>relay-gate-open</code> и
<code>relay-gate-close</code>). Разрешение действует до совершения событий <code>gate-open</code>,
<code>gate-close</code> или <code>gate-stop</code> [todo:noa] Описать работу фотоэлементов.
</p>

<p>
Если безопастный режим выключен (<code>control-gate</code> - <code>disabled</code>), то работа
шлагбаума с помощью реле разрешена постоянно, независимо от команд открытия и
закрытия.  Разрешение действует до совершения события <code>gate-stop</code>. [todo:noa]
Описать работу фотоэлементов.
</p>

<p>
В настройках по умолчанию безопасный режим включен (<code>control-gate</code> - <code>enabled</code>).
</p>
</div>
</li>

<li><a id="sec-5-5-4-2-9"></a><span class="todo START">START</span> Реле "стоп" нормально замкнуто&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="noa">noa</span></span><br  /><div class="outline-text-6" id="text-5-5-4-2-9">
<p>
[VRFY:pyub]
</p>

<p>
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
      В нстройках в <code>web-интерфейсе</code> контроллера есть двухпозиционый переключатель (radiobutton) -
      настройка типа реле стоп (нормально замкнутое - NC/нормально разомкнутое - NO), которая,
      определяет формат выводимых данных <code>relay-gate-stop</code>.
</p>

<p>
По умолчанию включено состояние "нормально замкнутое - NC".
"Нормально замкнутое - NC" это состояние при котором  <code>relay-gate-stop</code> присвоенно  <code>0</code>, при активации меняется
на  <code>0</code>.
"Нормально разамкнутое - NO" это состояние при котором  <code>relay-gate-stop</code> присвоенно  <code>1</code>, при активации меняется
на  <code>1</code>.
</p>

<p>
<code>=====</code>
      реле стоп нормально замкнуто
      реле стоп нормально разомкнуто
&gt;&gt;&gt;&gt;&gt;&gt;&gt; b4ea4b2c099fbadc818e459ea5183bade6a0ea93
</p>

<p>
В настройках по умолчанию реле стоп - замунто, галочка установлена. (<code>control-</code> - <code>enabled</code>).
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика статуса стрелы шлагбаума</code> - <code>концевика закрытия</code>,
отвечающего за контроль статуса стрелы шлагбаума и остановку движения стрелы по
факту её закрытия.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-gate-close</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-gate-close</code> присвоен сенсорный ввод <code>S6</code>.
</p>

<p>
Состояние <code>detector-gate-close</code> = <code>1</code> (замкнуто реле, стрела шлагбаума открыта)
приводит к событию <code>gate-close</code>.
Состояние <code>detector-gate-close</code> = <code>0</code> (не замкнуто реле, стрела шлагбаума НЕ
открыта).
</p>

<p>
Если администратор отключает датчик концевика закрытия (снимает флаг), то
возникает событие <code>detector-gate-close-disabled</code>.
</p>

<p>
Если проверка концевика закрытия отключена, то открытие шлагбаума и остановка
движения стрелы происходят по параметру <code>импульс закрытия шлагбаума</code>.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-5-4-3"></a>Системные настройки<br  /><ol class="org-ol"><li><a id="sec-5-5-4-3-1"></a><span class="todo TODO">TODO</span> Настройка логирования событий&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-5-5-4-3-1">
<p>
В этом разделе можно установить объём хранимого системой лога событий, ограничив
его либо по количеству записей, либо по объёму занимаемого пространства на
SD-карте.
</p>

<p>
Вторая настройка логирования - отправка сообщений на сервер. Если в настройках
стойки установлен IP адрес сервера, то он автоматически добавляется и сюда. Флаг
включает / отключает логирование.
</p>

<p>
[WAIT] Третья настройка логирования - сохранение лога в виде текстовых файлов в
стороннее сетевое хранлище. В адресную строку можно вбить адрес сетевой шары, а в
дополнительные поля логин и пароль к ней. в неё (шару) стойка будет писать
текстовые файлы, создавая каждый час новый файл. Именем файла является дата и
время начала записи.
</p>

<p>
По умолчанию объём лога ограничен [todo:rigidus] Надо определить как оптимальнее
с точки зрения доступа к данным и т.п.
</p>

<p>
По умолчанию отправка на сервер включена.
</p>
</div>
</li></ol>
</li></ol>
</div>

<div id="outline-container-sec-5-5-5" class="outline-4">
<h4 id="sec-5-5-5"><span class="section-number-4">5.5.5</span> Тестирование и диагностика из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-5-5-5">
<p>
[TODO:noa] Подробно описать функционал работы системы аналогичной Parking Test
применимо к нашей системе.
</p>

<p>
В web-интерфейсе должна быть закладка диагностики. На этой странице отображаются
данные по всем сенсорным вводам, реле и подключениям перферийных устройств.
В формате:
    SX (где X - номер сенсора) - есть / нет сигнал отображается разным цветом.
    BX (где Х - номер кнопки) - есть / нет сигнал  отображается разным цветом.
    RX (где Х - номер реле) - есть / нет замыкание  отображается разным цветом.
</p>

<p>
PORTX - TYPE - MODEL (где PORT- тип порта по которому подключенно устройство, X
</p>
<ul class="org-ul">
<li>номер порта, TYPE - тип устройства, MODEL - модель устройства, STATUS - статус
</li>
</ul>
<p>
устройства отображается разными цветами зеленой-функционирует, желтый были не
сброшенные ошибки за прошедшие сутки, красный присутствуют ошибки на данный
момент, черный с устройством нет связи но в конфигурации оно есть.
Должна быть кнопка тестирования которая при нажатии проводит тестировние
устройства и возвращает список ошибок или "ошибок нет". Так же должен быть
список ошибок возникавших за период с момента последнего сброса ошибок. Кнопка
сброса списка ошибок по каждому устройству за прошедший период.
</p>

<p>
Должно отображаться текущее время на контроллере, время последней
связи/синхронизации с сервером. Данные отображаемые на дисплее стойки.
</p>


<p>
Должно присутсвовать окно с логом замыкания/сигналами за время сессии
теститровани(сессия нчинается при подключении к контроллеру через web
интерфейс). Данные лога должны содержать время срабатывания, название и
длительность сигнала для события его окончания
</p>


<p>
Также там должен быть реализован функционал тестирования оборудования, а для
суперадминистратора имитации финансовых операций (для простого админа запрещаем,
т.к. это всё связано с фискальником и балансом и потом могут быть проблемы).
</p>
</div>
</div>

<div id="outline-container-sec-5-5-6" class="outline-4">
<h4 id="sec-5-5-6"><span class="section-number-4">5.5.6</span> Настройки тарификации из web-интерфейса контроллера</h4>
<div class="outline-text-4" id="text-5-5-6">
</div><ol class="org-ol"><li><a id="sec-5-5-6-0-1"></a><span class="todo TODO">TODO</span> Включить обновление данных о тарифах с сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-6" id="text-5-5-6-0-1">
<p>
[TODO:rigidus] Описать в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
автоматического получения, применения и <code>обновления данных о тарифах с сервера</code>.
</p>

<p>
В настройках по умолчанию обновление включено (<code>tariff-autoload</code> -
<code>enabled</code>). При такой настройке стойка автоматически забирает данные о времени
и режиме работы парковки, тарифных зонах и остальных настройках раздела с
сервера. Поля настроек защищены от редактирования и в них отображаются данные,
полученные с сервера системы.
</p>

<p>
Если в настройках обновление отключено (<code>tariff-autoload</code> -
<code>disabled</code>), поля становятся доступны для редактирования и стойка оперирует выставлеными в них
значениями вместо рассылаемых централизовано с сервера.
</p>
</div>
</li>

<li><a id="sec-5-5-6-0-2"></a><span class="todo TODO">TODO</span> Время работы стойки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-5-5-6-0-2">
<p>
Данная настройка определяет время работы стойки. В установленный период стойка
работает штатно, вне его переходит в <i>состояние блокировки (<code>lock</code>)</i>.
</p>

<p>
[TODO:pyub] Описать специфику блокировки по времени работы. Кроме того, мы обычно
переходим в <code>lock</code> в случае возникновения каких-то проблем, может быть лучше
просто выключать стойку или придумать для таких "режимных" выключений свое
состояние, где стойка будет не реагировать ни на что, только сообщая, что "Вы что
не видите, что у нас обед?"
</p>

<p>
Формат настройки - поля для ввода времени в 24-х часовом формате "с HH:MM" "до HH:MM".
</p>

<p>
Наследуется от глобальной настройки <code>время работы парковки</code> или настройки <code>время
      работы сектора</code> к которому относится стойка в <code>web-интерфейсе сервера</code>.
</p>

<p>
[TODO:pyub] - Нужно дать ссылку на эти настройки
</p>

<p>
Настройка по умолчанию при выключенном наследовании "с 00:00" до "23:59",
т.е. стойка функционирует круглосуточно.
</p>

<p>
[TODO:pyub] - Лучше просто пусть там будет ноль, а то мы можем забыть это
специально обработать и стойка будет перезагружаться в полночь, и не дай бог там
в это время будет вьезжать машина..
</p>
</div>
</li>

<li><a id="sec-5-5-6-0-3"></a><span class="todo TODO">TODO</span> Время работы стойки для разовых посетителей&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-5-5-6-0-3">
<p>
[TODO:pyub] - Надо дать ссылки на те настройки которые уже есть и те настройки
которые еще не описаны, но на них ссылается содержимое этого раздела
</p>

<p>
Данная настройка определяет время работы стойки для разовых посетителей,
использующих одноразовые проездные документы (в зависимости от комплекта
оборудования - чеки или карты Mifare+).
</p>

<p>
Формат настройки - поля для ввода времени в 24-х часовом формате "с HH:MM" "до HH:MM".
</p>

<p>
Имеет приоритет над настройкой <i>время работы стойки</i>.
</p>

<p>
Наследуется от глобальных настроек в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда для разовых посетителей</code> - для въездов и въездов
совмещённых с оплатами
</li>
<li><code>время работы выезда для разовых посетителей</code> - для выездов и выездов
совмещённых с оплатами
</li>
<li><code>время работы оплаты для разовых посетителей</code> - для кассовых терминалов
</li>
</ul>

<p>
Или от глобальных настроек секторов в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда в сектор для разовых посетителей</code> - для въездов и въездов
совмещённых с оплатами
</li>
<li><code>время работы выезда из сектора для разовых посетителей</code> - для выездов и
выездов совмещённых с оплатами
</li>
</ul>

<p>
Настройка по умолчанию при выключенном наследовании "с 00:00" до "23:59".
</p>
</div>
</li>

<li><a id="sec-5-5-6-0-4"></a><span class="todo TODO">TODO</span> Время работы для постоянных посетителей&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-5-5-6-0-4">
<p>
[TODO:pyub] - Надо дать ссылки на те настройки которые уже есть и те настройки
которые еще не описаны, но на них ссылается содержимое этого раздела
</p>

<p>
Данная настройка определяет время работы стойки для постоянных посетителей,
использующих <i>карты СКУД</i>, <i>абонементские карты</i> или <i>дебетовые карты</i> (в зависимости
от комплекта оборудования - карт EM-Marine или Mifare+).
</p>

<p>
Формат настройки - поля для ввода времени в 24-х часовом формате "с HH:MM" "до HH:MM".
</p>

<p>
Имеет приоритет над настройкой <i>время работы стойки</i>.
</p>

<p>
Наследуется от глобальных настроек в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда для постоянных посетителей</code> - для въездов и въездов
совмещённых с оплатами
</li>
<li><code>время работы выезда для постоянных посетителей</code> - для выездов и выездов
совмещённых с оплатами
</li>
<li><code>время работы оплаты для постоянных посетителей</code> - для кассовых терминалов,
оплата дебетовых или абонементских карт, автоматическая продажа карточек при
наличии
</li>
</ul>

<p>
Или от глобальных настроек секторов в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда в сектор для постоянных посетителей</code> - для въездов и въездов совмещённых с оплатами
</li>
<li><code>время работы выезда из сектора для постоянных посетителей</code> - для выездов и выездов совмещённых с оплатами
</li>
</ul>

<p>
Настройка по умолчанию при выключенном наследовании "с 00:00" до "23:59".
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-5-7" class="outline-4">
<h4 id="sec-5-5-7"><span class="section-number-4">5.5.7</span> <span class="todo TODO">TODO</span> Действия посетителя&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-5-7">
<p>
[TODO:pyub] - Кажется такие вещи надо описывать в <a href="#sec-5-1">Общий принцип работы</a> а более
подробно документировать в <a href="#sec-5-4">Состояния стойки при проезде</a>
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-5-7-0-1"></a>Машина посетителя уезжает не завершив процедуру проезда<br  /><div class="outline-text-6" id="text-5-5-7-0-1">
<p>
Все действия посетителя аннулируются. Стойка возвращается в исходное состояние
<code>finging</code>.
</p>
</div>
</li>

<li><a id="sec-5-5-7-0-2"></a><span class="todo TODO">TODO</span> Повторное прикладывание/некорректный билет&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-5-5-7-0-2">
<p>
Посетитель пытается приложить билет от другой парковки, или самостоятельно
сформированный билет. Дать ему по голове шлагбаумом?
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-5-8" class="outline-4">
<h4 id="sec-5-5-8"><span class="section-number-4">5.5.8</span> Сообщения переферийных устройств контроллеру</h4>
<div class="outline-text-4" id="text-5-5-8">
</div><ol class="org-ol"><li><a id="sec-5-5-8-1"></a><span class="todo TODO">TODO</span> Обработка ошибок в работе термопринтера на въезде (<code>printer-problem</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="unrimah">unrimah</span>&#xa0;<span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-5-8-1">
<p>
[TODO:unrimah] Добавить перечень возможных отказов и ошибок принтера VKP-80.
</p>

<p>
// Набросал, коды ошибок допилю как найду.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">индикация</th>
<th scope="col" class="right">число миганий</th>
<th scope="col" class="left">описание</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">зеленый</td>
<td class="right">1</td>
<td class="left">Прием данных (не ошибка)</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="left">Ошибка приема (parity, frame error, overrun error)</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="left">Команда не распознана</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">4</td>
<td class="left">Истекло время на прием команды</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">оранжевый</td>
<td class="right">2</td>
<td class="left">Перегрев печатающей термоголовки</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="left">Закончилась бумага</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">4</td>
<td class="left">Замятие бумаги</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">5</td>
<td class="left">Неверное напряжение блока питания</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">6</td>
<td class="left">Открыта крышка</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">красный</td>
<td class="right">3</td>
<td class="left">Ошибка RAM</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">4</td>
<td class="left">Ошибка EEPROM</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">5</td>
<td class="left">Ошибка автообрезчика</td>
</tr>
</tbody>
</table>

<p>
[TODO:rigidus] Написать код обработки.
</p>

<p>
[TODO:unrimah] [todo:ranma] - А как написать обработку, если я не знаю как софт может узнать
что с термопринтером что-то не так? Ранма, мне нужно что-то что скажет мне, что
принтеру кирдык, чтобы я смог это обработать. И еще надо подумать как это тестировать.
</p>

<p>
Термопринтер имеет собственный набор датчиков и перечень возможных возникающих
проблем и состояний о которых сообщениями сообщает контоллеру по RS-232.
</p>

<p>
Получение контроллером сообщения о проблеме должно всегда приводить к отправке стойкой
<code>сообщений на сервер</code>, в некоторых ситуациях блокировке работы принтера (<code>printer-error</code>)
или полному переводу стойки в <i>состояние блокировки (<code>lock</code>)</i>.
</p>

<p>
Только сообщение на сервер:
</p>
<ul class="org-ul">
<li>есть сигнал с оптодатчика контроля кол-ва бумаги о том, что бобина почти пуста.
</li>
</ul>

<p>
К <code>printer-off</code> приводит:
</p>
<ul class="org-ul">
<li>замятие бумаги;
</li>
<li>оптодатчикидатчики контроля презентера долго заняты;
</li>
<li>билет отправлен в сброс;
</li>
<li>кончилась бумага.
</li>
</ul>

<p>
Если на стойке включена(ы) библиотека(и) работы с картами СКУД (<code>emmarine-on</code>) или
транспондерами DSRC (<code>transponder-on</code>) то отключется только принтер (<code>printer-off</code>)
и возможен проезд по картам или транспондеру.
</p>

<p>
Если на стойке не включена ни одна из данных библиотек
(<code>emmarine-off</code> и/или <code>transponder-off</code>) - вместе с отключением принтера
стойка должна перейти в <i>состояние блокировки (<code>lock</code>)</i>.
</p>

<p>
На дисплей в любом состоянии выводится следующая информация:
1 строка: <code>сообщение текущего состояния стойки</code>
2 строка: DD.MM.YYYY HH:MM (текущая дата и время)
3 строка: Принтер неисправен
4 строка: работа только по картам.
</p>
</div>
</li>

<li><a id="sec-5-5-8-2"></a><span class="todo TODO">TODO</span> Повторное прикладывание использованного билета&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-5-5-8-3"></a><span class="todo START">START</span> Машина оказывается на датчике магнитной петли Б&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-5-5-8-4"></a><span class="todo TODO">TODO</span> Нажата кнопка "Печать билета"&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-5-5-8-5"></a><span class="todo TODO">TODO</span> Нажата кнопка "Вызов оператора"&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> <span class="todo TODO">TODO</span> Алгоритмы проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-5-6">
<p>
[TODO:pyub] - Необходимо описать основные отказы и их обработку
</p>
</div>

<div id="outline-container-sec-5-6-1" class="outline-4">
<h4 id="sec-5-6-1"><span class="section-number-4">5.6.1</span> Алгоритм простого въезда по чеку <code>barcode</code> <code>enter</code></h4>
<div class="outline-text-4" id="text-5-6-1">
<p>
Объявляем его как <code>barcode-enter</code>. В дальнейшем диспетчеризация поведения будет
происходить в зависимости как от алгоритма проезда, так и от текущего состояния
стойки. Однако чтобы давать уникальные ссылки на подразделы ниже мы включаем
идентификатор алгоритма в название раздела
</p>

<p>
Простой алгоритм для парковки, работающей по чекам со стандартным комплектом
датчиков (петли А,Б и фотоэлементы). В алгоритме введены светофор и счётчик мест
(светодиодное табло).
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-6-1-1"></a>Состояние выключенной стойки (<code>barcode</code> <code>enter</code> <code>selftest</code>)<br  /><div class="outline-text-5" id="text-5-6-1-1">
<p>
Здесь мы просто создадим модельную стойку в этом состоянии - этот код будет частью
теста на модели
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="test_make_checkpoint">(make-checkpoint <span style="color: #00cdcd; font-weight: bold;">:name</span> <span style="color: #cdcd00;">"1"</span> <span style="color: #00cdcd; font-weight: bold;">:state</span> <span style="color: #cdcd00;">":SELFTEST"</span>)
</pre>
</div>
</div>
</li>

<li><a id="sec-5-6-1-2"></a><span class="todo TODO">TODO</span> Состояние инициализации (<code>barcode</code> <code>enter</code> <code>poweron</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-6-1-2">
<p>
Что нужно сделать при инициализации
</p>
<ul class="org-ul">
<li>Сообщить серверу о себе
</li>
<li>Включить логгинг
</li>
<li>Прочитать конфигурацию
</li>
<li>Опросить устройства
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="checkpoint_trans_functions">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">power-on</span> ()
  <span style="color: #cdcd00; font-style: italic;">"selftest -&gt; poweron"</span>)
</pre>
</div>
</div>
</li>

<li><a id="sec-5-6-1-3"></a><span class="todo TODO">TODO</span> Состояние ожидания (<code>barcode-enter-standby</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="ranma">ranma</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-5-6-1-3">
<p>
[TODO:rigidus] Изменить исполняемую спецификацию в соотвествии с моими изменениями.
</p>

<p>
См. <i>Состояние ожидания (<code>standby</code>)</i>
</p>

<p>
Когда стойка находится в состоянии ожидания на дисплей выводится следующая
информация:
1 строка: Стойка въезда
2 строка: DD.MM.YYYY HH:MM (текущая дата и время)
3 строка: информация клиента
4 строка: информация клиента
</p>

<p>
[TODO:pyub &lt;- rigidus] - По этим строкам мне нужна информация, откуда брать стойку вьезда (1
строка) и информацию клиента (3 и 4 строка), будут ли у нас двухстрочные дисплеи,
что и как писать в полноцветный (если он будет в пилотке)
</p>

<p>
[TODO:ranma &lt;- rigidus] - Мне нужен способ обратиться к драйверу дисплея, чтобы передать ему
данные и убедиться что они получены. В простейшем варианте - кусок json-а и место,
в конфигурации, откуда я могу взять http-порт, где живет дисплей.
</p>

<p>
[TODO: &lt;- pyub] Я понял, что требуется. Сейчас засяду за описание блока вывода
информации, то что мы приняли как <code>UIDisplay</code>.
</p>

<p>
В данном состоянии замкнуто реле <code>Светофор сигнал 1</code> (<code>реле R4</code>) отвечающее за
зелёный сигнал светофора.
</p>

<p>
[TODO:ranma &lt;- rigidus] - как мне замкнуть это реле?
</p>

<p>
При нажатии на кнопку "Печать билета" (<code>кнопка B1</code>) на дисплей выводится информация:
1 строка: нет автомобиля.
</p>

<p>
Т.е. если машины нет на датчике А, то клиент не может сделать никаких действий -
при нажатии на кнопку печати билета или приложении пластиковой карты стойка
сообщает ему: "нет автомобиля"
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> push-button (<span style="color: #00cdcd; font-weight: bold;">:standby</span> button)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-detector button)))
    (send-message (display controller) <span style="color: #cdcd00;">"&#1040;&#1074;&#1090;&#1086;&#1084;&#1086;&#1073;&#1080;&#1083;&#1100; &#1085;&#1077; &#1086;&#1073;&#1085;&#1072;&#1088;&#1091;&#1078;&#1077;&#1085;"</span>)))
</pre>
</div>

<p>
При нажатии на <code>кнопку B2</code> "Вызов оператора" переходим к обработке процедуры <code>вызов по IP связи</code>.
</p>

<p>
При нажатии на <code>кнопку B3</code> "Разблокировка" - ничего не происходит (нет отказа).
Данная кнопка необходима при отказах:
</p>
<ul class="org-ul">
<li>при сбое принтера см. <i>Обработка ошибок в работе термопринтера</i>
</li>
</ul>

<p>
При нажатии на <code>кнопку B4</code> "Запрос выезда" переходим к процедуре <code>внешний запрос выезда</code>.
</p>

<p>
Когда машина подъезжает к стойке, срабатывает <code>датчик присутствия автомобиля А</code> перед
стойкой (сигнал на <code>сенсорый ввод S1</code>) и контроллер получает сигнал о том,
что машина перед стойкой. Контроллер переключается в состояние <code>finding</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> car-presence (<span style="color: #00cdcd; font-weight: bold;">:standby</span> detector)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-detector detector)))
    (trans controller <span style="color: #00cdcd; font-weight: bold;">:standby</span> <span style="color: #00cdcd; font-weight: bold;">:finding</span>)))
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-5-6-1-3-1"></a>Настройка: Выключена проверка датчика присутсвия автомобиля А<br  /><div class="outline-text-6" id="text-5-6-1-3-1">
<p>
См. <i>Выключить проверку датчика магнитной петли А</i> [TODO:pyub] - Не могу перейти по этой ссылке
</p>

<p>
Стойка автоматически автоматически переходит в <code>dialog</code>;
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> detector-a-disabled (<span style="color: #00cdcd; font-weight: bold;">:standby</span> detector)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-detector button)))
    (trans controller <span style="color: #00cdcd; font-weight: bold;">:standby</span> <span style="color: #00cdcd; font-weight: bold;">:dialog</span>)))
</pre>
</div>
</div>
</li></ol>
</li>

<li><a id="sec-5-6-1-4"></a><span class="todo TODO">TODO</span> Подьезд машины к стойке (<code>barcode-enter-finding</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-6-1-4">
<p>
[TODO:rigidus] Изменить исполянемую спецификацию в соотвествии с моими изменениями.
</p>

<p>
<i>Подъезд машины к стойке (<code>finding</code>)</i>
</p>

<p>
В данном случае имеем простой подъезд автомобиля.
</p>

<p>
При переключении в состояние <code>finding</code> происходят следующие действия:
</p>
<ul class="org-ul">
<li>размыкается <code>светофор сигнал 1</code> (<code>реле R4</code>), отвечающее за зелёный сигнал на светофоре
</li>
<li>замыкается <code>светофор сигнал 2</code> (<code>реле R5</code>), отвечающее за красный сигнал на светофоре
</li>
<li>на сервер отправляет <code>сообщение</code> "Машина у стойки въезда".
</li>
</ul>

<p>
Т.к. мы не можем проверить исполнение данных действий, автоматически переходим в
состояние <code>dialog</code> по факту отправки сигналов и сообщений.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="output_actions">(<span style="color: #00cdcd; font-weight: bold;">define-action</span> red-trafic-light (<span style="color: #00cdcd; font-weight: bold;">:standby</span> <span style="color: #00cdcd; font-weight: bold;">:finding</span> controller)
  (send-signal (trafic-light controller) <span style="color: #00cdcd; font-weight: bold;">:red</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-action</span> send-to-server-car-is-present (<span style="color: #00cdcd; font-weight: bold;">:standby</span> <span style="color: #00cdcd; font-weight: bold;">:finding</span> controller)
  (send-message (parent-server controller) <span style="color: #00cdcd; font-weight: bold;">:car-is-present</span>))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-6-1-5"></a><span class="todo TODO">TODO</span> Диалоговый режим (<code>barcode-enter-dialog</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-6-1-5">
<p>
См. <i>Стойка в диалоговом режиме (<code>dialog</code>)</i>
</p>

<p>
При переходе в состояние <code>dialog</code> контроллер переводит периферийные устройства в
режим обслуживания клиента:
</p>
<ul class="org-ul">
<li>включается подсветка кнопки печати билета (<code>кнопка B1</code>) замыкая реле подсветки (<code>реле R10</code>);
</li>
</ul>

<p>
Когда стойка находится в состоянии диалога на дисплей выводится следующая
информация:
1 строка: Нажмите кнопку для печати билета
2 строка: DD.MM.YYYY HH:MM (текущая дата и время)
3 строка (опция): информация клиента
4 строка (опция): инофрмация клиента
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="output_actions">(<span style="color: #00cdcd; font-weight: bold;">define-action</span> print-ticket-button-light-on (<span style="color: #00cdcd; font-weight: bold;">:finding</span> <span style="color: #00cdcd; font-weight: bold;">:dialog</span> controller)
  (send-signal (print-ticket-button controller) <span style="color: #00cdcd; font-weight: bold;">:on</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-action</span> show-display-press-button-and-get-ticket (<span style="color: #00cdcd; font-weight: bold;">:finding</span> <span style="color: #00cdcd; font-weight: bold;">:dialog</span> controller)
  (send-message (display controller) <span style="color: #cdcd00;">"&#1053;&#1072;&#1078;&#1084;&#1080;&#1090;&#1077; &#1082;&#1085;&#1086;&#1087;&#1082;&#1091; &#1080; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1077; &#1073;&#1080;&#1083;&#1077;&#1090;"</span>))
</pre>
</div>

<p>
Когда машина находится на магнитной петеле и стойка находится в состоянии
<code>finding</code>, но пользователем ещё не соверщены действия, инициирующие переход в состояние машина покидает зону действия датчика и стойка возвращается в
состояние <code>standby</code>
</p>

<p>
Клиент нажимает кнопку печати билета, сигнал с кнопки приходит на сенсорный вход
контроллера.
</p>

<p>
Контроллер получает сигнал и отправляет на принтер команду "напечатать билет с
необходимой информацией" (штрих-код, зашифрованный в соответствии с
предустановленным кодом; текущее время; номер терминала въезда; номер тарифной
зоны; предустановленную доп. информацию).
</p>

<p>
Пользователю на экран выводится предложение подождать.
</p>

<p>
[TODO:rigidus] - Тут нужен таймер с watch-догом. И для пользователя и для
принтера.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> ticket-printing (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> print-button)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-print-button print-button)))
    (send-message (display controller) <span style="color: #cdcd00;">"&#1056;&#1072;&#1089;&#1087;&#1077;&#1095;&#1072;&#1090;&#1099;&#1074;&#1072;&#1077;&#1090;&#1089;&#1103; &#1073;&#1080;&#1083;&#1077;&#1090;... &#1055;&#1086;&#1078;&#1072;&#1083;&#1091;&#1081;&#1089;&#1090;&#1072; &#1087;&#1086;&#1076;&#1086;&#1078;&#1076;&#1080;&#1090;&#1077;.."</span>)
    (send-command (printer contriller)
                  <span style="color: #00cdcd; font-weight: bold;">:print-ticket</span>
                  barcode
                  current-time
                  (terminal-number controller)
                  (tariff-zone controller)
                  additional-data)))
</pre>
</div>

<p>
Принтер печатает билет, его сенсоры контролируют состояние печати (возможно
замятие, окончание бумаги и т.п.).
</p>

<p>
[TODO:pyub] - Необходимо все возможные ситуации рассмотреть, вместе с их
последствиями, т.е. что делаем в каждом из случаев.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="ticket_printing_emergency">(<span style="color: #00cdcd; font-weight: bold;">define-emergency-event</span> paper-jam (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> printer)
  (TODO))

(<span style="color: #00cdcd; font-weight: bold;">define-emergency-event</span> paper-over (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> printer)
  (TODO))
</pre>
</div>

<p>
Если печать завершена успешно - билет находится в презентере и контроллер должен
сам вызывать событие <code>printing-completed-successfully</code>
</p>

<p>
В обработчике этого события Контроллер блокирует периферию, защищая систему от
повторного получения въездного документа. На дисплей выводится сообщение
"Забирите билет".
</p>

<p>
В этом же обработчике устанавливается Watchdog timer на несколько секунд, который
вызовет событие <code>get-ticket-watchdog-timer-over</code> если клиент не заберет билет в
течении этого времени.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> printing-completed-successfully (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> controller ticket)
  <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1042;&#1099;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; &#1087;&#1086;&#1076;&#1089;&#1074;&#1077;&#1090;&#1082;&#1091; &#1082;&#1085;&#1086;&#1087;&#1082;&#1080;</span>
  (send-signal (print-ticket-button controller) <span style="color: #00cdcd; font-weight: bold;">:off</span>)
  <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1042;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1101;&#1082;&#1088;&#1072;&#1085;</span>
  (send-message (display controller) <span style="color: #cdcd00;">"&#1047;&#1072;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1073;&#1080;&#1083;&#1077;&#1090;"</span>)
  <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1090;&#1072;&#1081;&#1084;&#1077;&#1088;</span>
  (set-watchdog 5 #'get-ticket-watchdog-timer-over ticket))
</pre>
</div>

<p>
Если билет не забран из презентера клиентом более t секунд - принтер сообщает об
этом контроллеру, контроллер отбивает ошибку на сервер и анулирует билет.
</p>

<p>
Это еще не все, я правильно понимаю, что надо перевести стойку в режим <code>finding</code>?
Да.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> get-ticket-watchdog-timer-over (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> controller ticket)
  (reset-watchdog get-ticket-watchdog-timer-over)
  (send-message (parent-server controller) <span style="color: #00cdcd; font-weight: bold;">:get-ticket-watchdog-timer-over</span>)
  (ticket-cancel ticket))
</pre>
</div>

<p>
Если клиент забирает билет из презентера, принтер сообщает об этом контроллеру,
вызывая событие <code>get-printed-ticket-successfully</code>. Контроллер сообщает на сервер
о том, что билет напечатан и прикладывает сам билет, а затем переходит в
следующее состояние
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> get-printed-ticket-successfully (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> controller ticket)
  (reset-watchdog get-ticket-watchdog-timer-over)
  (send-message (parent-server controller) <span style="color: #00cdcd; font-weight: bold;">:get-ticket-watchdog-timer-over</span> ticket)
  (trans controller <span style="color: #00cdcd; font-weight: bold;">:dialog</span> <span style="color: #00cdcd; font-weight: bold;">:init</span>))
</pre>
</div>

<p>
[TODO:pyub] - Необходимо знать, что происходит, когда сервер получает все эти
сообщения от контроллера.
</p>
</div>
</li>

<li><a id="sec-5-6-1-6"></a><span class="todo TODO">TODO</span> Инициация проезда (<code>barcode-enter-init</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-6-1-6">
<p>
При переходе в состояние <code>init</code> контроллер замыкает реле, отвечающее за открытие
шлагбаума за стойкой (реле замкнуто либо до прихода на сенсорный ввод сигнала
"открыт", либо по длине импульса из настроек контроллера)
</p>

<p>
Как разделять эти два инварианта? Галочкой в настройках
</p>

<p>
Контроллер сообщает серверу "Открытие шлагбаума стойки №"
</p>

<p>
Если у нас нет концевика, то ставим watchdog на открытие шлагбаума
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="output_actions">(<span style="color: #00cdcd; font-weight: bold;">define-action</span> barrier-open (<span style="color: #00cdcd; font-weight: bold;">:dialog</span> <span style="color: #00cdcd; font-weight: bold;">:init</span> controller)
  (send-signal (barrier controller) <span style="color: #00cdcd; font-weight: bold;">:open</span>)
  (send-message (parent-server controller) <span style="color: #00cdcd; font-weight: bold;">:barrier-open</span> controller)
  (<span style="color: #00cdcd; font-weight: bold;">if</span> barrier-limit-switch-not-present
      (set-watchdog 5 #'barrier-open-confirm)))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-6-1-7"></a><span class="todo TODO">TODO</span> Процедура проезда (<code>barcode-enter-goon</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-6-1-7">
<p>
Когда стрела шлагбаума открывается, в шлагбауме срабатывает концевик открытия -
сигнал с него приходит на сенсор "открытие" контроллера. Если концевика нет, то мы
генерируем его срабатывание по таймеру, запущенному в <code>barrier-open</code>
</p>

<p>
Контроллер фиксирует факт того, что шлагбаум в открытом положении и совершает
следующие действия:
</p>
<ul class="org-ul">
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>сообщает серверу "Шлагбаум стойки № открыт"
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> barrier-open-confirm (<span style="color: #00cdcd; font-weight: bold;">:goon</span> controller)
  (send-signal (trafic-light controller) <span style="color: #00cdcd; font-weight: bold;">:green</span>)
  (send-message (parent-server controller) <span style="color: #00cdcd; font-weight: bold;">:barrier-open-confirm</span> controller))
</pre>
</div>

<p>
Когда машина пересекает линию фотоэлемента безопасности (стрелы шлагбаума) с
фотоэлемента приходит сигнал на сенсор. Контроллер, имея сигнал с ф/э безопасности
на сенсор, переходит в режим "автомобиль в воротах" - пока проезд не освобождён стрела шлагбаума
не должна закрыться.
</p>

<p>
Правильно ли я понимаю, что мы в этот момент должны включить красный сигнал
светофора? Да, с момента пересечения стрелы. Так же арбитраж на другую сторону.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> car-in-gate (<span style="color: #00cdcd; font-weight: bold;">:goon</span> controller)
   (trans controller <span style="color: #00cdcd; font-weight: bold;">:goon</span> <span style="color: #00cdcd; font-weight: bold;">:ingate</span>))
</pre>
</div>

<p>
Машина проезжает шлагбаум, с сенсорного устройства за его стрелой (контроллер
петли индуктивности, фотоэлемент, датчик МП) на контроллер отправляется
сигнал. Контроллер получает подтверждение завершения проезда и начинает
соответствующую процедуру.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> car-out-of-gate (<span style="color: #00cdcd; font-weight: bold;">:ingate</span> controller)
   (trans controller <span style="color: #00cdcd; font-weight: bold;">:ingate</span> <span style="color: #00cdcd; font-weight: bold;">:fin</span>))
</pre>
</div>
</div>
</li>

<li><a id="sec-5-6-1-8"></a><span class="todo TODO">TODO</span> Процедура завершения проезда (<code>barcode-enter-fin</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span><br  /><div class="outline-text-5" id="text-5-6-1-8">
<p>
Мы считаем, что машина покинула ворота (место проезда) тогда, когда:
</p>
<ul class="org-ul">
<li>фотоэлемент не регистрирует машину под шлагбаумом
</li>
<li>от сенсора за шлагбаумом пришел сигнал, что машина за шлагбаумом
</li>
</ul>

<p>
Все это вместе вызовет событие <code>car-out-of-gate</code>. Получив это событие, мы перейдем
в состояние <code>fin</code> и контроллер сделает следующие действия:
</p>

<ul class="org-ul">
<li>размыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за закрытие шлагбаума за стойкой (реле замкнуто либо
до прихода на сенсорный ввод сигнала "закрыт" с концевика, либо по длине
импульса из настроек контроллера)
</li>
<li>сообщает серверу "проезд по билету № успешно завершен", а также об изменении
количества мест в секторе и данные по билету
</li>
<li>отправляет на табло счётчика мест по RS-485 сообщение "-1 место"
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">TODO
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-5-6-1-8-1"></a>Получив сигнал с концевика закрытия на сенсор контроллер:<br  /><div class="outline-text-6" id="text-5-6-1-8-1">
<ul class="org-ul">
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>возвращает стойку в режим ожидания <code>standby</code>.
</li>
</ul>
</div>
</li></ol>
</li>

<li><a id="sec-5-6-1-9"></a><span class="todo TODO">TODO</span> Cостояние блокировки (<code>barcode-enter-lock</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-5-6-1-9">
<p>
Состояние, в которое переходит стойка в случае некорректной работы критичного для
функционирования системы (или подсистемы) опросного <i>периферийного устройства</i>.
</p>

<p>
[TODO:pyub] - Не могу перейти по этой ссылке.
</p>

<p>
Для стоек, на которых нет торгового оборудования (т.е.работы с деньгами)
блокировка должна быть частичной. Например, если заканчивается бумага в
термопринтере, выводится сообщение о том, что "Печать билета невозможна,
обратитесь к персоналу парковки", но при этом въезд по пластиковым билетам
(картам) для постоянных клиентов по врежнему возможен.  В случае возникновения
ситуации блокировки стойка регулярно отправляеет на сервер сервисное сообщение о
том, что она работает в нештатном режиме и требуется произвести змену бумаги /
ремонт устрйоства.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-6-2" class="outline-4">
<h4 id="sec-5-6-2"><span class="section-number-4">5.6.2</span> <span class="todo TODO">TODO</span> Алгоритм простого выезда по чеку&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-6-2">
<p>
[TODO:pyub] - Надо описать по нормальному, так же как выше описан вьезд.
</p>

<p>
Простейший алгоритм для парковки, работающей по чекам с стандартным комплектом
датчиков и контроля проезда. В алгоритм введены светофор и счётчик мест
(светодиодное табло).
</p>

<ol class="org-ol">
<li><code>Подъезд машины</code>
</li>
</ol>
<p>
1.1. Машина подъезжает к стойке, с сенсорного устройства у стойки (контроллер петли
индуктивность, фотоэлемент и т.п.) на контроллер отправляется сигнал.
1.2. Контроллер получает сигнал о том, что у стойки находится машина и из режима
ожидания переховодит стойку в активный режим.  1.3. Замыкается реле, отвечающее за
красный сигнал на светофоре.  1.4. На сервер отправляет инфосообщение "Машина у
стойки выезда".
</p>
<ol class="org-ol">
<li><code>Активный режим (диалог с пользователем)</code>
</li>
</ol>
<p>
2.1. Контроллер переводит периферийные устройства в режим обслуживания клиента:
</p>
<ul class="org-ul">
<li>активируется широкополосный сканер штрих-кода;
</li>
<li>на дисплей выдаётся информационное сообщение "Поднесите билет".
</li>
</ul>
<p>
2.2. Клиент подносит билет штрих-кодом к сканеру, данные по RS232 или USB передаются на контроллер.
2.3. Контроллер  расшифровывает с помощью ключа шифрования (аналогичный стоит на въезде и кассах) штрих-код, получая из него информацию об оставшемся бесплатном времени (со времени въезда или времени оплаты). Он решает, исходя из заложенных в себя тарифов и параметров времени, разрешёен въезд или требуется оплата времени. см. "ПРОВЕРКА РАЗРЕШЕНИЯ ВЫЕЗДА"
2.4. Исходя из результатов проверки контроллер выводит на дислпей сообщение "Выезд разрешён" или "Выезд запрещён, оплатите $$$ руб".
2.5. Если выезд запрещён, контроллер блокирет перифирию до
     окончания процедуры завершения проезда (<code>fin</code>), защищая систему от повторного прикладывания чека.
2.6. Контроллер сообщает на сервер "Выезд по билету №".
</p>
<ol class="org-ol">
<li><code>Инициация проезда</code>
</li>
</ol>
<p>
3.1. Контроллер получает положительный ответ от внутренних и внешних механизмов проверки оплаты билета и инициирует процедуру проезда.
3.2. Контроллер  замыкает реле, отвечающее за открытие шлагбаума  за стойкой (реле замкнуто либо до прихода на сенсорный ввод сигнала "открыт", либо по длине импульса из настроек контроллера)
3.3. Контроллер сообщает серверу "Открытие шлагбаума стойки №"
</p>
<ol class="org-ol">
<li><code>Процедура проезда</code>
</li>
</ol>
<p>
4.1. Когда стрела шлагбаума открывается, в шлагбауме срабатывает концевик открытия - сигнал с него приходит на сенсор "открытие" контроллера
4.2. Контроллер фиксирует факт того, что шлагбаум в открытом положении совершаются следующие действия:
</p>
<ul class="org-ul">
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>сообщает серверу "Шлагбаум стойки № открыт"
</li>
</ul>
<p>
4.3. Когда машина пересекает линию фотоэлемента безопасности (стрелы шлагбаума) с ф/э приходит сигнал на сэнсор.
4.4. Контроллер, имея сигнал с ф/э безопасности на сенсор, переходит в режим "стоп" - пока сенсор не освобождён стрела шлагбаума не должна закрыться.
4.5. Машина проезжает шлагбаум,  с сенсорного устройства за его стрелой (контроллер петли индуктивности, фотоэлемент, датчик МП) на контроллер отправляется сигнал.
4.6. Контроллер получает подтверждение завершения проезда и начинает соответсвующую процедуру.
</p>
<ol class="org-ol">
<li><code>Процедура завершения проезда</code>
</li>
</ol>
<p>
5.1. Получив подтверждение окончания проезда - нет сигнала на сенсор безопасности проезда и на сенсор петли за шлагбаумом - контроллер инициирует следующеи действия:
</p>
<ul class="org-ul">
<li>размыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за закрытие шлагбаума за стойкой (реле замкнуто либо до прихода на сенсорный ввод сигнала "закрыт" с концевика, либо по длине импульса из настроек контроллера)
</li>
<li>сообщает серверу "выезд по билету № успешно завершен", а также об изменении количества мест в секторе и данные по билету
</li>
<li>отправляет на табло счётчика мест по RS-485 сообщение "+1 место"
</li>
</ul>
<p>
5.2. Получив сигнал с концевика закрытия на сенсор контроллер:
</p>
<ul class="org-ul">
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>возвращает стойку в режим ожидания;
</li>
<li>сообщает на сервер о закрытии шлагбаума.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-6-3" class="outline-4">
<h4 id="sec-5-6-3"><span class="section-number-4">5.6.3</span> <span class="todo TODO">TODO</span> Алгоритм проезда по карте СКУД&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-6-3">
<p>
[TODO:pyub] - Надо описать по нормальному, так же как выше описан вьезд.
</p>

<p>
Карты СКУД формата Em-Marine могут использоваться параллельно с билетами или картами
Mifare (основным въездным документом). Они вносятся в базу данных администратором
парковки и имеют ряд опций и статусов о которых подробнее будет написано в описании
модуля СКУД. Если пользователь вместо нажатия кнопки выдачи въездного документа
прикладывает карту СКУД и она проходит успешно проверки - это действие является
инициирующим проезд.
</p>

<p>
2.1. Контроллер переводит периферийные устройства в режим обслуживания клиента:
</p>
<ul class="org-ul">
<li>включается подсветка кнопки печати билета;
</li>
<li>на дисплей выдаётся информационное сообщение "Нажмите кнопку и получите билет ИЛИ ПРИЛОЖИТЕ КАРТУ".
</li>
</ul>
<p>
2.2. Клиент прикладывает карту к считывателю карт. Сигнал со считывателя Em-Marine приходит на интерфейс Wiegand 26.
2.3. Контроллер получает сигнал о том, что приложена карат имеющая номер NNNNNNNN.
2.4. Контроллер отправляет запрос на проверку статуса карты на сервер. Сервер обрабатывает запрос и возвращает контроллеру информацию о статусе карты:
</p>
<ul class="org-ul">
<li>"есть в БД" / "нет в БД" ;
</li>
<li>"на парковке" / "вне парковки";
</li>
<li>"заблокирована" / "активна";
</li>
<li>"есть места для данной группы" / "нет мест для данной группы".
</li>
</ul>
<p>
2.5. Контроллер получает ответ от сервера и на его основании решает - пускать ли владельца карты на парковку или нет.
2.6. Если сигнала связи с сервером нет, то контроллер проверяет
свою БД и опрашивает другие контроллеры, которые видит в
сети. Решение принимается на базе самой новой из доступных записей
о статусе карты. Тут у нас была мысль поддерживать такую же логику
работы, которой руководствуется гит при слиянии коммитов. [TODO:pyub] <code>продумать поведение при обрыве связи</code>
2.8. Если въезд разрешён, контроллер инициирует процедуру проезда.
2.9. На сервер отправляет инфосообщение "Приложена карта NNNNNNNN, выезд разрешен".
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> <span class="todo WAIT">WAIT</span> Усложнения алгоритмов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-5-7">
<p>
[TODO:pyub] - Надо это все преобразовать и описать в разделе "Описание
функциональности" - "Состояния стойки при проезде" - в соответствующих разделах где
применяются эти усложнения
</p>
</div>

<div id="outline-container-sec-5-7-1" class="outline-4">
<h4 id="sec-5-7-1"><span class="section-number-4">5.7.1</span> <span class="todo TODO">TODO</span> Проезд по шлюзу / рампе</h4>
<div class="outline-text-4" id="text-5-7-1">
<p>
Изменения касаются процедуры подъезда, всё начинается не с датчика присутствия у
стойки, а с датчика в начале "шлюза" из двух шлагбаумов - одного в начале участка
подъезда к стойке по рампе, второго - за стойкой. В данном решении присутсвуют три
датчика присутвия - на начале шлюза, у стойки и за стрелой, а также фотоэлемент на
линии стрелы.
</p>

<p>
1.1. Машина начинает заезд на рампу, с сенсорного устройства в начале рампы (контроллер петли индуктивность, фотоэлемент и т.п.) на контроллер отправляется сигнал.
1.2. Контроллер получает сигнал о том, что начат проезд рампы и переходит в режим ожидания освобождения сенсора.
1.3. Машина начинает подъём по рампе,  сигнал с сенсорного устройства прекращается (оно остаётся позади машины).
1.4. Контроллер фиксирует прекращение сигнала и блокирует рампу:
</p>
<ul class="org-ul">
<li>замыкает реле, отвечающее за закрытие шлагбаума №1, находящегося в начале рампы;
</li>
<li>замыкает реле, отвечающее за красный свет на светофоре в начале рампы;
</li>
<li>отправляет на сервер инфосообщение "Рампа занята".
</li>
</ul>
<p>
1.5. Машина подъезжает к стойке,  с сенсорного устройства у стойки (контроллер петли индуктивность, фотоэлемент и т.п.) на контроллер отправляется сигнал.
1.6. Контроллер получает сигнал о том, что у стойки находится машина и инициирует процедуру инициации проезда.
1.7. На сервер отправляет инфосообщение "Машина у стойки въезда".
5.3. Контроллер открывает шлагбаум в начале рампы, зажигает зелёный свет на светофоре в начале рампы.
5.4. На сервер отправляется сообщение "Рампа свободна".
</p>
</div>
</div>

<div id="outline-container-sec-5-7-2" class="outline-4">
<h4 id="sec-5-7-2"><span class="section-number-4">5.7.2</span> <span class="todo WAIT">WAIT</span> Фотофиксация въезда</h4>
<div class="outline-text-4" id="text-5-7-2">
<p>
В пилотнике не надо
</p>

<p>
Опциональное действие, которое может совершаться параллельно с любым действием
контроллера (выбирается в настрйоках контроллера). В процессе фотофиксации камера
(или камеры), IP которой указан в настройках контролера, получает запрос на
фотографирование, после чего возвращает контроллеру фото, которое сохраняетя им на
SD носитель.
</p>
</div>
</div>

<div id="outline-container-sec-5-7-3" class="outline-4">
<h4 id="sec-5-7-3"><span class="section-number-4">5.7.3</span> <span class="todo WAIT">WAIT</span> Звуковое сопровождение</h4>
<div class="outline-text-4" id="text-5-7-3">
<p>
В пилотном проекте не реализуем, но - задел на будущее
</p>

<p>
Опциональное действие, которое может совершаться параллельно с выводом сообщений на
дисплей, дублируя их аудиозаписями, лежащими на SD носители. Данные аудиофайлы
должны загружаться и сопоставляться с текстовыми сообщениями через интерфейс
настройки контроллера.
</p>

<p>
В пилотнике не надо
</p>

<p>
Опциональное действие, которое может соврешаться параллельно с
выводом сообщений на дисплей, дублируя их аудиозаписями, лежащими
на SD носители. Данные аудиофайлы должны загружаться и
сопоставляться с текстовыми сообщениями через интерфейс настройки
контроллера.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8"><span class="section-number-3">5.8</span> <span class="todo TODO">TODO</span> Алгоритмы работы с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-5-8">
</div><div id="outline-container-sec-5-8-1" class="outline-4">
<h4 id="sec-5-8-1"><span class="section-number-4">5.8.1</span> <span class="todo TODO">TODO</span> Работа с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-8-1">
<p>
АЛГОРИТМЫ СКОПИРОВАНЫ ИЗ ПАСПОРТА КАССЫ, В ПРОЦЕССЕ ДОРАБОТКИ
</p>
</div>
</div>

<div id="outline-container-sec-5-8-2" class="outline-4">
<h4 id="sec-5-8-2"><span class="section-number-4">5.8.2</span> <span class="todo TODO">TODO</span> Процедура оплаты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-8-2">
<p>
Это последовательность действий посетителя и оператора парковки
при проведении оплаты через автоматическую кассу.
</p>

<ol class="org-ol">
<li>Посетитель находится у кассы.
</li>
</ol>
<p>
1.1. Подносит неоплаченный въездной билет или просроченный выездной чек к сканеру штрих-кода.
1.2. Если посетитель потерял въездной билет или выездной чек, то он должен нажать кнопку "Оплата за утерю билета" (точная формулировка может отличаться).
</p>
<ol class="org-ol">
<li>На дисплее выводится информация о необходимых операциях.
</li>
</ol>
<p>
2.1. В случае, если бесплатное или ранее оплаченное время ещё не истекло, на дисплей будет выведена информация об оставшемся времени нахождения на парковке.
2.2. Если посетитель пробыл на парковке больше установленного бесплатного времени и не провёл оплату на другой кассе или производит оплату за утерю билета, система рассчитает сумму, требуемую к оплате, исходя из установленных для стойки тарифов, выведет на дисплей информацию о необходимости и размере платежа и активирует платёжное оборудование.
</p>
<ol class="org-ol">
<li>Посетитель оплачивает услуги АПС наличными через купюроприемник (банкноты номиналом 50, 100, 500, 1000 и 5000 руб.; мод. К, БК, КМ, БКМ), монетоприёмник (монеты номиналом 1, 2, 5 и 10 руб., мод. М, КМ, БМ, БКМ) или банковской карточкой (мод. Б, БК, БМ, БКМ).
</li>
</ol>
<p>
3.1. Если оплата производится купюрами или монетами, и при внесении платежа была совершена ошибка, возможно вернуть деньги нажав кнопку "Возврат денег".
3.2. Если оплата производится монетами, и при внесении платежа монету заклинило в монетоприёмнике, необходимо нажать на кнопку "Сброс монеты" под прорезью для монет.
3.3. Если оплата производится с помощью банковской карты, то для активации POS-терминала необходимо нажать кнопку "Оплата картой".
</p>
<ol class="org-ol">
<li>После оплаты касса выдаёт выездной чек и, в случае, если посетитель оплатил наличными и сумма вносимых средств превысила требуемую, сдачу. При этом на мониторе отображается оставшееся время, в соответствии с установленными тарифами, в течение которого посетитель должен покинуть парковку.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-5-8-3" class="outline-4">
<h4 id="sec-5-8-3"><span class="section-number-4">5.8.3</span> <span class="todo TODO">TODO</span> Процедура инкассации&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-8-3">
<ol class="org-ol">
<li>Запросить "Х-отчет" и забрать чек. п. 3 и п. 4 только для модификаций с купюрами (К, БК, КМ, БКМ)
</li>
<li>Изъять банкнотную наличность.
</li>
</ol>
<p>
3.1. Снять бокс купюроприёмника
3.2. Изъять купюры из бокса или взять пустой бокс купюроприёмника
3.3. Установить пустой бокс купюроприемника на место.
</p>
<ol class="org-ol">
<li>Восполнить банкнотную наличность для сдачи.
</li>
</ol>
<p>
4.1. Снять кассеты диспенсера с купюрами сдачи и кассету "Отказ".
4.2. Заполнить кассеты купюрами или взять предварительно заполненные сдачей новые кассеты. Изъять неликвидные купюры из кассеты "Отказ".
4.3. Установить кассеты на место.
</p>
<ol class="org-ol">
<li>Провести инкассацию и закрыть смену.
</li>
</ol>
<p>
5.1. Нажать кнопку "Инкассация" и забрать чек с данными об инкассации. п. 6 и п. 7 только для модификаций с монетами (М, КМ, БМ, БКМ)
</p>
<ol class="org-ol">
<li>Изъять полученные монеты из специального металлического ящика.
</li>
<li>После нажатия "Инкассации" выполнить перезагрузку сдачи в хопперы.
</li>
</ol>
<p>
7.1. Хопперы автоматически поочерёдно осуществят сброс всех не
     выданных в качестве сдачи монет в окно выдачи сдачи или в
     предварительно размещённую под желобами для монет ёмкость.
7.2. Загрузите в хопперы сдачу в соответствии с установленным по умолчанию количеством сдачи. п. 8 только для модификаций с банковскими картами (Б, БК, БМ, БКМ)
</p>
<ol class="org-ol">
<li>После нажатия "Инкассации" POS-терминал обменивается данными с банком, после чего в чек инкассации включается отчёт об эквайринговых операциях.
</li>
<li>Если на дисплее отображается надпись "Заблокировано", необходимо нажать кнопку "Разблокировка", после чего будет напечатан тестовый чек и выведена надпись "Поднесите штрих-код или карту".
</li>
<li>Закрыть дверь кассы.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-5-8-4" class="outline-4">
<h4 id="sec-5-8-4"><span class="section-number-4">5.8.4</span> <span class="todo TODO">TODO</span> Процедура закрытия смены&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-8-4">
<p>
Почитать про кассовый регламент, что такое Z-отчет
</p>

<ol class="org-ol">
<li>Запросить "Z-отчет", закрыть фискальную смену и забрать чек. Сверить суммы прибыли с чеками инкассаций и фактической прибылью.
</li>
<li>Новая смена открывается автоматически при следующей оплате.
</li>
<li>Если на дисплее отображается надпись "Заблокировано", необходимо нажать кнопку "Разблокировка", после чего будет напечатан тестовый чек и выведена надпись "Поднесите штрих-код или карту".
</li>
<li>Закрыть кассу.
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-5-9" class="outline-3">
<h3 id="sec-5-9"><span class="section-number-3">5.9</span> <span class="todo TODO">TODO</span> Роли пользователей системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-5-9">
<p>
Описание ролей пользователей системы в рамках общего принципа функционирования.
</p>
</div>

<div id="outline-container-sec-5-9-1" class="outline-4">
<h4 id="sec-5-9-1"><span class="section-number-4">5.9.1</span> Суперадминистратор (root)</h4>
<div class="outline-text-4" id="text-5-9-1">
<p>
<code>Суперадминистратор</code> (<code>root</code>) - это сертифицированный обученный специалист
производителя или подрядчика, который может осуществлять первичное конфигурирование
и отладку контроллеов и установку дополнительных модулей на сервер. У него есть
доступ ко всем функциям остальных пользователей системы и описанные ниже
дополнительные возможности.
</p>

<p>
В <i>web-интерфейсе настройки контроллера</i> <code>root</code> может:
</p>
<ul class="org-ul">
<li>устанавливать библиотеки переферийного оборудования
</li>
<li>устанавливать библиотеки, связанные с доп. функциями парковки
</li>
<li>разрешать/запрещать/конфигурировать удалённый доступ к контроллеру через SSH
</li>
<li>иметь доступ к SSH консоли из web-интерфейса
</li>
<li>производить обновление ПО, работать с удалёнными репозиториями обновлений и
библиотек
</li>
<li>производить диагностику, отладку и имитациою операций с финансовыми устройствами
подробнее: <i>Тестирование и диагностика из web-интерфейса контроллера</i>
</li>
</ul>

<p>
На <i>web-интерфейсе сервера</i> <code>root</code> может:
</p>
<ul class="org-ul">
<li>конфигурировать интерфейсы остальных групп пользователей
</li>
<li>устанавливать библиотеки и модули, связанные с доп. функциями работы парковки
(по факту их продажи клиенту)
</li>
<li>разрешать / запрещать / конфигурировать удалённый доступ к серверу через SSH
</li>
<li>иметь доступ к SSH консоли сервера из web-инетрфейса
</li>
<li>ПО, работать с удалёнными репозиториями обновлений и библиотек
</li>
<li>осуществлять связь серверов друг с другом, настраивать каскады серверов,
связывать их с системой биллинга
</li>
<li>конфигурировать части системы, связанные с интеграцией с другими системами
</li>
</ul>

<p>
Доступ root должен быть ограничен паролем и, в идеале, ещё чем-то. Ключевым
файлом, SSH сертификатом и т.п.
</p>
</div>
</div>

<div id="outline-container-sec-5-9-2" class="outline-4">
<h4 id="sec-5-9-2"><span class="section-number-4">5.9.2</span> Администратор (admin)</h4>
<div class="outline-text-4" id="text-5-9-2">
<p>
<code>Администратор</code> cистемы - это сотрудник клиента, владеющего парковочной системой,
отвечающий за настройку и функционирование систмы и производяший конечную настройку
системы непосредственно по факте эксплуатации решения.
</p>

<p>
В <i>web-интерфейсе настройки контроллера</i> <code>администратор</code> может:
</p>
<ul class="org-ul">
<li>отслеживание логов событий контроллера
</li>
<li>конфигурирование настроек LAN контроллера
</li>
<li>производить <i>настройки администратора из web-интерфейса контроллера</i>,
конфгурировать работу установленного и подключённого переферийного оборудования
</li>
<li>производить диагностику, отладку и имитацию работы сенсоров, реле и переферийного
оборудования кроме торгового оборудования (<i>тестирование и диагностика из web-интерфейса контроллера</i>)
</li>
<li>подключать или отключать стойки от общения, обмена данными и тарифами с видимыми им серверами
</li>
<li>управлять временем, информацией, выводимой на дисплей стоек и печатаемой на чеках
</li>
</ul>

<p>
Доступ администратора к настройкам оборудования определяется установленными
пользователем <code>root</code> библиотеками.
</p>

<p>
Весь функционал web-интерфейса контроллера должен быть также доступен через общий
web-интерфейс сервера (выбор стойки -&gt; настройка)
</p>

<p>
На <i>web-интерфейсе сервера</i> <code>администратор</code> может:
</p>
<ul class="org-ul">
<li>отслеживать все логи о работе парковки в целом, создавать выгрузки и отчёты
истории событий
</li>
<li>получать информацию о настрйоках и состоянии всех стоек, терминалов и касс, находящихся в
локальной сети и подключенных к серверу
</li>
<li>изменять IP-адреса, ключей шифрования, номера подключённых стоек
</li>
<li>управлять пользователями, создавая и удаляя их, разнося по созданным <code>root</code>
      группам доступа к страницам интерфейса
</li>
<li>управлять секторами парковки и тарифными зонами, временем работы парковки,
тарифными сетками
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-9-3" class="outline-4">
<h4 id="sec-5-9-3"><span class="section-number-4">5.9.3</span> <span class="todo TODO">TODO</span> Оператор&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-9-3">
<p>
<code>Оператор</code> - это человек из обслуживающего персонала парковки, который
отвечает за некую определённую сферу функционирования системы и следит за ней в
процессе эксплуатации.
</p>

<p>
Имеет доступ к системе только через <i>web-интерфейс сервера</i> или через отдельную утилиту.
</p>

<p>
Можно выделить несколько основных функций операторов (они могут быть совмещены или разделены).
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-9-3-1"></a>Парковщик (parker)<br  /><div class="outline-text-5" id="text-5-9-3-1">
<p>
Парковщик должен иметь следующие возможности:
</p>
<ul class="org-ul">
<li>открытие и закрытие шлагбаумов, подключённых к стойкам, находящимся в локальной сети.
</li>
<li>управление количеством свободных мест на парковке.
</li>
<li>мониторинг информации, приходящей со стоек (лога) в режиме реального времени.
</li>
</ul>
</div>
</li>

<li><a id="sec-5-9-3-2"></a>Кассир (casher)<br  /></li>
<li><a id="sec-5-9-3-3"></a>СКУД<br  /></li></ol>
</div>
<div id="outline-container-sec-5-9-4" class="outline-4">
<h4 id="sec-5-9-4"><span class="section-number-4">5.9.4</span> Бухгалтер</h4>
<div class="outline-text-4" id="text-5-9-4">
<p>
<code>Бухглатер</code> - это человек из обслуживающего персонала парковки, отвечающий за
работу финансовой системы, установку тарифов, проведение инкассаций, соблюдение и
выполнение кассового порядка и т.д. Иногда роль совмещена с ролью
<code>оператора-кассира</code>.
</p>

<p>
Имеет доступ к системе только через <i>web-интерфейс сервера</i> или через отдельную
утилиту.
</p>
</div>
</div>

<div id="outline-container-sec-5-9-5" class="outline-4">
<h4 id="sec-5-9-5"><span class="section-number-4">5.9.5</span> Посетитель парковки</h4>
<div class="outline-text-4" id="text-5-9-5">
<p>
<code>Посетитель</code> - это клиент парковки, который оставляет своё транспортное средство на
её территории. Он взаимодействует с системой с помощью интерфейсов стоек и касс,
либо через персонал парковки.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Этапы, сроки, задачи</h2>
<div class="outline-text-2" id="text-6">
<p>
Список текущих задач. По факту завершения задачи обязательно закрывать её в статус DONE,
писать сопроводительную записку и переносить весь подраздел задачи с описанием в
соотвествующий данной задаче раздел документации.
</p>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> <span class="todo TODO">TODO</span> Этапы и сроки</h3>
<div class="outline-text-3" id="text-6-1">
</div><div id="outline-container-sec-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> Пилотный функционал (до 1 марта 2016)</h4>
<div class="outline-text-4" id="text-6-1-1">
</div><ol class="org-ol"><li><a id="sec-6-1-1-1"></a>Рабочий вьезд/выезд по билетам и картам СКУД<br  /><div class="outline-text-5" id="text-6-1-1-1">
<p>
В рамках пилотного проекта нам необходимо реализовать следующий комплект оборудования стойки:
<i>Въездная / выездная стойка с выдачей бумажного билета, СКУД и IP-связью</i>
</p>

<p>
Для стойки должны работать следующие базовые алгаритмы работы парковки:
<i>Алгоритм простого въезда по чеку</i>
<i>Алгоритм простого выезда по чеку</i>
<i>Алгоритм проезда по карте СКУД</i>
</p>

<p>
Для стоек въезда и выезда должен быть реализован базовый интерфейс и <i>настройки администратора из web-интерфейса контроллера</i>
</p>
</div>
</li>

<li><a id="sec-6-1-1-2"></a>Базовый интерфейс сервера<br  /><div class="outline-text-5" id="text-6-1-1-2">
<p>
В рамках пилотного проекта должен быть базовый UI сервера: <i>Web-интерфейс сервера</i>
Необходимо сделать возможность удалённого управления шлагбаумами для оператора,
просмотра логов событий и конфигурирования стоек для адмиинистратора, модуль СКУД,
модуль настройки и рассылки тарифов на стойки и модуль кассира для приёма оплаты за
услуги парковки.
</p>
</div>
</li>

<li><a id="sec-6-1-1-3"></a>Система СКУД Em-Marine<br  /><div class="outline-text-5" id="text-6-1-1-3">
<p>
Необходимо реализовать работу карты СКУД стандарта EM-Marine в составе:
</p>
<ul class="org-ul">
<li>функционирующего <i>алгоритма проезда по картам СКУД</i>;
</li>
<li>реализованногов UI сервера <i>модуля СКУД</i> для внесения карт доступа в систему и
управления ими.
</li>
</ul>
</div>
</li>

<li><a id="sec-6-1-1-4"></a>Ручная касса на базе ПК<br  /><div class="outline-text-5" id="text-6-1-1-4">
<p>
Необходимо реализовать <i>модуль кассира</i> для возможности приёма оплаты за услуги
парковки. Кассир, с помощью UI на своём персональном компьютере, должен считывать
информацию со штрих-кода билета (сканером, подключённым к ПК по USB),
самостоятельно принимать оплату, после чего система должны печатать фискальный
чек (на фискальном регистраторе, подключённом к ПК по USB или COM RS-232).
</p>

<p>
В качестве сканера предлагается использовать любой <code>ручной сканер Honeywell/Metrologic Eclipse</code>
</p>

<p>
В качестве фискального регистратора использвать ККМ  <code>Штрих-Light-ФР-К (100)</code> или
<code>Искра ПРИМ-08ТК</code>.
</p>

<p>
Для считывания карт EM-Marine используется настольный считыватель <code>IronLogic Z-2 USB</code>.
</p>
</div>
</li>

<li><a id="sec-6-1-1-5"></a>Логгирование на сервере<br  /></li>
<li><a id="sec-6-1-1-6"></a>Все контроллеры должны уметь звук на SIP-е<br  /></li></ol>
</div>
<div id="outline-container-sec-6-1-2" class="outline-4">
<h4 id="sec-6-1-2"><span class="section-number-4">6.1.2</span> Функционал второго этапа (с 1 марта 2016)</h4>
<div class="outline-text-4" id="text-6-1-2">
</div><ol class="org-ol"><li><a id="sec-6-1-2-1"></a>Автоматизированная касса купюры+монеты (до 1 апреля 2016)<br  /></li>
<li><a id="sec-6-1-2-2"></a>Гибкие системы тарификации (до 1 июня 2016)<br  /></li>
<li><a id="sec-6-1-2-3"></a>Работа с видеокамерами по событиям (до 1 июня 2016)<br  /></li>
<li><a id="sec-6-1-2-4"></a>Работа кассы с банк-терминалами (до 1 июня 2016)<br  /></li>
<li><a id="sec-6-1-2-5"></a>Автоматизация продажи абонементов и дебетовых карт на кассе (до 1 июля 2016)<br  /></li>
<li><a id="sec-6-1-2-6"></a>Паркомат<br  /></li>
<li><a id="sec-6-1-2-7"></a>Билинг паркомата<br  /></li>
<li><a id="sec-6-1-2-8"></a>Аггрегирующий сервер<br  /></li>
<li><a id="sec-6-1-2-9"></a>Премиум (ресайклеры, выдача карт, свистоперделки)<br  /></li>
<li><a id="sec-6-1-2-10"></a>Распознавание номеров<br  /></li>
<li><a id="sec-6-1-2-11"></a>Интеграции с API<br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Задачи общего характера</h3>
<div class="outline-text-3" id="text-6-2">
</div><div id="outline-container-sec-6-2-1" class="outline-4">
<h4 id="sec-6-2-1"><span class="section-number-4">6.2.1</span> <span class="todo START">START</span> [pyub] Описание алгоритмов взаимодействия постетителя и АСПП</h4>
</div>
<div id="outline-container-sec-6-2-2" class="outline-4">
<h4 id="sec-6-2-2"><span class="section-number-4">6.2.2</span> <span class="todo WAIT">WAIT</span> [ranma] Отладка и интеграционное тестирование</h4>
</div>
<div id="outline-container-sec-6-2-3" class="outline-4">
<h4 id="sec-6-2-3"><span class="section-number-4">6.2.3</span> <span class="todo WAIT">WAIT</span> [all] Проверка элементов системы на макете прототипа</h4>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Задачи hardware</h3>
<div class="outline-text-3" id="text-6-3">
</div><div id="outline-container-sec-6-3-1" class="outline-4">
<h4 id="sec-6-3-1"><span class="section-number-4">6.3.1</span> <span class="done DONE">DONE</span> [bda]Выбор микрокомпьютера для контроллера</h4>
</div>
<div id="outline-container-sec-6-3-2" class="outline-4">
<h4 id="sec-6-3-2"><span class="section-number-4">6.3.2</span> <span class="done DONE">DONE</span> [pyub] Покупка плат BeagleBone Black и Development Kit</h4>
</div>
<div id="outline-container-sec-6-3-3" class="outline-4">
<h4 id="sec-6-3-3"><span class="section-number-4">6.3.3</span> <span class="done DONE">DONE</span> [bda] Подбор редких комплектующих для платы расширения</h4>
<div class="outline-text-4" id="text-6-3-3">
<p>
Сформирован список: <a href="https://octopart.com/bom-lookup/g1agjT7N/75pqkJDrUqGv7qrq">https://octopart.com/bom-lookup/g1agjT7N/75pqkJDrUqGv7qrq</a>
</p>
</div>
</div>
<div id="outline-container-sec-6-3-4" class="outline-4">
<h4 id="sec-6-3-4"><span class="section-number-4">6.3.4</span> DONE [ranma] Дерганье ногами на BBB</h4>
<div class="outline-text-4" id="text-6-3-4">
<p>
[TODO:ranma] - Я хочу пример кода и как его юзать.
<a href="http://hertaville.com/introduction-to-accessing-the-raspberry-pis-gpio-in-c.html">http://hertaville.com/introduction-to-accessing-the-raspberry-pis-gpio-in-c.html</a>
</p>
</div>
</div>
<div id="outline-container-sec-6-3-5" class="outline-4">
<h4 id="sec-6-3-5"><span class="section-number-4">6.3.5</span> <span class="todo TODO">TODO</span> [bda] Подбор основной части комплектующих для платы расширения</h4>
</div>
<div id="outline-container-sec-6-3-6" class="outline-4">
<h4 id="sec-6-3-6"><span class="section-number-4">6.3.6</span> <span class="done DONE">DONE</span> [noa] Поиск и заказ идущих долго комплектующих</h4>
<div class="outline-text-4" id="text-6-3-6">
<p>
Необходимо по спискам из задач подбора комплектующих найти поставщиков в России
через данный ресурс: <a href="http://passport.efind.ru/org/">http://passport.efind.ru/org/</a>
Далее, сделать заказ по списку.
</p>
</div>
</div>

<div id="outline-container-sec-6-3-7" class="outline-4">
<h4 id="sec-6-3-7"><span class="section-number-4">6.3.7</span> <span class="todo START">START</span> Трассировка базовой платы</h4>
</div>
<div id="outline-container-sec-6-3-8" class="outline-4">
<h4 id="sec-6-3-8"><span class="section-number-4">6.3.8</span> <span class="todo START">START</span> Трассировка платы расширения расширения</h4>
</div>
<div id="outline-container-sec-6-3-9" class="outline-4">
<h4 id="sec-6-3-9"><span class="section-number-4">6.3.9</span> <span class="todo TODO">TODO</span> [unrimah ranma] - Обеспечить возможность дергать ногами GPIO при отправке JSON-а</h4>
</div>
<div id="outline-container-sec-6-3-10" class="outline-4">
<h4 id="sec-6-3-10"><span class="section-number-4">6.3.10</span> <span class="todo TODO">TODO</span> [unrimah ranma] - Обеспечить возможность управлять дисплеем через JSON</h4>
</div>
<div id="outline-container-sec-6-3-11" class="outline-4">
<h4 id="sec-6-3-11"><span class="section-number-4">6.3.11</span> <span class="todo TODO">TODO</span> [unrimah] RTC needed (battery etc.)</h4>
</div>
<div id="outline-container-sec-6-3-12" class="outline-4">
<h4 id="sec-6-3-12"><span class="section-number-4">6.3.12</span> <span class="todo WAIT">WAIT</span> [unrimah] Макетирование прототипа</h4>
</div>
</div>
<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> Задачи software контроллер</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Описание конечно-автоматной работы системы и ее верификации.
</p>
</div>

<div id="outline-container-sec-6-4-1" class="outline-4">
<h4 id="sec-6-4-1"><span class="section-number-4">6.4.1</span> <span class="todo TODO">TODO</span> Описать <code>happy-cases</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyubnrimah">pyubnrimah</span></span></h4>
<div class="outline-text-4" id="text-6-4-1">
</div><ol class="org-ol"><li><a id="sec-6-4-1-1"></a><span class="done DONE">DONE</span> На алгоритмы проезда<br  /></li>
<li><a id="sec-6-4-1-2"></a><span class="todo TODO">TODO</span> На алгоритмы оплаты<br  /></li>
<li><a id="sec-6-4-1-3"></a><span class="todo TODO">TODO</span> Совмещенные алгоритмы<br  /></li></ol>
</div>
<div id="outline-container-sec-6-4-2" class="outline-4">
<h4 id="sec-6-4-2"><span class="section-number-4">6.4.2</span> <span class="todo TODO">TODO</span> Составление исполняемой спецификации, внесение описаний работы и кейсов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-3" class="outline-4">
<h4 id="sec-6-4-3"><span class="section-number-4">6.4.3</span> <span class="done DONE">DONE</span> Выделить состояния контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-4-4" class="outline-4">
<h4 id="sec-6-4-4"><span class="section-number-4">6.4.4</span> <span class="todo TODO">TODO</span> Список событий контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-4-5" class="outline-4">
<h4 id="sec-6-4-5"><span class="section-number-4">6.4.5</span> <span class="todo TODO">TODO</span> Составить конечный автомат&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-6" class="outline-4">
<h4 id="sec-6-4-6"><span class="section-number-4">6.4.6</span> <span class="todo START">START</span> Декларативное описание конечных автоматов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-7" class="outline-4">
<h4 id="sec-6-4-7"><span class="section-number-4">6.4.7</span> <span class="todo START">START</span> Написание генератора кода модели системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-8" class="outline-4">
<h4 id="sec-6-4-8"><span class="section-number-4">6.4.8</span> <span class="todo START">START</span> Ручная верификация работы системы на модели&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-9" class="outline-4">
<h4 id="sec-6-4-9"><span class="section-number-4">6.4.9</span> <span class="todo START">START</span> Расширение модели рабочим кодом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-10" class="outline-4">
<h4 id="sec-6-4-10"><span class="section-number-4">6.4.10</span> <span class="todo START">START</span> Автоматическая верификация работы системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-11" class="outline-4">
<h4 id="sec-6-4-11"><span class="section-number-4">6.4.11</span> <span class="todo START">START</span> Тестирование рабочего кода на прототипе устройства&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
</div>
<div id="outline-container-sec-6-4-12" class="outline-4">
<h4 id="sec-6-4-12"><span class="section-number-4">6.4.12</span> <span class="todo TODO">TODO</span> Создание UI web-интерфейса для настройки контроллера</h4>
</div>
</div>
<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> Задачи периферии контроллера</h3>
<div class="outline-text-3" id="text-6-5">
</div><div id="outline-container-sec-6-5-1" class="outline-4">
<h4 id="sec-6-5-1"><span class="section-number-4">6.5.1</span> <span class="todo TODO">TODO</span> Создание списка периферии и сведение документации по ней&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
</div>
<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> Задачи сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h3>
<div class="outline-text-3" id="text-6-6">
</div><div id="outline-container-sec-6-6-1" class="outline-4">
<h4 id="sec-6-6-1"><span class="section-number-4">6.6.1</span> <span class="todo WAIT">WAIT</span> Разработка структуры БД</h4>
</div>
<div id="outline-container-sec-6-6-2" class="outline-4">
<h4 id="sec-6-6-2"><span class="section-number-4">6.6.2</span> <span class="todo WAIT">WAIT</span> Разработка софтверной части для сервера</h4>
</div>
<div id="outline-container-sec-6-6-3" class="outline-4">
<h4 id="sec-6-6-3"><span class="section-number-4">6.6.3</span> <span class="todo WAIT">WAIT</span> Разработка интерйефса сервера</h4>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> <span class="todo WAIT">WAIT</span> Протоколы обмена данными&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="pyub">pyub</span></span></h2>
<div class="outline-text-2" id="text-7">
<p>
[TODO:pyub] Особенно важный ГЛОБАЛЬНЫЙ кейс - общение стоек между собой
отсутствия связи - надеюсь мы не будем поднимать это пока не сдадим пилотный
проект.
</p>

<p>
Контроллеры и рабочие станции соединяются с центральным сервером по локальной сети,
используя стек протоколов TCP/IP.
</p>

<p>
Некоторые периферийные компоненты системы могут связываться с контроллерами или
непосредственно с сервером и рабочими станциями по интерфейсу RS-485
</p>

<p>
Между стойками сети реализуем GIT [TODO:rigidus]
</p>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Принцип построения сети и взаимодействрия контроллеров и сервера</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Часть функций система должна выполнять, когда устройства (контроллер и сервер)
работают в автономном режиме (например при обрыве связи по Ethernet).
</p>

<p>
Изначально закладывается одноранговая структура автоматического взаимодействия
сервера и контроллера. Т.е. сервер и все контроллеры в сети постоянно обмениваются
функциональными сервисными сообщениями, синхронизируя свои данные о происходящем на
парковке. Сервер является аггрегатором функциональных и информационных сообщений
(истории лога), а также имеет приоритет настройки и управления элементами системы
(например тарифы установленные на сервере приоритетны для контроллеров, если на них
не выставлена обратная настройка) во всех случаях, кроме связанных с безопасностью
(например, если с сервера пришёл сигнал "закрыть шлагбаум", а стойка считает, что
датчик безопасности закрытия стрелы шлагбаума занят - шлагбаум не закрывается).
</p>

<p>
Таким образом возможны три сценария сбоя:
</p>
<ul class="org-ul">
<li>одна или несколько стоек теряют связь с одной или несколькими стойками и сервером (две автономные группы)
</li>
<li>все стойки теряют свзяь с сервером (две автономные группы)
</li>
<li>несколько групп, состоящих из одной или нескольких стоек, теряют связь друг сдругом и / или сервером (более двух автономных групп).
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Принцип автономной работы контроллера</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Работа контроллера в случае обрыва связи с сервером осуществляется следующим
образом. Билет считывается сканером штрих кодов. Время и код билета сохраняются в
памяти контроллера. Решение об открытии ворот принимается охранником (на билете
напечатано время въезда). При восстановлении связи архив информации о билетах
передается на центральный сервер.
</p>

<p>
Когда и если контроллер остаётся без связи со всей остальной системой он должен
максимально полноценно выполнять заложенные в него функции автоматизации:
</p>
<ul class="org-ul">
<li>Для въезда, выезда, проезда и совмещённых с оплатой решений:
<ul class="org-ul">
<li>открывать и закрывать шлагбаум, контролировать состояние шлг.
</li>
<li>управлять сигнальными устройствами (светофорами, счётчиками мест)
</li>
<li>контролировать состояние датчиков присутсвия и безопасности
</li>
</ul>
</li>
<li>Для въездов
<ul class="org-ul">
<li>для штрих-кода: шифровать в код информацию о въезде / для Mifare: записывать информацию о въезде на карту
</li>
</ul>
</li>
<li>Для выездов, касс, проездных стоек:
<ul class="org-ul">
<li>выдавать выездной документ разовым посетителям
</li>
<li>иметь инфомацию о тарифах (исходя из сложной системы тарификации)
</li>
<li>считывать информацию с въездного документа и обрабатывать её
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Контроллер</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Гибкость и оптимизация</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Плата и программное обеспечение должны быть выполнены так, чтобы была возможность
масштабирования системы и при этом сохранения обратной совместимости программного
обеспечения. Например, в определённый момент возникнет необходимость увеличить
количество реле или COM-портов на плате, будет осуществлена доработка связанная с
переразводкой, но при этом на новых контроллерах должно штатно работать и старое ПО,
а на старых контроллерах работать новое ПО.
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Аппаратная часть</h3>
<div class="outline-text-3" id="text-8-2">
</div><div id="outline-container-sec-8-2-1" class="outline-4">
<h4 id="sec-8-2-1"><span class="section-number-4">8.2.1</span> <span class="done DONE">DONE</span> Выбор микрокомпьютера</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
<a href="http://beagleboard.org/support/bone101">http://beagleboard.org/support/bone101</a>
</p>
</div>
</div>

<div id="outline-container-sec-8-2-2" class="outline-4">
<h4 id="sec-8-2-2"><span class="section-number-4">8.2.2</span> <span class="todo TODO">TODO</span> Принципиальная схема контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span>&#xa0;<span class="noa">noa</span></span></h4>
</div>
<div id="outline-container-sec-8-2-3" class="outline-4">
<h4 id="sec-8-2-3"><span class="section-number-4">8.2.3</span> <span class="todo TODO">TODO</span> Вписать в таблицы данные по потреблению переферии, сигнальным уровням и необходимости изоляции&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-8-2-3">
<p>
Чтобы осмысленно строить защиту от статики, неправильного монтажа, наводок по земле
и т.п. надо понимать что из себя представляет периферия с электрической точки
зрения.
</p>

<p>
Для наглядности представления информации неплохо бы её занести в соответствующие
таблицы.
</p>
</div>
</div>

<div id="outline-container-sec-8-2-4" class="outline-4">
<h4 id="sec-8-2-4"><span class="section-number-4">8.2.4</span> <span class="todo WAIT">WAIT</span> Схемотехника базовой платы</h4>
</div>
<div id="outline-container-sec-8-2-5" class="outline-4">
<h4 id="sec-8-2-5"><span class="section-number-4">8.2.5</span> <span class="todo WAIT">WAIT</span> Схемотехника плат расширения</h4>
<div class="outline-text-4" id="text-8-2-5">
<p>
Плата дополнительных UART
Плата дополнительных USB
Плата дополнительных сенсоров
Плата дополнительных реле
Плата GSM-модема
</p>
</div>
</div>

<div id="outline-container-sec-8-2-6" class="outline-4">
<h4 id="sec-8-2-6"><span class="section-number-4">8.2.6</span> <span class="todo WAIT">WAIT</span> Оптимизация цены решения</h4>
<div class="outline-text-4" id="text-8-2-6">
<p>
Возможные шаги
</p>
<ul class="org-ul">
<li>Уменьшить размер ПЗУ на BBB с 4 Гб -&gt; 1 Гб.
</li>
<li>Выкинуть microHDMI c BBB
</li>
<li>Выкинуть miniUSB (slave) c BBB, переразвести на UART, отказаться от доп. питания. Сервисный UART нужен.
</li>
<li>Выкинуть "настоящий" USB-host разъем c BBB  =&gt; развести на доп. ноги =&gt; переразвести на шину =&gt; до USB-hub. Удлинить гребенку контактов.
</li>
<li>Замена на платах расширения I2C конвертеров на ПЛИС.
</li>
<li>Пробивание уменьшения цены за сроки поставки.
</li>
<li>Выход на большие партии у непосредственно производителей. Например, <a href="http://www.element14.com/community/search.jspa?q=BeagleBonE+Black">http://www.element14.com/community/search.jspa?q=BeagleBonE+Black</a>
</li>
<li>Есть интересная модификация BBB: <a href="http://www.mentorel.ru/promyshlennyj-modul-na-zamenu-beaglebone-black/">http://www.mentorel.ru/promyshlennyj-modul-na-zamenu-beaglebone-black/</a>
</li>
</ul>
</div>

<ol class="org-ol"><li><a id="sec-8-2-6-1"></a><span class="todo TODO">TODO</span> Подготовка для заказа на контрактной сборке&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> <span class="todo TODO">TODO</span> Периферийное оборудование&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-3">
<p>
[TODO:pyub] Собрать здесь ссылки на протоколы обмена для каждого конкретного
устройства.
</p>
</div>

<div id="outline-container-sec-8-3-1" class="outline-4">
<h4 id="sec-8-3-1"><span class="section-number-4">8.3.1</span> Дисплей монохромный</h4>
<div class="outline-text-4" id="text-8-3-1">
<p>
монохромный 2, 4 строки
</p>
</div>
</div>
<div id="outline-container-sec-8-3-2" class="outline-4">
<h4 id="sec-8-3-2"><span class="section-number-4">8.3.2</span> Дисплей цветной сенсорный</h4>
</div>
<div id="outline-container-sec-8-3-3" class="outline-4">
<h4 id="sec-8-3-3"><span class="section-number-4">8.3.3</span> Клавиатура</h4>
</div>
<div id="outline-container-sec-8-3-4" class="outline-4">
<h4 id="sec-8-3-4"><span class="section-number-4">8.3.4</span> Термопринтеры</h4>
</div>
<div id="outline-container-sec-8-3-5" class="outline-4">
<h4 id="sec-8-3-5"><span class="section-number-4">8.3.5</span> ККМ</h4>
</div>
<div id="outline-container-sec-8-3-6" class="outline-4">
<h4 id="sec-8-3-6"><span class="section-number-4">8.3.6</span> Сканеры штриховых кодов</h4>
</div>
<div id="outline-container-sec-8-3-7" class="outline-4">
<h4 id="sec-8-3-7"><span class="section-number-4">8.3.7</span> Приёмники купюр</h4>
</div>
<div id="outline-container-sec-8-3-8" class="outline-4">
<h4 id="sec-8-3-8"><span class="section-number-4">8.3.8</span> Диспнесеры купюр</h4>
</div>
<div id="outline-container-sec-8-3-9" class="outline-4">
<h4 id="sec-8-3-9"><span class="section-number-4">8.3.9</span> Приёмник монет</h4>
</div>
<div id="outline-container-sec-8-3-10" class="outline-4">
<h4 id="sec-8-3-10"><span class="section-number-4">8.3.10</span> Хоппер (диспенсер монет)</h4>
</div>
<div id="outline-container-sec-8-3-11" class="outline-4">
<h4 id="sec-8-3-11"><span class="section-number-4">8.3.11</span> Ресайклер купюр</h4>
</div>
<div id="outline-container-sec-8-3-12" class="outline-4">
<h4 id="sec-8-3-12"><span class="section-number-4">8.3.12</span> Ресайклер монет</h4>
</div>
<div id="outline-container-sec-8-3-13" class="outline-4">
<h4 id="sec-8-3-13"><span class="section-number-4">8.3.13</span> Считыватели карт EM-Marine, Mifare</h4>
</div>
<div id="outline-container-sec-8-3-14" class="outline-4">
<h4 id="sec-8-3-14"><span class="section-number-4">8.3.14</span> Приёмник карт</h4>
</div>
<div id="outline-container-sec-8-3-15" class="outline-4">
<h4 id="sec-8-3-15"><span class="section-number-4">8.3.15</span> Диспенсер карт</h4>
</div>
<div id="outline-container-sec-8-3-16" class="outline-4">
<h4 id="sec-8-3-16"><span class="section-number-4">8.3.16</span> Ресайклер карт</h4>
</div>
<div id="outline-container-sec-8-3-17" class="outline-4">
<h4 id="sec-8-3-17"><span class="section-number-4">8.3.17</span> Терминал банковских карт</h4>
</div>
<div id="outline-container-sec-8-3-18" class="outline-4">
<h4 id="sec-8-3-18"><span class="section-number-4">8.3.18</span> Транспондер DSRC</h4>
<div class="outline-text-4" id="text-8-3-18">
<p>
Статья, описывающая систему: <a href="http://habrahabr.ru/post/240047/">http://habrahabr.ru/post/240047/</a>
</p>

<p>
Даташит на пример устройства лежит в devices/DSRC.
</p>

<p>
<code>DSRC</code> (Dedicated Short Range Communication) - беспроводная связь на короткое
расстояние. Частота несущей в диапазоне 5.8 ГГц. Линии связи DSRC находят
применение, главным образом, в системах электронного платежа, так как для этой
технологии были завершены стандарты на уровне Европейского Союза (CEN/TC278 и
ETSI). Линия связи DSRC состоит из двух основных частей, а именно: из блока <code>OBU</code>
(On-Board Unit - устройство в транспортном средстве) и блока <code>RSE</code> (Road Side
Equipment - устройство на дороге), которые обмениваются данными.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> Зависимости периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></h3>
<div class="outline-text-3" id="text-8-4">
<p>
[TODO:noa] Расписать зависимости, указывая причины почему одна периферия не может
работать без другой.
</p>
</div>

<div id="outline-container-sec-8-4-1" class="outline-4">
<h4 id="sec-8-4-1"><span class="section-number-4">8.4.1</span> Дисплей монохромный</h4>
<div class="outline-text-4" id="text-8-4-1">
<p>
Диалоговые режимы работы
</p>

<p>
необходимые устройства:
-Клавиатура
</p>
</div>
</div>
<div id="outline-container-sec-8-4-2" class="outline-4">
<h4 id="sec-8-4-2"><span class="section-number-4">8.4.2</span> Дисплей цветной</h4>
<div class="outline-text-4" id="text-8-4-2">
<p>
Диалоговые режимы работы
</p>

<p>
необходимые устройства:
-Клавиатура/сенсор дисплея
</p>
</div>
</div>
<div id="outline-container-sec-8-4-3" class="outline-4">
<h4 id="sec-8-4-3"><span class="section-number-4">8.4.3</span> Сенсор дисплея</h4>
<div class="outline-text-4" id="text-8-4-3">
<p>
Диалоговые режимы работы
</p>

<p>
необходимые устройства:
-Цветной дисплей
</p>
</div>
</div>
<div id="outline-container-sec-8-4-4" class="outline-4">
<h4 id="sec-8-4-4"><span class="section-number-4">8.4.4</span> Клавиатура</h4>
<div class="outline-text-4" id="text-8-4-4">
<p>
Диалоговый режим работы
</p>

<p>
необходимые устройства:
-дисплей сенсорный/монохромный
</p>
</div>
</div>
<div id="outline-container-sec-8-4-5" class="outline-4">
<h4 id="sec-8-4-5"><span class="section-number-4">8.4.5</span> Термопринтеры</h4>
<div class="outline-text-4" id="text-8-4-5">
<p>
Въезд по билетам
Безналичный расчет
</p>

<p>
необходимые устройства:
</p>
</div>
</div>

<div id="outline-container-sec-8-4-6" class="outline-4">
<h4 id="sec-8-4-6"><span class="section-number-4">8.4.6</span> ККМ</h4>
<div class="outline-text-4" id="text-8-4-6">
<p>
Оплата наличными
Безналичный расчет
</p>
</div>
</div>
<div id="outline-container-sec-8-4-7" class="outline-4">
<h4 id="sec-8-4-7"><span class="section-number-4">8.4.7</span> Сканеры штриховых кодов</h4>
<div class="outline-text-4" id="text-8-4-7">
<p>
Оплата билетов
Выезд по карам
</p>
</div>
</div>
<div id="outline-container-sec-8-4-8" class="outline-4">
<h4 id="sec-8-4-8"><span class="section-number-4">8.4.8</span> Приёмники купюр</h4>
<div class="outline-text-4" id="text-8-4-8">
<p>
Прием купюр
</p>
</div>
</div>
<div id="outline-container-sec-8-4-9" class="outline-4">
<h4 id="sec-8-4-9"><span class="section-number-4">8.4.9</span> Диспнесеры купюр</h4>
<div class="outline-text-4" id="text-8-4-9">
<p>
Выдача купюр
</p>
</div>
</div>
<div id="outline-container-sec-8-4-10" class="outline-4">
<h4 id="sec-8-4-10"><span class="section-number-4">8.4.10</span> Приёмник монет</h4>
<div class="outline-text-4" id="text-8-4-10">
<p>
Прием монет
</p>

<p>
необходимые устройства:
-прием монет
</p>
</div>
</div>
<div id="outline-container-sec-8-4-11" class="outline-4">
<h4 id="sec-8-4-11"><span class="section-number-4">8.4.11</span> Хоппер (диспенсер монет)</h4>
<div class="outline-text-4" id="text-8-4-11">
<p>
Выдча монет
</p>
</div>
</div>
<div id="outline-container-sec-8-4-12" class="outline-4">
<h4 id="sec-8-4-12"><span class="section-number-4">8.4.12</span> Ресайклер купюр</h4>
<div class="outline-text-4" id="text-8-4-12">
<p>
Прием бумажной наличности
Выдача бумжной наличности
</p>
</div>
</div>
<div id="outline-container-sec-8-4-13" class="outline-4">
<h4 id="sec-8-4-13"><span class="section-number-4">8.4.13</span> Ресайклер монет</h4>
<div class="outline-text-4" id="text-8-4-13">
<p>
Прием монет
Выдача монет
</p>
</div>
</div>
<div id="outline-container-sec-8-4-14" class="outline-4">
<h4 id="sec-8-4-14"><span class="section-number-4">8.4.14</span> Считыватели карт EM-Marine, Mifare</h4>
<div class="outline-text-4" id="text-8-4-14">
<p>
Работа с картами
</p>
</div>
</div>
<div id="outline-container-sec-8-4-15" class="outline-4">
<h4 id="sec-8-4-15"><span class="section-number-4">8.4.15</span> Приёмник карт</h4>
<div class="outline-text-4" id="text-8-4-15">
<p>
Приме карт
</p>
</div>
</div>
<div id="outline-container-sec-8-4-16" class="outline-4">
<h4 id="sec-8-4-16"><span class="section-number-4">8.4.16</span> Диспенсер карт</h4>
<div class="outline-text-4" id="text-8-4-16">
<p>
Выдача карт
</p>
</div>
</div>
<div id="outline-container-sec-8-4-17" class="outline-4">
<h4 id="sec-8-4-17"><span class="section-number-4">8.4.17</span> Ресайклер карт</h4>
<div class="outline-text-4" id="text-8-4-17">
<p>
Прием карт
Выдача карт
</p>
</div>
</div>
<div id="outline-container-sec-8-4-18" class="outline-4">
<h4 id="sec-8-4-18"><span class="section-number-4">8.4.18</span> Терминал банковских карт</h4>
<div class="outline-text-4" id="text-8-4-18">
<p>
Безналичный расчет
</p>

<p>
необходимые устройства:
-термопринтер/ККМ
</p>
</div>
</div>
<div id="outline-container-sec-8-4-19" class="outline-4">
<h4 id="sec-8-4-19"><span class="section-number-4">8.4.19</span> Транспондер DSRC</h4>
<div class="outline-text-4" id="text-8-4-19">
<p>
Работа с радиометками
</p>
</div>
</div>
</div>
<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><span class="section-number-3">8.5</span> Подключение периферии к контроллеру</h3>
</div>
<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6"><span class="section-number-3">8.6</span> Список сообщений на дисплей</h3>
<div class="outline-text-3" id="text-8-6">
<p>
Если есть принтер (въезд)
</p>

<p>
Если есть сканер (выезд)
</p>

<p>
Если есть считыватель
</p>
</div>

<div id="outline-container-sec-8-6-1" class="outline-4">
<h4 id="sec-8-6-1"><span class="section-number-4">8.6.1</span> Периферийные устройства контроллера и протоколы связи</h4>
<div class="outline-text-4" id="text-8-6-1">
<p>
Документация по всему периферийному оборудованию лежит тут: <a href="file://home/pyub/repo/asp/devices">devices</a>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Периферийное оборудовани</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
<th scope="col" class="left">Необходимое питание (мА)</th>
<th scope="col" class="left">Изоляция (Y/N)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Термопринтер</td>
<td class="left">Custom VKP80II</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Фискальный регистратор</td>
<td class="left">Искра ПРИМ-21К 03</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Сканер штрихкодов широкополосный</td>
<td class="left">Honywell IS3480 QuantumE</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Сканер штрихкода / QR-кода</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Диспенсер карт Mifare+</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Картоприёмник Mifare+</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Считыватель карт Em-Marine</td>
<td class="left">Iron Logic Mifare + Matrix II MF-I</td>
<td class="left">Wiegand 26</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Считыватель карт Em-Marine</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long</td>
<td class="left">6800 / SPI</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Дисплей цветной графический TFT-LCD</td>
<td class="left">Winstar / Long</td>
<td class="left">RGB / MCU</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">Купюроприемник</td>
<td class="left">CashCode SM (MSM)</td>
<td class="left">ID003 / CCNET</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">ICT L77F</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">Монетоприемник</td>
<td class="left">ICT UCA2</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Диспенсер купюр</td>
<td class="left">Puloon LCDM-1000/2000/4000</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">ICT ND 300 KM</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">Хоппер</td>
<td class="left">ICT Leonid Mini Hopper</td>
<td class="left">ccTalk / Hopper</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">15</td>
<td class="left">Ресайклер монет</td>
<td class="left">не выбрана</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">16</td>
<td class="left">POS банк-терминал</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB / Ethernet</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">17</td>
<td class="left">Табло счётчика мест / инфотабло</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">18</td>
<td class="left">Ультразвуковой датчик наличия машины</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">19</td>
<td class="left">Магнитный датчик наличия машины</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-8-6-2" class="outline-4">
<h4 id="sec-8-6-2"><span class="section-number-4">8.6.2</span> Выводы на аудио оборудование</h4>
<div class="outline-text-4" id="text-8-6-2">
<p>
Делаем в пилотнике. Поднимаем Астерикс
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Аудио-оборудование</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Тип устройства</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">20</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">Вывод на динамик</td>
</tr>

<tr>
<td class="right">21</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">Вывод на микрофон</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-8-6-3" class="outline-4">
<h4 id="sec-8-6-3"><span class="section-number-4">8.6.3</span> Выводы на сухой контакт реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></h4>
<div class="outline-text-4" id="text-8-6-3">
<p>
Это реле.
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Выходы - сухой контакт</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип / описание назанчения</th>
<th scope="col" class="left">Название в системе</th>
<th scope="col" class="left">Реле по умолчанию</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">22</td>
<td class="left">Шлагбаум открытие (вверх)</td>
<td class="left"><code>relay-gate-open</code></td>
<td class="left">R1</td>
</tr>

<tr>
<td class="right">23</td>
<td class="left">Шлагбаум закрытие (внизз)</td>
<td class="left"><code>relay-gate-close</code></td>
<td class="left">R2</td>
</tr>

<tr>
<td class="right">24</td>
<td class="left">Шлагбаум стоп</td>
<td class="left"><code>relay-gate-stop</code></td>
<td class="left">R3</td>
</tr>

<tr>
<td class="right">25</td>
<td class="left">Светофор сигнал 1</td>
<td class="left"><code>relay-sign-1</code></td>
<td class="left">R4</td>
</tr>

<tr>
<td class="right">26</td>
<td class="left">Светофор сигнал 2</td>
<td class="left"><code>relay-sign-2</code></td>
<td class="left">R5</td>
</tr>

<tr>
<td class="right">27</td>
<td class="left">Светофор сигнал 3</td>
<td class="left"><code>relay-sign-3</code></td>
<td class="left">R6</td>
</tr>

<tr>
<td class="right">28</td>
<td class="left">Подсветка кнопки</td>
<td class="left"><code>relay-backlight</code></td>
<td class="left">R7</td>
</tr>

<tr>
<td class="right">29</td>
<td class="left">Доп. реле управления смежными устр.</td>
<td class="left">-</td>
<td class="left">R8</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-8-6-4" class="outline-4">
<h4 id="sec-8-6-4"><span class="section-number-4">8.6.4</span> Вводы сигналов с датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrumah">unrumah</span></span></h4>
<div class="outline-text-4" id="text-8-6-4">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Сенсорный ввод</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип / описание назначения</th>
<th scope="col" class="left">Название в системе</th>
<th scope="col" class="left">Ввод по умолчанию</th>
<th scope="col" class="left">Домен развязки</th>
<th scope="col" class="left">Типичный уровень сигнала</th>
<th scope="col" class="left">Маскимальное напряжение при ошибке монтажа</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">32</td>
<td class="left">Датчик присутсвия автомобиля А</td>
<td class="left"><code>detector-a</code></td>
<td class="left">S1</td>
<td class="left">присутствие</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">33</td>
<td class="left">Датчик присутсвия автомобиля Б</td>
<td class="left"><code>detector-b</code></td>
<td class="left">S2</td>
<td class="left">присутствие</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">34</td>
<td class="left">Датчик завершения проезда рампы</td>
<td class="left"><code>detector-c</code></td>
<td class="left">S3</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">35</td>
<td class="left">Концевки открытия шлагбаума</td>
<td class="left"><code>detector-gate-open</code></td>
<td class="left">S4</td>
<td class="left">шлагбаум</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">36</td>
<td class="left">Концевик закрытия шлагбаума</td>
<td class="left"><code>detector-gate-close</code></td>
<td class="left">S5</td>
<td class="left">шлагбаум</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">37</td>
<td class="left">Фотоэлемент безопасности</td>
<td class="left"><code>detector-safety</code></td>
<td class="left">S6</td>
<td class="left">шлагбаум</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">38</td>
<td class="left">Датчик грузового транспорта</td>
<td class="left"><code>detector-truck</code></td>
<td class="left">S7</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">39</td>
<td class="left">Резерв</td>
<td class="left">-</td>
<td class="left">S8</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-8-6-5" class="outline-4">
<h4 id="sec-8-6-5"><span class="section-number-4">8.6.5</span> Вводы с кнопок</h4>
<div class="outline-text-4" id="text-8-6-5">
</div>
<ol class="org-ol"><li><a id="sec-8-6-5-1"></a>Функции<br  /><div class="outline-text-5" id="text-8-6-5-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Функции</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">40</td>
<td class="left">Сигнализация А (техническая зона)</td>
</tr>

<tr>
<td class="right">41</td>
<td class="left">Сигнализация В (финансовая зона)</td>
</tr>

<tr>
<td class="right">42</td>
<td class="left">Вызов оператора</td>
</tr>

<tr>
<td class="right">43</td>
<td class="left">ОТМЕНА</td>
</tr>

<tr>
<td class="right">44</td>
<td class="left">ПОДТВЕРЖДЕНИЕ</td>
</tr>

<tr>
<td class="right">45</td>
<td class="left">Навигация Вверх</td>
</tr>

<tr>
<td class="right">46</td>
<td class="left">Навигация Вниз</td>
</tr>

<tr>
<td class="right">47</td>
<td class="left">Оплата ШТРАФА</td>
</tr>

<tr>
<td class="right">48</td>
<td class="left">X-отчет</td>
</tr>

<tr>
<td class="right">49</td>
<td class="left">Z-отчет</td>
</tr>

<tr>
<td class="right">50</td>
<td class="left">Копия Z-отчета</td>
</tr>

<tr>
<td class="right">51</td>
<td class="left">Печать чека (въезд)</td>
</tr>

<tr>
<td class="right">52</td>
<td class="left">Инкассация</td>
</tr>

<tr>
<td class="right">53</td>
<td class="left">Изъятие/внесение (?)</td>
</tr>

<tr>
<td class="right">54</td>
<td class="left">Разблокировка (hardware)</td>
</tr>

<tr>
<td class="right">55</td>
<td class="left">Тестовая печать</td>
</tr>

<tr>
<td class="right">56</td>
<td class="left">Сервисный режим (удержание, кнопка с фиксацией)</td>
</tr>

<tr>
<td class="right">57</td>
<td class="left">Запрос проезда (разрешение)</td>
</tr>

<tr>
<td class="right">58</td>
<td class="left">Открытие проезда (удержание)</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">Конфиг контроллера (?)</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-8-6-5-2"></a>Внешние кнопки<br  /><div class="outline-text-5" id="text-8-6-5-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
</tr>

<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">Осн. режим</th>
<th scope="col" class="left">В сервисном режиме</th>
<th scope="col" class="left">Name</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">Вызов оператора</td>
<td class="left">&#xa0;</td>
<td class="left">B1</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">ОТМЕНА</td>
<td class="left">Предыдущее меню</td>
<td class="left">B2</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">ПОДТВЕРЖДЕНИЕ</td>
<td class="left">Выбор меню</td>
<td class="left">B3</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Навигация Вверх</td>
<td class="left">Предыдущий пункт</td>
<td class="left">B4</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Навигация Вниз</td>
<td class="left">Следующий пункт</td>
<td class="left">B5</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Оплата ШТРАФА</td>
<td class="left">Конфиг контроллера</td>
<td class="left">B6</td>
<td class="left">IP/тип/статус сязи с сервером/состояние на экран</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Печать чека (въезд)</td>
<td class="left">Тестовая печать</td>
<td class="left">B7</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Резерв</td>
<td class="left">Резерв</td>
<td class="left">B8</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-8-6-5-3"></a>Внутренние кнопки<br  /><div class="outline-text-5" id="text-8-6-5-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">Осн. режим</th>
<th scope="col" class="left">В сервисном режиме</th>
<th scope="col" class="left">Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">Основной режим (Разомкнута конопка с фиксацией)</td>
<td class="left">Сервесный режим (замкнута кнопка с фиксацией)</td>
<td class="left">B9</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">X-отчет</td>
<td class="left">Z-отчет</td>
<td class="left">B10</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Разблокировка (hardware)</td>
<td class="left">Копия Z-отчета</td>
<td class="left">B11</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Аварийное открытие проезда (удержание)</td>
<td class="left">Инкассация</td>
<td class="left">B12</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Запрос проезда (разрешение по процедуре)</td>
<td class="left">Изъятие/внесение (?)</td>
<td class="left">B13</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Сигнализация А (техническая зона)</td>
<td class="left">Сигнализация А (техническая зона)</td>
<td class="left">B14</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Сигнализация В (финансовая зона)</td>
<td class="left">Сигнализация В (финансовая зона)</td>
<td class="left">B15</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Резерв</td>
<td class="left">Резерв</td>
<td class="left">B16</td>
</tr>
</tbody>
</table>
</div>
</li></ol>
</div>


<div id="outline-container-sec-8-6-6" class="outline-4">
<h4 id="sec-8-6-6"><span class="section-number-4">8.6.6</span> Кроссировка RJ45 для подключения внешних устройств</h4>
<div class="outline-text-4" id="text-8-6-6">
<p>
В паралель к текущим вводам выводм контроллера на плате должны быть установленны
следующие разъемы RJ45. С возможностью размыкать джамперами или переключать питание
на второй ввод питания на контроллер части линий.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">№</th>
<th scope="col" class="left">Функция</th>
<th scope="col" class="right">Разъм</th>
<th scope="col" class="right">Пин</th>
<th scope="col" class="left">Вывод</th>
<th scope="col" class="left">Цвет по B</th>
<th scope="col" class="left">Дополнительно</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Открыть шлагбаум</td>
<td class="right">1</td>
<td class="right">1</td>
<td class="left">R1.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Закрыть шлагбаум</td>
<td class="right">1</td>
<td class="right">2</td>
<td class="left">R2.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Остановить шлагбаум</td>
<td class="right">1</td>
<td class="right">3</td>
<td class="left">R3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий от открыть шлагбаум</td>
<td class="right">1</td>
<td class="right">4</td>
<td class="left">R1.2</td>
<td class="left">&#xa0;</td>
<td class="left">размыкается джампером 1 от R3.2</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Общий от закрыть шлагбаум</td>
<td class="right">1</td>
<td class="right">4</td>
<td class="left">R2.2</td>
<td class="left">&#xa0;</td>
<td class="left">размыкается джампером 2 от R3.2</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий от остановить шлагбаум</td>
<td class="right">1</td>
<td class="right">4</td>
<td class="left">R3.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Шлагбаум открыт</td>
<td class="right">1</td>
<td class="right">5</td>
<td class="left">S4.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Шлагбаум закрыт</td>
<td class="right">1</td>
<td class="right">6</td>
<td class="left">S5.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Общий от шлагбаум открыт</td>
<td class="right">1</td>
<td class="right">7</td>
<td class="left">S4.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Общий от шлагбаум закрыт</td>
<td class="right">1</td>
<td class="right">8</td>
<td class="left">S5.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Красный Светофор U+</td>
<td class="right">2</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 3</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">2</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Красный Светофор GND</td>
<td class="right">2</td>
<td class="right">3</td>
<td class="left">R4.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 4</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">4</td>
<td class="left">R4.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Зеленый Светофор U+</td>
<td class="right">2</td>
<td class="right">5</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 5</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">6</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Зеленый Светофор GND</td>
<td class="right">2</td>
<td class="right">7</td>
<td class="left">R5.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 6</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">8</td>
<td class="left">R5.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="left">Дополнительный Светофор U+</td>
<td class="right">3</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 7</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">2</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дополнительный Светофор GND</td>
<td class="right">3</td>
<td class="right">3</td>
<td class="left">R6.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 8</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">4</td>
<td class="left">R6.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Дополнительное реле</td>
<td class="right">3</td>
<td class="right">5</td>
<td class="left">R8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">6</td>
<td class="left">R8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Дополнительное реле общий</td>
<td class="right">3</td>
<td class="right">7</td>
<td class="left">R8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">8</td>
<td class="left">R8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание RS485 U+</td>
<td class="right">4</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 9</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питание RS485 Gnd</td>
<td class="right">4</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается Джампером 10</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Host RS485 A</td>
<td class="right">4</td>
<td class="right">3</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Host RS485 B</td>
<td class="right">4</td>
<td class="right">4</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Host RS485 Gnd</td>
<td class="right">4</td>
<td class="right">5</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Client RS485 A</td>
<td class="right">4</td>
<td class="right">6</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Client RS485 B</td>
<td class="right">4</td>
<td class="right">7</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Client RS485 Gnd</td>
<td class="right">4</td>
<td class="right">8</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание устройства U+</td>
<td class="right">5</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 11</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питания Устройства Gnd</td>
<td class="right">5</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 12</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Датчик присутствия автомобиля A</td>
<td class="right">5</td>
<td class="right">3</td>
<td class="left">S1.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Датчик присутствия автомобиля Б</td>
<td class="right">5</td>
<td class="right">4</td>
<td class="left">S2.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Общий датчика присутствия А</td>
<td class="right">5</td>
<td class="right">5</td>
<td class="left">S1.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика присутствия Б</td>
<td class="right">5</td>
<td class="right">6</td>
<td class="left">S2.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Резервный датчик</td>
<td class="right">5</td>
<td class="right">7</td>
<td class="left">S8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий резервного датчика</td>
<td class="right">5</td>
<td class="right">8</td>
<td class="left">S8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Вызов оператора</td>
<td class="right">6</td>
<td class="right">1</td>
<td class="left">B1.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Отмена/Предыдыдущее меню</td>
<td class="right">6</td>
<td class="right">2</td>
<td class="left">B2.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Подтверждение/Выбор меню</td>
<td class="right">6</td>
<td class="right">3</td>
<td class="left">B3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Навигация вверх/Предыдущий пункт</td>
<td class="right">6</td>
<td class="right">4</td>
<td class="left">B4.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Навигация вниз/Следующий пункт</td>
<td class="right">6</td>
<td class="right">5</td>
<td class="left">B5.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Оплата штрафа/Конфиг контроллера</td>
<td class="right">6</td>
<td class="right">6</td>
<td class="left">B6.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Печать чека/Тестовая печать</td>
<td class="right">6</td>
<td class="right">7</td>
<td class="left">B7.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий кнопок лицевой панели</td>
<td class="right">6</td>
<td class="right">8</td>
<td class="left">B1-7.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Сервисный режим NO/NC</td>
<td class="right">7</td>
<td class="right">1</td>
<td class="left">B9.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Х-отчет/Z-отчет</td>
<td class="right">7</td>
<td class="right">2</td>
<td class="left">B10.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Разблокировка(Hardware)/Копия Z-отчета</td>
<td class="right">7</td>
<td class="right">3</td>
<td class="left">B11.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Аварийное открытие проезда(Удержание)/Инкассация</td>
<td class="right">7</td>
<td class="right">4</td>
<td class="left">B12.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Запрос проезда(разрешение по процедуре)/изъятие-внесение</td>
<td class="right">7</td>
<td class="right">5</td>
<td class="left">B13.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Сигнализация А/Сигнализация А(техническая зона)</td>
<td class="right">7</td>
<td class="right">6</td>
<td class="left">B14.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Сигнализация Б/Сигнализация Б(финансовая зона)</td>
<td class="right">7</td>
<td class="right">7</td>
<td class="left">B15.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий внутренних кнопок</td>
<td class="right">7</td>
<td class="right">8</td>
<td class="left">B9-15.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">8</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 13</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">8</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 14</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Фотоэлемент безопстности</td>
<td class="right">8</td>
<td class="right">3</td>
<td class="left">S6.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий фотоэлемента безопастности</td>
<td class="right">8</td>
<td class="right">4</td>
<td class="left">S6.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Датчик грузового транспорта</td>
<td class="right">8</td>
<td class="right">5</td>
<td class="left">S7.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика грузового транспорта</td>
<td class="right">8</td>
<td class="right">6</td>
<td class="left">S7.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Арбитраж шина</td>
<td class="right">8</td>
<td class="right">7</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Размыкается джампером 15</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Арбитраж обвязка</td>
<td class="right">8</td>
<td class="right">8</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">9</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 13</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">9</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 14</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Фотоэлемент безопстности</td>
<td class="right">9</td>
<td class="right">3</td>
<td class="left">S6.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий фотоэлемента безопастности</td>
<td class="right">9</td>
<td class="right">4</td>
<td class="left">S6.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Датчик грузового транспорта</td>
<td class="right">9</td>
<td class="right">5</td>
<td class="left">S7.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика грузового транспорта</td>
<td class="right">9</td>
<td class="right">6</td>
<td class="left">S7.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Датчик завершения проезда рампы</td>
<td class="right">9</td>
<td class="right">7</td>
<td class="left">S3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий датчика завершения проезда рампы</td>
<td class="right">9</td>
<td class="right">8</td>
<td class="left">S3.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="left">Дополнительный светофор U+</td>
<td class="right">10</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 7</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дополнительный светофор GND</td>
<td class="right">10</td>
<td class="right">2</td>
<td class="left">R6.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 8</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">Дополнительное реле</td>
<td class="right">10</td>
<td class="right">3</td>
<td class="left">R8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Общий дополнительного реле</td>
<td class="right">10</td>
<td class="right">4</td>
<td class="left">R8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Дтчик завершения проезда рампы</td>
<td class="right">10</td>
<td class="right">5</td>
<td class="left">S3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика завершения проезда рампы</td>
<td class="right">10</td>
<td class="right">6</td>
<td class="left">S3.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Резервный датчик</td>
<td class="right">10</td>
<td class="right">7</td>
<td class="left">S8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий резервного датчика</td>
<td class="right">10</td>
<td class="right">8</td>
<td class="left">S8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-8-6-7" class="outline-4">
<h4 id="sec-8-6-7"><span class="section-number-4">8.6.7</span> Оценка максимального кол-ва подключений устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrumah">unrumah</span></span></h4>
<div class="outline-text-4" id="text-8-6-7">
<p>
Максимальная комплектация, оплата совмещённая с выездной стойкой в вариантах на
чеках и картах.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Фискальный регистратор / Термопринтер</td>
<td class="left">Искра ПРИМ-21К 03 / Custom VKP80II</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Сканер штрихкодов широкополосный / Приёмник карт Mifare+</td>
<td class="left">Honywell IS3480 QuantumE / не выбирали</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Диспенсер карт Mifare+ / Ресайклер карт Mifare+</td>
<td class="left">&#xa0;</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Считыватель карт Em-Marine / Mifare</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long</td>
<td class="left">6800 / SPI / I2C</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дисплей цветной графический TFT-LCD</td>
<td class="left">Winstar / Long</td>
<td class="left">RGB / MCU</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Купюроприемник / Ресайклер купюр</td>
<td class="left">CashCode SM (MSM)</td>
<td class="left">ID003 / CCNET cmpt.RS232</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Монетоприемник / Ресайклер монет</td>
<td class="left">ICT UCA2</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Диспенсер купюр</td>
<td class="left">Puloon LCDM-1000/2000/4000</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Хоппер</td>
<td class="left">ICT Leonid Mini Hopper</td>
<td class="left">ccTalk cmpt.RS232</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">POS банк-терминал</td>
<td class="left">не выбрана</td>
<td class="left">USB / Ethernet</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">Вввод RS-485</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Вывод RS-485</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">GSM промышленный</td>
<td class="left">не выбрана</td>
<td class="left">GPRS RS-232</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Интерфесы</th>
<th scope="col" class="left">Подключаемое оборудование</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Основные GPIO (o)</td>
<td class="left">Шлагбаум (3)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Светофор (3)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Доп. реле (3) ???</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Основные GPIO (i)</td>
<td class="left">Токовые петли (3)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Конц. шлагбаума (2)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Фотоэл. безоп. (1)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Датчик грузового (1)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Основные GPIO (i/o)</td>
<td class="left">Арбитраж (1)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">I2C GPIO</td>
<td class="left">Универсальные кнопки (8)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">I2C + 1 GPIO@I2C</td>
<td class="left">Малый дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">[TODO:unrimah] ???</td>
<td class="left">Большой дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">I2C-GPIO-Wiegand26</td>
<td class="left">Считыватель карт MF/EH</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">I2C-RS232 not isolated</td>
<td class="left">Принтер/Фиск. регистратор</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">+1  RS232 not isolated</td>
<td class="left">сканер ШК/приемник MF+</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">I2C-RS485 isolated</td>
<td class="left">Табло своб. мест</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">+1  RS485 isolated</td>
<td class="left">not used in base</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">I2C+I2S</td>
<td class="left">Аудио</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Интерфейсы</th>
<th scope="col" class="left">Подключяемое оборудование</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">I2C-RS232</td>
<td class="left">Диспенсер карт Mifare+ / Ресайклер карт Mifare+</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">I2C-RS232-ID003/ccNET</td>
<td class="left">Купюроприемник / Ресайклер купюр</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">I2C-RS232</td>
<td class="left">Монетоприемник / Ресайклер монет</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">I2C-RS232</td>
<td class="left">Диспенсер купюр</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">I2C-RS232-ccTALK</td>
<td class="left">Хоппер</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">I2C-RS232</td>
<td class="left">Industrial Cell Network Modem</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">USB</td>
<td class="left">POS банковский терминал</td>
<td class="left">Есть вопрос, подключать ли прямо в ВВВ</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">или городить отдельный хаб на extBoard,</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">можно это оставить на переразводку</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">home edition</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-8-6-8" class="outline-4">
<h4 id="sec-8-6-8"><span class="section-number-4">8.6.8</span> Стандартные комплекты периферийных устройств</h4>
<div class="outline-text-4" id="text-8-6-8">
</div><ol class="org-ol"><li><a id="sec-8-6-8-1"></a>Въездная / выездная стойка с выдачей бумажного билета, СКУД и IP-связью (пилот)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span><br  /><div class="outline-text-5" id="text-8-6-8-1">
<p>
[TODO:unrimah] Привести таблицу в понятный тебе вид.
</p>

<p>
Функционирование оборудования из данного списка должно быть реализвано в пилотном проекте.
</p>

<p>
Также подключены светофор и табло со счётчиком мест.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
<th scope="col" class="left">Важность для работы сиситемы и функционал</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Термопринтер / Сканер штрих-кода</td>
<td class="left">Custom VKP80II / Honywell IS3480 QuantumE</td>
<td class="left">RS-232</td>
<td class="left">Опрашиваемое и критичное - при выходе из строя или определённых сигналов с датчиков блокировка проезда по чекам</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Считыватель карт Em-Marine</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
<td class="left">Опциональное (возможно ли сделать опросным?) - при неиспр. блок. СКУД</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long / МЭЛТ</td>
<td class="left">[TODO:unrimah]</td>
<td class="left">Опциональное</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Таблое свеетодиодное, счетчик мест (опц)</td>
<td class="left">не выбрана</td>
<td class="left">RS-485 IN</td>
<td class="left">Опциональное</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="left">Вывод на динамик</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">&#xa0;</td>
<td class="left">Опциональное</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Вывод на микрофон</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">&#xa0;</td>
<td class="left">Опциональное</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">7</td>
<td class="left">Шлагбаум вверх</td>
<td class="left">R1</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле подаётся напряжение на плату управления шлагбаума, стрела поднимается</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Шлагбаум вниз</td>
<td class="left">R2</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле подаётся напряжение на плату управления шлагбаума, стрела опускается</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Шлагбаум стоп</td>
<td class="left">R3</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле подаётся напряжение на плату управления шлагбаума, движение стрелы принудительно останавливается</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Светофор сигнал 1</td>
<td class="left">R4</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле ток идёт на группу диодов светофора зелёного цвета</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">Светофор сигнал 2</td>
<td class="left">R5</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле ток идёт на группу диодов светофора красного цвета</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">12</td>
<td class="left">Датчик присутсвия автомобиля А</td>
<td class="left">S1</td>
<td class="left">&#xa0;</td>
<td class="left">В случае отсутсвия сигнала - система не работает корректно, отключаемо оператором</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Датчик присутсвия автомобиля Б</td>
<td class="left">S2</td>
<td class="left">&#xa0;</td>
<td class="left">В случае отсутсвия сигнала - система не работает корректно, отключаемо оператором</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">Концевки открытия шлагбаума</td>
<td class="left">S5</td>
<td class="left">&#xa0;</td>
<td class="left">Если есть сигнал - система думает, что шлг. открыт</td>
</tr>

<tr>
<td class="right">15</td>
<td class="left">Концевик закрытия шлагбаума</td>
<td class="left">S6</td>
<td class="left">&#xa0;</td>
<td class="left">Если есть сигнал - система думает, что шлг. закрыт</td>
</tr>

<tr>
<td class="right">16</td>
<td class="left">Фотоэлемент безопасности</td>
<td class="left">S7</td>
<td class="left">&#xa0;</td>
<td class="left">Если есть сигнал - система думает, что на линии ф/э ннчего нет, если нет - сигнал на реле шлагбаум стоп</td>
</tr>

<tr>
<td class="right">17</td>
<td class="left">Кнопка 1 - Печать билета</td>
<td class="left">B1</td>
<td class="left">&#xa0;</td>
<td class="left">Отправка команды на принтер на печать билета и срабатывание арбитража, если надо</td>
</tr>

<tr>
<td class="right">18</td>
<td class="left">Кнопка 2 - Вызов оператора (IP-связь)</td>
<td class="left">B2</td>
<td class="left">&#xa0;</td>
<td class="left">Вызов по IP-связи на установленный в настройках стойки терминал связи</td>
</tr>

<tr>
<td class="right">19</td>
<td class="left">Кнопка 3 - Разблокировка</td>
<td class="left">B3</td>
<td class="left">&#xa0;</td>
<td class="left">Вывод стойки из состояния блокировки, в которое она может войти в случе неиспрвности критичного устрйоства</td>
</tr>

<tr>
<td class="right">20</td>
<td class="left">Кнопка 4 - Завпрос открытия шлг.</td>
<td class="left">B4</td>
<td class="left">&#xa0;</td>
<td class="left">Отправка команды на открытие шлагбаума (опционально в настройках - либо всегда, либо только при наличии машины, либо только в состоянии блокировки)</td>
</tr>
</tbody>
</table>
</div>
</li></ol>
</div>

<div id="outline-container-sec-8-6-9" class="outline-4">
<h4 id="sec-8-6-9"><span class="section-number-4">8.6.9</span> Максимальная комплектация, оплата совмещённая с выездной стойкой в вариантах на чеках и картах.</h4>
<div class="outline-text-4" id="text-8-6-9">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Фискальный регистратор / Термопринтер</td>
<td class="left">Искра ПРИМ-21К 03 / Custom VKP80II</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Сканер штрихкодов широкополосный / Приёмник карт Mifare+</td>
<td class="left">Honywell IS3480 QuantumE / не выбирали</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Диспенсер карт Mifare+ / Ресайклер карт Mifare+</td>
<td class="left">&#xa0;</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Считыватель карт Em-Marine / Mifare</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long</td>
<td class="left">6800 / SPI / I2C</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дисплей цветной графический TFT-LCD</td>
<td class="left">Winstar / Long</td>
<td class="left">RGB / MCU</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Купюроприемник / Ресайклер купюр</td>
<td class="left">CashCode SM (MSM)</td>
<td class="left">ID003 / CCNET cmpt.RS232</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Монетоприемник / Ресайклер монет</td>
<td class="left">ICT UCA2</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Диспенсер купюр</td>
<td class="left">Puloon LCDM-1000/2000/4000</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Хоппер</td>
<td class="left">ICT Leonid Mini Hopper</td>
<td class="left">ccTalk cmpt.RS232</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">POS банк-терминал</td>
<td class="left">не выбрана</td>
<td class="left">USB / Ethernet</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">Вввод RS-485</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Вывод RS-485</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">GSM промышленный</td>
<td class="left">не выбрана</td>
<td class="left">GPRS RS-232</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-sec-8-7" class="outline-3">
<h3 id="sec-8-7"><span class="section-number-3">8.7</span> Программная платформа</h3>
<div class="outline-text-3" id="text-8-7">
</div><div id="outline-container-sec-8-7-1" class="outline-4">
<h4 id="sec-8-7-1"><span class="section-number-4">8.7.1</span> <span class="todo TODO">TODO</span> Архитектура программного обеспечения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span>&#xa0;<span class="ranma">ranma</span></span></h4>
<div class="outline-text-4" id="text-8-7-1">
<p>
Итак, у нас есть <code>бизнес-логика</code> и <code>нижний уровень</code>. Первая занимается проводом
машин через стойки и всеми сопутствующими процессами. Второй отвечает за
взаимодействие с устройствами.
</p>

<p>
Еще у нас есть база данных PostgreSQL, в которой хранится конфигурационная
информация. Доступ к ней осуществляют оба уровня, свободно и равноправно.
<code>!!</code> Конфигурационная информация - это всего пара таблиц. Помимо них там содержится
актуальная рабочая информация (билетики за смену и их статус)
[COMMENT:ranma] К сожалению, это не пара таблиц. Только описанию устройств нужно
3 штуки сейчас. Сколько их нужно бизнес-логике, я не знаю.
[COMMENT:rigidus] По существу способ доступа это не меняет, будь их хоть три тысячи
</p>

<p>
Между собой бизнес-логика и нижний уровень взаимодействуют, посылая json другу
через tcp/ip. Управляет этим nginx, в конфигурации которого прописаны виртуальные
хосты, которые указывают на endpoint-ы, принимающие пакеты.
[COMMENT:ranma] nginx ничем не управляет, он просто проксирует пакеты на хосты.
[COMMENT:ranma] Зоной ответственнисти ConfigurationManager-a или SettingComponent
или DependencyInjectionContainer - как не назови является именно это - поиск
endpoint-a чтобы отправить ему соообщения. У нас все эндпойнты опишутся в конфиге
нжинкса и все
</p>

<p>
Бизнес-логика работает с командами "абстрактных устройств" (например дисплеем),
отправляя команды вида "отобразить на дисплей такую-то строку" через nginx. Нижний
уровень преобразует это в набор команд конкретного установленного устройства
(которых может быть много разных видов с разными наборами команд).
</p>

<p>
В случае возникновения прерываний от устройств нижний уровень обрабатывает эти
прерывания и формирует сообщения для уровня бизнес-логики, передавая их json-ом
через nginx.
[COMMENT:ranma] Поскольку эти прерывания не являются прерываниями в прямом смысле
слова. Мы их называем событиями.
[COMMENT:rigidus] Здесь не очень понятно. Нижний уровень что же - постоянно
опрашивает пины к которым подключены девайсы? Как работа с той же кнопкой на стойке
тогда происходит, если она прерывания не выдает?
</p>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-1"></a>Уровни и компоненты архитектуры<br  /><div class="outline-text-5" id="text-8-7-1-1">
<p>
[TODO:ranma] - Выкинуть все какашки (почистить). Я очень хочу чтобы я прочитал весь
этот раздел и сказал: "Ага, тут все понятно".
[COMMENT:ranma] Я тоже этого офигеть как хочу. Но это получится не с первой итерации
скорее всего.
[COMMENT:rigidus] - Ладно, если конкретных действий не последовало, я четко и на
великом могучем распишу что конкретно мне тут непонятно. Надеюсь все получат
удовольствие.
</p>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-1-1"></a>Глоссарий&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-1-1">
<p>
[TODO:pyub:ranma:rigidus] - Предлагаю снести этот раздел, т.к. тавтология. И
вообще, что это за ерунда, когда у нас глоссарий идет в одном уровне со всей этой
слоистой лазаньей, а в последнем хидере лазаньи описываются компоненты? Это что
еще за иерархия в стиле Дали?
</p>

<p>
<code>Layer</code> - слой, часть ПО, разрабатываемая единым образом и решающая набор однотипных
задач либо единую задачу в своих терминах, типах данных и со своим набором методов
коммуникации с остальными слоями.
</p>

<p>
[COMMENT:rigidus] - Соблюдайте вашу конституцию (с), т.е. PMBOOK: Слой - это
набор компонентов на одном уровне абстракции, выделенный таким образом, что
интерфейсы взаимодействия между слоями строго определены (контрактом на
интерфейсы слоя) и минимизированы.
.
Делается все это для того, чтобы компоненты не взаимодействовали в режиме "все со
всеми", иначе так и запутаться можно, т.к. высокая связность.
.
Компонент - это иерархия взаимодействующих экземпляров классов, решающих одну
задачу. К примеру в винде IIS (web-server) - это компонент операционной
системы.
.
Классический пример слоя, состоящего из компонентов - это HAL (Hardware
Abstraction Layer) в System/38 - он содержит в себе несколько сотен компонентов,
например в нем присутствует компонент "компилятор", который генерирует
"абстрактный" машинный код и компонент "виртуальная машина", который этот код
исполняет. Все это надо чтобы при портировании на другую архитектуру переписать
только виртуальную машину, а не все сразу.
.
Нам такое не надо, у нас уже есть операционная система, по сравнению с которой
мы - глазурь на ром-бабе. Нам только нужно отделить бизнес-логику от обработки
событий устройств, чтобы они не перепутались и чтобы отлаживать было легче (и
зоны ответственности поделить, чтобы не лазать в код друг друга)
</p>

<p>
<code>BusinessLogic</code> - всё, что связано с логикой работы системы
</p>

<p>
<code>Hardware</code>, <code>HW</code> - всё, что связано с оборудованием
</p>

<p>
<code>Presentation</code> - представление конкретного оборудования в памяти в виде структур
данных и событий.
[COMMENT:rigidus] - ненужно
</p>

<p>
<code>Software</code> - всё, что связано с исполняемым ПО
[COMMENT:rigidus] - ненужно
</p>

<p>
<code>UI</code> (user interface) - всё, что связано с интерфейсом пользователя
[COMMENT:rigidus] - ненужно
</p>

<p>
<code>Component</code> - функциональный блок в составе архитектуры проекта, описывающий решение
отдельной задачи.
[COMMENT:rigidus] - неверно, см. выше. Мы <code>не можем</code> понимать под общепринятыми
терминами каждый свое
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-2"></a>Слой <code>BusinessLogicLayer</code><br  /><div class="outline-text-6" id="text-8-7-1-1-2">
<p>
<code>BusinessLogicLayer</code> - это слой описания конкретных процессов для абстрактного
функционального оборудования. По сути - большой конечный автомат, решающий
всю задачу бизнес-логики. Декомпозиция возможна по мере уместности, но без очевидной
необходимости мы не будем на это тратить время, надо писать конкретику.
</p>

<p>
<code>BusinessLogicLayer</code> общается с <code>HardwarePresentationLayer</code>, передавая ему команды и
получая вызовы и данные от абстрактных устройств, вне зависимости от того, какое
конкретное устройство реализует функционал на практике.
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-3"></a>Слой <code>HardwarePresentationLayer</code><br  /><div class="outline-text-6" id="text-8-7-1-1-3">
<p>
<code>HardwarePresentationLayer</code> - это нижний слой архитектуры на котором конкретное
оборудование преобразуется в абстрактное представление для <code>BusinessLogicLayer</code>. Это
то как для бизнес-логики выглядят конкретные устройства.
</p>

<p>
<code>!!</code> Описание компонентов существенно отрефакторено.
</p>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-1-3-1"></a>Компонент <code>DevicePresentationComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-1-3-1">
<p>
<code>DevicePresentationComponent</code> - это родительский компонент для компонентов, отвечающих за работу
непосредственно с подключенным оборудованием. Его наследники: <code>DisplayPresentationComponent</code>,
<code>PrinterPresentationComponent</code>, <code>POSPresentationComponent</code>, <code>SchlagbaumPresentationComponent</code>
и прочие подобные. Каждый из них отвечает за прием данных от соответствующего наследника
<code>HWDeviceComponent</code> и от <code>BusinessLogicLayer</code> и за преобразование принятых данных в абстрактное
представление из реального и обратно, а также за настройку своего оборудования.
</p>

<p>
Возможно реализовать настройку через <code>DeviceSettingsComponent</code> (и его наследников), но я
предлагаю эти поля и методы вносить внутрь <code>DevicePresentationComponent</code> (и его наследников).
</p>

<p>
Коммуникацию и её настройку предлагаю рассматривать так же, как любое другое оборудование, чтобы
не плодить сущностей.
</p>

<p>
[COMMENT:rigidus] - Я не понимаю, зачем нам компоненты, когда по сути - это
классы, и их можно назвать <code>Device</code> (родительский) <code>Display</code>, <code>Printer</code>,
<code>PosTerminal</code>, <code>Scрlagbaum</code> и.т.п. Это будут абстрактные классы устройств, а
конкретные можно назвать точно также, только добавив название марки или
отличительных признаков устройства, например <code>DisplayWinstar1602A</code>. Это никак не
мешает делать наследование и полиморфизм, и мы избавимся от идиотских
"компонентов" которые компонентами не являются.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-1-4"></a>Слой <code>DriverLayer</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-1-4">
<p>
Это аппаратно-зависимые компоненты - драйвера конкретных устройств, устанавливаемые,
как модули ядра. Большинство модулей уже имеется в ядре Linux, как-то GPIO,
коммуникациционный стек, etc.
Драйверы могут понадобиться для редких дисплеев, некоторых RTC и иной периферии.
</p>

<p>
Пока таких нет (т.к. все работает стандартными средствами). Пока не появятся -
уровень будет без наполнения.
</p>

<p>
[COMMENT:rigidus] - Раз таких нет, то этот уровень следует убрать. Если появятся -
определить не проблема
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-5"></a>Обособленный слой <code>SettingLayer</code> - гипотетический. PostgreSQL.&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-1-5">
<p>
<code>!!</code> Предполагается реализовать описанный ниже функционал в составе сооветствующих компонентов.
Реализовывать в том виде, в котором написано, <code>SettingsLayer</code>, не предполагаем. Оставляем в
тексте для справки.
</p>

<p>
<code>DeviceSettingsComponent</code> - гипотетический компонент, реализуемый как часть других компонентов,
имеющих какие-либо настройки.
[COMMENT:ranma] Он стал вместо Hardware
[COMMENT:rigidus] - Удаляем?
</p>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-1-5-1"></a>Компонент <code>CommunicationSettingComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-1-5-1">
<p>
<code>!!</code> Принцип работы не отличается от общего <code>DeviceSettingsComponent</code>
</p>

<p>
<code>CommunicationSettingComponent</code> - это компонент, оперирующий всеми настройками
коммуникационного оборудования для работы с контроллером. Например, скорость работы
с COM-портом для общения конкретного устройства с контроллером.
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-5-2"></a>Компонент <code>DeviceSettingComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-1-5-2">
<p>
<code>!!</code> Принцип работы не отличается от общего <code>DeviceSettingsComponent</code>
[COMMENT:ranma] Вот это уже избыточность. У меня не было отдельно хард, отдельно девайс.
Надо оставить один из них и пусть это будет Device.
</p>

<p>
[COMMENT:ranma] Считывает настройки из базы, по пинку - перечитывает.
</p>

<p>
<code>DeviceSettingComponent</code> - это компонент, оперирующий конкретными командамми
настроек оборудования (например, скорость печати принтера). По сути на это уровень
диспетчиризации между BL и железом по протоколу предоставленному разработчиком.
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-5-3"></a>Компонент <code>BusinessLogicSettingComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-1-5-3">
<p>
<code>!!</code> Считываем настройки из базы, по пинку - перечитываем.
</p>

<p>
<code>BusinessLogicSettingComponent</code> - настройки бизнес-логики, т.е. работы системы в
зависисмости от различных условий.
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-5-4"></a>Компонент <code>SoftwareSettingComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-1-5-4">
<p>
<code>!!</code> Считываем настройки из базы, по пинку - перечитываем.
</p>

<p>
<code>SoftwareSettingComponent</code> - настройка функционирования ПО (например, логирование,
настройки пользователей и ролей), находящиеся в неком хранилище (базе данных).
</p>
</div>
</li>

<li><a id="sec-8-7-1-1-5-5"></a>Компонент <code>NotificationComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-1-5-5">
<p>
<code>!!</code> Реализуем через nginx и json-мессаги.
</p>

<p>
<code>NotificationComponent</code> - оповещает все архитектурные слои о произошедшем изменении
настроек.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-1-6"></a>Слой <code>UILayer</code> - web-интерфейсы удаленного доступа. Состоит из:&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-1-6">
<p>
<code>SWUIcomponent</code> это различные операторские и администраторские web-интерйесы
серверов и контроллеров (ПО управления парковкой).
</p>

<p>
Вычеркиваем гипотетический <code>HWUIComponent</code> - его поведение заложено в <code>BusinessLogicLayer</code>,
а реализация делается в <code>HardwarePresentationLayer</code>.
</p>

<p>
[COMMENT:rigidus] - Кто-нибудь может мне объяснить зачем это выделять в отдельный
слой и почему он необходим (цель?)
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-2"></a>Архитектура уровня представления [справочно]<br  /><div class="outline-text-5" id="text-8-7-1-2">
<p>
<code>!!</code> Этот раздел приводится для справки, т. к. предполагаются существенные упрощения в
реализации. По мере реализации будет правильным вносить исправления в этот раздел.
[COMMENT:ranma] Существенных упрощений реализации здесь не вижу, но конечно все готов
обсуждать в разумных  пределах.
</p>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-2-1"></a>Абстрактный базовый класс CBaseDevice<br  /><div class="outline-text-6" id="text-8-7-1-2-1">
<p>
Является базовым классом для классов устройств.
Реализует паттерн Strategy для конкретных классов от базовых CBaseCodec
и CBaseCommCtl.
</p>

<p>
[TODO:pyub:ranma:rigidus] - Паттерн "стратегия" нужен в недостаточно
выразительных языках для того чтобы выбрать поведение, которое требуется
реализовать в зависимости от входных данных и окружающих условий (например
конфига) таким образом, чтобы для клиента это было незаметно.
</p>

<p>
Напоминаю, что что у нас входные данные <code>всегда</code> являются json-сообщением, в
котором явно указан адресат (т.е. клиент знает кому посылает), а задача <code>изменения</code>
поведения решается на уровне бизнес-логики. Паттерн "стратегия" тут не нужен,
излишен, и вреден, т.к. ведет к нецелесообразному усложнению. Хороших результатов
можно достичь, отказавшись от него и анализируя конфигурацию (единственное что
может меняться на лету) прямо в методе, который выполняет действие.
</p>

<p>
Реализует композицию для подключения уровня SettingsLayer для доступа
классов устройств к своим настройкам.
Предоставляет интерфейс классам конкретных устройств.
</p>

<p>
[TODO:pyub:ranma:rigidus] - Композиция нужна в недостаточно выразительных языках
для того, чтобы объединить объекты в древовидную иерархию так, чтобы клиенты не
видели разницы при обращении к группе или к одному из объектов. Это упрощает
жизнь клиентам. Зачем использовать композицию для подключения постгресса (а мы
договорились что у нас Settings - это постгресс) я не понимаю. Каждый из классов
устройств может сам открыть соединение с постгрессом, взять свои настройки и
сконфигурировать себя, руки не отвалятся. Зато что-то может отвалиться, если у
нас будет "Диспетчер конфигурации", через который будет проходить все общение с
постгрессом - это оверинжиниринг
</p>

<p>
[COMMENT:ranma] ЕРЕСЬ! На костер его :). Ну кроме БД, здесь есть тонкости, например,
если какой-то процесс будет брать настройку каждые 5 мс из базы, а закешировать ее
негде, так как мы убрали код-прослойку, то из-за этого будет тупить ВСЁ. И отловить
такую проблему будет сложно.
Кэшировать прямо в классе можно, но такая практика ведет к говнокоду.
Я хочу сказать, что для разных уровней требуются свои инструменты и применять к
стойке-железке энтерпрайз-решения не есть гуд. Это просто железка.
Энтерпрайз будет нужен начиная с уровня сервера парковки и выше. IMHO.
[COMMENT:rigidus] - Вы таки мало юзали Postgres - для него эти 5 mc - как слону
дробина, он сам закеширует в оперативке и будет отдавать со скоростью мысли. А
вот если кто-то будет кешировать у себя - он сразу поймает проблемы с правильной
инвалидацией кэша (по этой теме диссеры пишутся) и сопутствующий ад в
отладке. Ранма, ты этого не хочешь, ты хочешь все быстро сделать и чтобы не
глючило.
</p>

<p>
<code>!!</code> [COMMENT:unrimah] CBaseDevice нужен, но делаем его примитивным. SettingsLayer
у нас очень, очень виртуальный.
[COMMENT:ranma] Он и не собирался быть сложным: 2 указателя и виртуальные функции
обращения к конкретному устрйоству.  В нем почти вообще не будет кода.
[COMMENT:rigidus] - тогда давай его в базовый класс, в конструктор и вообще не
будем на этом останавливаться. Я бы уже посмотрел бы пример кода, например так:
</p>

<div class="org-src-container">

<pre class="src src-cpp"><span style="color: #00cdcd; font-weight: bold;">class</span> <span style="color: #00cdcd;">CBaseDevice</span> {
<span style="color: #00cdcd; font-weight: bold;">public</span>:
    <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">CBaseDevice</span>() {
        ...
    };
};
</pre>
</div>
</div>
</li>

<li><a id="sec-8-7-1-2-2"></a>класс CDeviceFactory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-2">
<p>
[TODO:pyub:ranma:rigidus] - Абстрактная фабрика нужна для того, чтобы создавать
компоненты - т.е. иерархии классов так, чтобы не специфицировать их
зависимости. В нашей задаче нет зависимостей между устройствами, например нет
такого что если одно устройство не запустилось, то мы не должны запускать другое.
</p>

<p>
Зависимости между устройствами для изменения поведения - это дела уровня
отвечающего за поведение. Таким образом фабрика тут не нужна.
</p>

<p>
Реализует паттерн Abstract Factory для классов конкретных устройств.
</p>

<p>
<code>!!</code> [COMMENT:unrimah] Фабрика действительно под большим вопросом.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-3"></a>класс конкретного устройства<br  /><div class="outline-text-6" id="text-8-7-1-2-3">
<p>
Реализует функционал коммуникации с устройством, периодического опроса и
формирования сигналов состояния.
</p>

<p>
например CBarrierReleDown это устройство управления реле для опускания шлагбаума.
Протокол для пина отсутствует.
Пин управляет физическим импульсом опускания шлагбаума.
</p>

<p>
[COMMENT:rigidus] - Давай их хотя бы перечислим тут.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-4"></a>Абстрактный базовый класс CBaseCodec&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-4">
<p>
[TODO:pyub:ranma:rigidus] - Как мы уже выяснили, кодеки протоколов нам не нужны,
потому что все взаимодействие между устройством и обслуживающим его классом
инкапсулировано в методах обслуживающего класса. Соответственно не нужен и
абстрактный класс для кодеков протоколов.
</p>

<p>
<code>!!</code> [COMMENT:unrimah] Подача имеет смысл. Функционал кодека нужен, но если
мы можем без потерь реализовать его методом внутри <code>XXXPresentationComponent</code>,
не вижу повода делать иначе.
</p>

<p>
Является базовым классом для классов кодеков протоколов.
Создание объектов управляется классом конкретного устройства.
Конкретный кодек подключается как Strategy к
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-5"></a>класс CCodecFactory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-5">
<p>
<code>!!</code> См. CBaseCodec
</p>

<p>
[TODO:pyub:ranma:rigidus] - Как мы уже выяснили, кодеки протоколов нам не нужны,
потому что все взаимодействие между устройством и обслуживающим его классом
инкапсулировано в методах обслуживающего класса. Соответственно не нужен и
абстрактный класс для кодеков протоколов.
</p>

<p>
Реализует паттерн Abstract Factory для классов кодеков протоколов.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-6"></a>класс конкретного кодека для протокола&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-6">
<p>
<code>!!</code> См. CBaseCodec
</p>

<p>
[TODO:pyub:ranma:rigidus] - Как мы уже выяснили, кодеки протоколов нам не нужны,
потому что все взаимодействие между устройством и обслуживающим его классом
инкапсулировано в методах обслуживающего класса.
</p>

<p>
Более того, не требуется в рантайме создавать оберткут протокола, потому что
протокол взаимодействия с устройством известен еще до компиляции и описан в доках
на устройство. Что касается encode|decode json-сообщений, я надеюсь у нас нет с
этим проблем.
</p>

<p>
Реализует функции encode и decode, которые сериализуют  и десериализуют
данные и создают обертку для них согласно протоколу.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-7"></a>класс CBaseCommCtl&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-7">
<p>
<code>!!</code> См. CBaseCodec - коммуникационное оборудование рассматриваем как любое другое.
</p>

<p>
[TODO:pyub:ranma:rigidus] - Настроить UART можно в конструкторе объекта
устройства. Этим мы избавляемся от необходимости применения паттерна стратегии и
сохраняем вещи простыми. Вам вообще-то это еще и отлаживать&#x2026;
</p>

<p>
Является базовым классом для классов управления коммуникационными каналами
связи: UARTs, GPIO, TCP/IP sockets.
То есть конкретных классов будет 3 штуки.
Конкретный класс подключается как Strategy к классу устройства.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-8"></a>класс CCommCtlFactory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-8">
<p>
<code>!!</code> См. CBaseCodec - коммуникационное оборудование рассматриваем как любое другое.
</p>

<p>
[TODO:pyub:ranma:rigidus] - О нет, опять. Чтобы настроить самое сложное из этого
нужно четыре функции: socket, bind, accept, connect. Зачем тут фабрика?
</p>

<p>
Реализует паттерн Abstract Factory для классов управления коммуникационными каналами.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-9"></a>класс конкретного комм. канала&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-9">
<p>
<code>!!</code> См. CBaseCodec - коммуникационное оборудование рассматриваем как любое другое.
</p>

<p>
[TODO:pyub:ranma:rigidus] - То же что выше
</p>

<p>
CUartCtl - настраивает уарт согласно параметрам.
CPinCtl - настраивает пин согласно параметрам.
CTcpSocketCtl - настраивает сокет, запускает сервер или коннектится клиентом,
поддерживает соединение установленным.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-10"></a>класс CAbstractDeviceManager&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-10">
<p>
<code>!!</code> Если мы этот функционал в итоге можем провести через <code>XXXPresentationComponent</code>,
возможно, лучше так и сделать.
</p>

<p>
[TODO:pyub:ranma:rigidus] - Это все - дело веб-интерфейса, который лазает в
постргресс за статистикой. Ничего не надо линковать, если у нас есть базовый
класс CDisplay у которого есть дочерний CDisplay16x2. И бизнес-логика дергает его
за перегруженные методы.
</p>

<p>
Предоставляет API для доступа к статистике по абстрактным устройствам и для
доступа к API самих абстрактных устройств.
Создает классы абстрактных устройств и линкует их с классами конкретных устройств.
Включает в себя TCP/IP сервер, к которому может подключаться как бизнеслогика,
так и бэк-енд веб морды для непосредственного контроля или даже ручного управления.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-11"></a>класс абстрактного устройства CAbstractDevice&lt;Type&gt;&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-11">
<p>
<code>!!</code> См. CAbstractDeviceManager
</p>

<p>
[TODO:pyub:ranma:rigidus] - Не надо ничего предоставлять, все уже и так знают,
какой json послать устройству, а устройство в курсе, что с этим json-ом делать.
</p>

<p>
Содержит структуры данных, представляющие любое устройство данного функционального назначения.
Предоставляет API для доступа к этим данным.
</p>
</div>
</li>

<li><a id="sec-8-7-1-2-12"></a>класс CDeviceAbstractFactory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-2-12">
<p>
<code>!!</code> См. CAbstractDeviceManager
</p>

<p>
[TODO:pyub:ranma:rigidus] - Не надо ничего создавать, все уже известно еще до
компиляции. Просто напишите код для устройств.
</p>

<p>
Инкапсулирует правила создания абстрактных устройств для одного или нескольких конкретных.
Создает эти устройства.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-3"></a>Что на чём пишем<br  /><div class="outline-text-5" id="text-8-7-1-3">
<p>
<code>BL</code> - LISP [rigidus]
</p>

<p>
<code>SW</code> - PostgreSQL &amp; LISP [rigidus], PostgreSQL &amp; C++ [ranma].
</p>

<p>
Чисто движком БД мы здесь не обойдемся, так как требуются оповещения об изменении
настроек. rigidus утверждает, что обойдемся, есть же триггеры.
[TODO:rigidus] Создание таблиц БД с настройками и триггеров на оповещение об
изменнении настроек.
</p>

<p>
<code>HW,COM</code> - C++,boost [ranma,unrimah]
</p>

<p>
<code>KernelModules</code> - C [ranma,unrimah]
</p>
</div>
</li>

<li><a id="sec-8-7-1-4"></a>Требования к функционалу <code>HardwarePresentationLayer</code><br  /><ol class="org-ol"><li><a id="sec-8-7-1-4-1"></a>Получение данных и формирование событий<br  /><div class="outline-text-6" id="text-8-7-1-4-1">
<p>
Получение данных от датчиков и оборудования и формирование по ним событий для уровня
<code>BusinessLogicLayer</code> по определенным правилам.
</p>

<p>
Организация внутренних таймеров для выработки событий в случаях недостатка датчиков,
согласно ТЗ.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-2"></a>Асинхронная работа с оборудованием по вызовам от <code>BusinessLogicLayer</code><br  /><div class="outline-text-6" id="text-8-7-1-4-2">
<p>
Асинхронная работа с конкретным оборудованием парковки подразумевает возможность
подать команду, запросить состояние или получить событие от оборудования независимо
от текущей работы по с другим оборудованием, если только это оборудование не
разделяет физические ресурсы с тем, с которым в текущий момент нужно вести работу.
</p>

<p>
[TODO:ranma] "Поведение при занятости физического ресурса" - ты говоришь о занятом
порте или сокете?
[COMMENT:ranma] Речь о любом ресурсе, который разделяется между более чем одним внешним устройством.
Да, в тч сокет, порт, пин etc
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-3"></a>Cписок конкретного оборудования, которое должно поддерживаться<br  /><div class="outline-text-6" id="text-8-7-1-4-3">
<p>
В списке абстрактного оборудования (на данный момент он только абстрактный) будут
вложенями даны ссылки на конкретное оборудование: <a href="doc.html#*%d0%9f%d0%b5%d1%80%d0%b8%d1%84%d0%b5%d1%80%d0%b8%d0%b9%d0%bd%d0%be%d0%b5%20%d0%be%d0%b1%d0%be%d1%80%d1%83%d0%b4%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5">периферийное оборудование</a> (в
doc.org)
</p>

<p>
Полное раскрытие списка оборудования, сенсоров и кнопок: <a href="doc.html#*%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D0%B8%20%D0%BA%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D1%83">Подключение периферии к
контроллеру</a> (в doc.org) В графе "Тип устройства" описан абстрактный тип, в графе
"Предполагаемая модель" конкретная модель, в графе "Интерфейс подключения" -
собственно интерфейс.
</p>

<p>
[COMMENT:pyub] До описания протоколов обмена данными мы пока не дошли. Это задача
[TODO:unrimah].
</p>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-4-3-1"></a><span class="todo TODO">TODO</span> Протокол обмена с картоприемником&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span><br  /><div class="outline-text-7" id="text-8-7-1-4-3-1">
<p>
Структуры данных, ссылка.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-3-2"></a><span class="todo TODO">TODO</span> Управление и контроль шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span><br  /><div class="outline-text-7" id="text-8-7-1-4-3-2">
<p>
Команды и события, ссылка.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-3-3"></a><span class="todo TODO">TODO</span> Управление и контроль термопринтера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span><br  /><div class="outline-text-7" id="text-8-7-1-4-3-3">
<p>
Структуры данных, ссылка.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-3-4"></a><span class="todo TODO">TODO</span> Список используемых датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span><br  /><div class="outline-text-7" id="text-8-7-1-4-3-4">
<p>
Уровни логических сигналов для состояний.  <a href="doc.html#*%D0%92%D0%B2%D0%BE%D0%B4%D1%8B%20%D1%81%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D0%BE%D0%B2%20%D1%81%20%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA%D0%BE%D0%B2">Вводы сигналов с датчиков</a>
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-3-5"></a><span class="todo TODO">TODO</span> Список кнопок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span><br  /><div class="outline-text-7" id="text-8-7-1-4-3-5">
<p>
Уровни логических сигналов для состояний.
</p>

<p>
<a href="doc.html#*%D0%92%D0%B2%D0%BE%D0%B4%D1%8B%20%D1%81%20%D0%BA%D0%BD%D0%BE%D0%BF%D0%BE%D0%BA">Вводы с кнопок</a>
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-4-4"></a>Асинхронная работа с коммуникационным оборудованием - переработать раздел по мере реализации<br  /><div class="outline-text-6" id="text-8-7-1-4-4">
<p>
<code>!!</code> [COMMENT:unrimah] Настойчиво предлагаю коммуникационное оборудование от другого не отличать.
Я не вижу корректного места в системе для <code>CommunicationComponent</code>.
[COMMENT:ranma] Корректное место для него следующее: устройство
одного и того же вида может иметь как Etherner, так и RS-485 и подключаться по обстоятельствам
к разным коммуникационным устройствам, или еще пример: один шлагбаум управляется по пинам, другой
по RS-232? И как ты их будешь подключать, если не будет гибкой архитектуры подключения разных
коммуникационных устройств для одного реального устройства?
</p>

<p>
<code>Асинхронная работа</code> - это работа с каналом связи без блокировки этого канала при
передаче по нему данных.
</p>

<p>
теы с любым каналом связи без
необходимости блокировки как остальных каналов, так и текущего активного канала
</p>

<p>
с коммуникационным оборудованием подразумевает возможность
приема/передачи данных независимо от текущей работы по с другим коммуникационным
оборудованием.
</p>

<p>
Список каналов:
</p>
<ul class="org-ul">
<li>communication ports
</li>
<li>IO pins
</li>
<li>usb
</li>
<li>ethernet (tcp/ipv4)
</li>
</ul>
</div>

<ol class="org-ol"><li><a id="sec-8-7-1-4-4-1"></a>Список оборудования, подключаемого к <code>CommunicationComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-4-4-1">
<p>
Оборудование, подключаемое к <code>CommunicationComponent</code>
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-4-2"></a>Список датчиков, подключаемых к <code>CommunicationComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-4-4-2">
<p>
Оборудование, подключаемое к <code>GPIO</code> - датчики 'сухой контакт'.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-4-3"></a>Список реле, подключаемых к <code>CommunicationComponent</code><br  /><div class="outline-text-7" id="text-8-7-1-4-4-3">
<p>
Оборудование, подключаемое к <code>GPIO</code> - управление типа 'реле'.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-4-4"></a>Список оборудование, подключаемого к usb<br  /><div class="outline-text-7" id="text-8-7-1-4-4-4">
<p>
Оборудование, подключаемое к <code>usb</code>.
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-4-5"></a>Ethernet<br  /><div class="outline-text-7" id="text-8-7-1-4-4-5">
<p>
[TODO:pyub:ranma:rigidus] - Кто-то вообще понял о чем это аще?
</p>

<p>
Cвязь с сервером по <code>ethernet</code>: <code>сеансовый уровень</code>.
</p>

<p>
[comment:pyub] связь контроллера с контроллером по <code>ethernet</code>?
[COMMENT:ranma] какого контроллера с каким контроллером?
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-4-5"></a>Преобразование данных между конкретным и абстрактным представлениями<br  /><div class="outline-text-6" id="text-8-7-1-4-5">
<p>
[COMMENT:pyub] Правильно ли я понимаю, что абстрактное представление это, например,
"сигнал датчика арбитража", а конкретное представление - это "12В с реле <code>R7</code> стойки
выигравшей арбитраж на сенсорный ввод <code>S4</code> стойки проигравшей арбитраж"?
[COMMENT:ranma] Да.
</p>

<p>
Список оборудования (на данный момент абстрактный): <a href="doc.html#*%d0%9f%d0%b5%d1%80%d0%b8%d1%84%d0%b5%d1%80%d0%b8%d0%b9%d0%bd%d0%be%d0%b5%20%d0%be%d0%b1%d0%be%d1%80%d1%83%d0%b4%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5">периферийное оборудование</a> (в
doc.org) Полное раскрытие списка с сенсорами и кнопками:
<a href="doc.html#*%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D0%B8%20%D0%BA%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D1%83">Подключение
периферии к контроллеру</a> (в doc.org)
</p>
</div>
</li>

<li><a id="sec-8-7-1-4-6"></a>Чтение настроек оборудования от уровня хранение и обновления - переработать по мере реализации<br  /><div class="outline-text-6" id="text-8-7-1-4-6">
<p>
Чтение настроек для каждого конкретного оборудования от уровня хранения и обновления
настроек <code>SettingsLayer</code>.
</p>

<p>
[TODO] Описание и ссылка
</p>
</div>
</li></ol>
</li>

<li><a id="sec-8-7-1-5"></a>Требования к реализации <code>HardwarePresentationLayer</code><br  /><ol class="org-ol"><li><a id="sec-8-7-1-5-1"></a>Интерфейс обмена с уровнем <code>BusinessLogicLayer</code><br  /><div class="outline-text-6" id="text-8-7-1-5-1">
<ul class="org-ul">
<li>Связь уровней в пилотной версии обеспечивается через протокол TCP/IPv4 на
</li>
</ul>
<p>
localhost.  Порт по выбору разработчика.
</p>
<ul class="org-ul">
<li>Формат данных - JSON
</li>
<li>В продакшн версии обсуждается использование FFI - foreign function interface.
</li>
<li>Формат команды в JSON от <code>BusinessLogicLayer</code> к <code>HardwarePresentationLayer</code>: {
</li>
</ul>
<p>
deviceName:&lt;device name&gt;[, command:&lt;command type&gt;, data:&lt;data structure&gt;] }
[COMMENT:rigidus] - Тут в каждом конкретном устройстве надо специфицировать
</p>
<ul class="org-ul">
<li>Формат команды в JSON от <code>HardwarePresentationLayer</code> к <code>BusinessLogicLayer</code>: {
</li>
</ul>
<p>
deviceName:&lt;device name&gt;[, event:&lt;event type&gt;, data:&lt;data structure&gt;] } event type
может быть в том числе и запросом данных от BusinessLogicLayer.
[COMMENT:rigidus] - Тут в каждом конкретном устройстве надо специфицировать
</p>
</div>
</li>

<li><a id="sec-8-7-1-5-2"></a>Интерфейс настройки оборудования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-5-2">
<p>
Интерфейс к настройкам оборудования должен быть предоставлен уровнем хранения и
обновления настроек <code>SettingsLayer</code>.
</p>

<p>
<code>!!</code> Синонимично доступу к PostgreSQL.
</p>
</div>
</li>

<li><a id="sec-8-7-1-5-3"></a>Интерфейс к коммуникационному оборудованию&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_______">нинужно</span></span><br  /><div class="outline-text-6" id="text-8-7-1-5-3">
<p>
<code>!!</code> Коммуникационое оборудование и его настройки рассматриваем наравне с прочим
оборудованием. С синглтоном - интересная идея, может оказаться удобным.
</p>

<p>
Интерфейс к коммуникационному оборудованию предоставляется операционной системой и
используемым фреймворком.
</p>

<p>
Каждому типу коммуникационного оборудования должен соответствовать шаблонный
синглтон. Каждому конкретному оборудованию - синглтон-инстанс с заданным параметром:
номер оборудования этого типа. OMG, Это требование?!! Это то, как я собираюсь делать,
это обсуждаемо, непредставившийся незнакомец ;).
</p>

<p>
[COMMENT:rigidus] - А зачем синглтон?
</p>
</div>
</li>

<li><a id="sec-8-7-1-5-4"></a>Интерфейс к подключённому оборудованию<br  /><div class="outline-text-6" id="text-8-7-1-5-4">
<p>
Интерфейс к подключенному оборудованию должен быть описан в документации к
конкретному оборудованию. TODO: Список протоколов, подлежащих реализации.
</p>

<p>
Каждому типу оборудования должен соответствовать шаблонный синглтон. Каждому
конкретному оборудованию - синглтон-инстанс с заданным параметром: номер
оборудования этого типа.
</p>

<p>
[COMMENT:rigidus] - А зачем синглтон?
</p>
</div>
</li>

<li><a id="sec-8-7-1-5-5"></a>Стандарт доступа к ресурсам ядра<br  /><div class="outline-text-6" id="text-8-7-1-5-5">
<p>
При разработке <code>HWPresentationLayer</code> на языке С++ необходимо использовать единый
стандарт доступа к ресурсам ядра с помощью определенного стандартного
фреймворка. Использование других возможностей ОС и других фреймворков по умолчанию
запрещено, опционально оговаривается отдельно.
</p>

<p>
Выбор стандарта и фреймворка исходя из требований полной модульности и
кроссплатформенности среди *nix-совместимых ОС.
</p>

<p>
Выбор проводился между:
</p>

<p>
<code>POSIX</code> + <code>STL only</code> - всем известны, долго писать, плодить лишние уровни
архитектуры) - неэффективно
</p>

<p>
<code>STL</code> + <code>boost</code> (boost на старте требует некоторого уровня входа, можно быстро и
легко создавать многопоточный безопасный код, может полностью заменить POSIX, код
получается полностью кроссплатформенный, код долго собирается) - эффективно
</p>

<p>
<code>QT</code> (требует отдельных навыков разработки, не удовлетворяет требованиям полной
модульности) - не подходит для этой задачи
</p>

<p>
[COMMENT:ranma] Предлагаю использовать C++ + STL + boost.
</p>

<p>
[TODO] Доводы против писать здесь.
</p>

<p>
[COMMENT:rigidus] А зачем нам все это? Фреймворки? Какую работу они выполняют, за
что я должен их терпеть?!
</p>

<p>
<code>!!</code> [COMMENT:unrimah] Это не имеет отношения к <code>BusinessLogicLayer</code>, тебе не придется
их терпеть, так что забей. C++/STL/boost - хорошая связка.
[COMMENT:ranma] +1. rigidus забей вообще на все, что касается реализации нижнего уровня.
По твоим же требованиям это будет описано здесь, поэтому текст про это терпеть придется.
Но в разработке тебя это не коснется. Так же как и не нужно писать "нинужно" в той
реализации, которую не тебе делать.
</p>
</div>
</li></ol>
</li></ol>
</div>

<div id="outline-container-sec-8-7-2" class="outline-4">
<h4 id="sec-8-7-2"><span class="section-number-4">8.7.2</span> <span class="todo TODO">TODO</span> Работа с библиотеками</h4>
<div class="outline-text-4" id="text-8-7-2">
<p>
[todo:unrimah:ranma] Определится с какими либами мы работаем - статическими или
динамическими. Интерес постановщика задач в том, чтобы мы могли легко заменять
библиотеки, касающиеся того или иного конкретного оборудования.
</p>

<p>
[COMMENT:ranma]
На слое представления динамические библиотеки требуются для устройств и протоколов,
классы коммуникационных устройств будут использоваться всегда и к тому же настолько
малы, что не их не имеет смысла выносить в отдельные файловые сущности вообще.
Таким образом у нас будет 2 типа интерфейса к библиотекам: для устройства и для
кодека протокола. До первого релиза версии АПИ к либам будут меняться очень часто,
что при динамическом связывании потребует частой замены дополнительных файлов на
устройствах и отслеживания их совместимости по API. Кроме того для динамических либ
требуется загрузчик линковщик, который можно всегда дописать позже без проблем.
Таким образом в начале разработки предлагается использовать только статику.
К тому моменту, когда число устройств (то есть либ) станет значительным и, что важнее,
устоится API, то их все можно будет пересобрать в динамику и добавить 2 типа загрузчика
под 2 указанных API.
Кратко: до первого полного релиза и какое-то время после -  статика.
после того, как число устройств станет значительным - динамика.
</p>
</div>
</div>

<div id="outline-container-sec-8-7-3" class="outline-4">
<h4 id="sec-8-7-3"><span class="section-number-4">8.7.3</span> <span class="todo WAIT">WAIT</span> Драйвера периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></h4>
</div>
<div id="outline-container-sec-8-7-4" class="outline-4">
<h4 id="sec-8-7-4"><span class="section-number-4">8.7.4</span> <span class="todo TODO">TODO</span> Операционная система&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></h4>
<div class="outline-text-4" id="text-8-7-4">
<p>
[TODO:unrimah] - systemD supervisor etc
Почитать о вариантах можно здесь:
<a href="http://elinux.org/BeagleBone_Operating_Systems">http://elinux.org/BeagleBone_Operating_Systems</a>
</p>

<p>
На данный момент мы решили остаться на <code>BeagleBoardDebian</code>, который идёт в
станадртной поставке.
</p>
</div>
</div>

<div id="outline-container-sec-8-7-5" class="outline-4">
<h4 id="sec-8-7-5"><span class="section-number-4">8.7.5</span> <span class="todo TODO">TODO</span> Протоколы периферии</h4>
</div>
<div id="outline-container-sec-8-7-6" class="outline-4">
<h4 id="sec-8-7-6"><span class="section-number-4">8.7.6</span> <span class="todo TODO">TODO</span> Резервирование системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unrimah">unrimah</span></span></h4>
<div class="outline-text-4" id="text-8-7-6">
<p>
Унификация процесса <code>восстановления после грандфакапа</code> и <code>развертывания системы</code>
</p>
</div>
</div>

<div id="outline-container-sec-8-7-7" class="outline-4">
<h4 id="sec-8-7-7"><span class="section-number-4">8.7.7</span> <span class="todo TODO">TODO</span> Web-интерфейс для настройки контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h4>
<div class="outline-text-4" id="text-8-7-7">
<p>
Микроконтроллер должен иметь собственный Web-сервер для возможности доступа к его
настройкам через локальную сеть по IP адресу и наличия функции перепрошивки и
обновления программного обеспечения контроллера без физического доступа к нему.
</p>

<p>
Через UI контроллера должна быть реализована настройка доступа пользователей к интерфейсу.
См. распределение <i>роли пользователей системы</i> (<code>root</code> и <code>admin</code> применимо для контроллера).
</p>

<p>
Через UI контроллера должны быть реализованы настройки бизнес-логики контроллера:
</p>
<ul class="org-ul">
<li><i>Настройки администратора из web-интерфейса контроллера</i>
</li>
<li><i>Тестирование и диагностика из web-интерфейса контроллера</i>
</li>
<li><i>Настройки тарификации из web-интерфейса контроллера</i>
</li>
<li>Настройка функционирования торгового оборудовния из web-интерфейса контроллерачы
</li>
</ul>

<p>
Через UI контроллера должны быть реализованы настройки <code>идентификации стойки</code> (контроллера):
</p>
<ul class="org-ul">
<li>установка номера стойки в системе
</li>
<li>установка стевого имени, которым стойка представляется в LAN
</li>
<li>установка значений секторов для стойки - из какого в какой проезжает машина (0 - вне парковки)
</li>
</ul>

<p>
Через UI контроллера для пользователя <code>root</code> должно быть реализовано:
</p>
<ul class="org-ul">
<li>возможность установки, обновления, подключения и отключения библиотек для работы с переферийным оборудованием
</li>
<li>возможность установки, обновлеия, подключения и откючения бибилиотек для работы с дополнительными программными модулями
</li>
<li>настройка удалённого доступа по SSH и удалённого обновления из репозиториев (только для <code>root</code>)
</li>
<li>доступ к SSH через web-интерфейс при закрытом SSH порте
</li>
</ul>

<p>
Через UI контроллера администратор должен получать информацию о аппаратной и программной частях:
</p>
<ul class="org-ul">
<li>уникальный ID или s/n самой платы микрокомпьютера
</li>
<li>версию ядра системы (не ОС, а нашего программного продукта)
</li>
<li>список установленных библиотек, их версий и статуса
</li>
<li>доступ к истории событий контроллера
</li>
</ul>

<p>
Через UI контроллера должны быть реализованы сетевые настройки:
</p>
<ul class="org-ul">
<li>возможность настройки IP адреса, маски, шлюза для дсотупа в LAN
</li>
<li>настройка портов по которым контроллер общается с сервером
</li>
<li>настройка порта на котором находится web-интерфейс
</li>
<li>WAIT включение / отключение широковещательной рассылки (или другой системы,
направленной на автономную работу стоек без сервера)
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-8-8" class="outline-3">
<h3 id="sec-8-8"><span class="section-number-3">8.8</span> <span class="done DONE">DONE</span> Первичный запуск контроллера</h3>
<div class="outline-text-3" id="text-8-8">
</div><div id="outline-container-sec-8-8-1" class="outline-4">
<h4 id="sec-8-8-1"><span class="section-number-4">8.8.1</span> <span class="done DONE">DONE</span> Подключение к BBB по ssh</h4>
<div class="outline-text-4" id="text-8-8-1">
<p>
Для начала работы с ВВВ нужен только кабель miniUSB - по нему плата и питается, и
коммуницирует. Драйвера скачиваются с
<a href="http://beagleboard.org/static/Drivers/Windows/BONE_D64.exe">http://beagleboard.org/static/Drivers/Windows/BONE_D64.exe</a>, после установки -
подключаем плату к USB. В устройствах появляются Serial port (у меня СОМ3) и новое
сетевое подключение (Linux USB Ethernet/RNDIS Gadget). Для доступа потребуется
PuTTY, либо другая утилита консольного доступа.
</p>

<p>
Для доступа через СОМ-порт: устанавливаем соединение через PuTTY, выбрав нужный СОМ,
выставив скорость 115200, опционально - отключив flow control. Попадаем в консоль,
вводим в качестве логина "root" (без кавычек), пароля не требуется. Вуаля, мы в
консоли.
</p>

<p>
Для доступа по ssh: конфигурируем сетевое подключение, вводим статический адрес
192.168.7.1, маска 255.255.255.0. Теперь мы можем постучаться в ВВВ по ssh, по
адресу 192.168.7.2 (login=root), либо открыть в браузере страничку
<a href="http://192.168.7.2/">http://192.168.7.2/</a>, где крутится справочная страничка на apache2.
</p>

<p>
Для доступа через общий роутер: нужен патч-корд и роутер, умеющий раздавать адреса
по dhcp. Подключаем, перезагружаем ВВВ кнопкой "reset" или командой консоли reboot,
находим присвоенный ВВВ адрес - в логах роутера или в консоли по команде "ifconfig
eth0", далее - возможен доступ по ssh или через браузер. На настоящий момент адрес
10.0.10.114.
</p>

<p>
На порту 3000 (<a href="http://10.0.10.114:3000/">http://10.0.10.114:3000/</a>) развернута IDE Cloud9 с массой интересных
возможностей, есть с чем поиграться.
</p>
</div>
</div>

<div id="outline-container-sec-8-8-2" class="outline-4">
<h4 id="sec-8-8-2"><span class="section-number-4">8.8.2</span> <span class="done DONE">DONE</span> Компиляция и запуск HelloWorld на BBB</h4>
<div class="outline-text-4" id="text-8-8-2">
<p>
Простые сишные файлы компилируются по "gcc example.c -o example" и запускаются
"./example"
</p>
</div>
</div>

<div id="outline-container-sec-8-8-3" class="outline-4">
<h4 id="sec-8-8-3"><span class="section-number-4">8.8.3</span> <span class="done DONE">DONE</span> Установка и базовый запуск nginx</h4>
<div class="outline-text-4" id="text-8-8-3">
<p>
По умолчанию на ВВВ крутится apache2. Готовых .deb пакетов nginx для архитектуры
ARM нет, надо собирать из исходников. Исходники лежат здесь:
<a href="http://hg.nginx.org/nginx/shortlog/stable-1.8">http://hg.nginx.org/nginx/shortlog/stable-1.8</a> (последние на сегодня), потом можно
поискать следующую стабильную версию.
</p>

<p>
Скачиваем <a href="http://hg.nginx.org/nginx/archive/stable-1.8.tar.gz">http://hg.nginx.org/nginx/archive/stable-1.8.tar.gz</a>, загружаем на ВВВ
через scp scp stable-1.8.tar.gz root@10.0.10.114:/root/build ^^^!!! это запускается
на нашей машине в консоли, в папке где лежит архив!!!  (если папки /root/build нет,
её можно создать "mkdir /root/build" из консоли ВВВ)
</p>

<p>
Дальше распаковываем архив:
tar -xzf stable-1.8.tar.gz
</p>

<p>
Переходим в папку nginx:
cd nginx-stable-1.8
</p>

<p>
Файл конфигурации лежит не там, где нужно. Перетаскиваем, запускаем:
cp auto/configure .
./configure
</p>

<p>
Сконфигурировалось, собираем командой "make", устанавливаем "make install"
Nginx не прописывает себя в системные пути, вручную его можно запустить
/usr/local/nginx/sbin/nginx
</p>

<p>
&#x2026;но пока крутится apache2, мы с конфигурацией по умолчанию этого не сделаем.
vi /usr/local/nginx/conf/nginx.conf
в строке 37 выставляем "listen 8081"
</p>

<p>
Снова запускаем nginx, открываем приветствие nginx по адресу <a href="http://10.0.10.114:8081/">http://10.0.10.114:8081/</a>
Вуаля.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> <span class="todo TODO">TODO</span> Серверная часть&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rigidus">rigidus</span></span></h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> <span class="todo TODO">TODO</span> Общие положения</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Серверную часть необходимо полностью переписать в соответствии со
следующими критериями:
</p>

<ul class="org-ul">
<li>Необходимо отойти от связки php+apache, сервер должен иметь
автономное ядро (бэкэнд, сервер приложений) которое возможно будет
развернуть на платформах ОС семейств Windows или Linux. Выбор
оптимальных средств (языка программирования) с помощью которых
будет реализована данная задача на данный момент является
приоритетной задачей.
</li>

<li>В качестве сервера БД предлагается использовать бесплатные системы
MySQL с базами InnoDB или PostgreSQL (выбор необходимо
аргументировать). Пройдено и мускуль нахер послан.
</li>

<li>Все требуемые администратору системы и конечному пользователю
интерфейсы и средства должны быть реализованы в кроссплатформенном
браузерном варианте. Т.е. система должна быть реализована по
принципу "одного окна" (или точнее "всё на одной вкладке
браузера"). В дальнейшем возможно создание клиентских приложений на
замену браузерной реализации, но данная задача не является
приоритетной.
</li>

<li>Сервер должен иметь модульную структуру как по функционалу, так и
по доступным конечным пользователям интерфейсам управления и
администрирования (фронтэнду). Модули должны подключаться к серверу
в процессе изначальной установки, либо легко подключаться
после. Необходимо предусмотреть возможность инсталляции модулей как
с носителя, так и из сетевого репозитория.
</li>

<li>Ядро сервера и модули должны иметь встроенные средства
защиты. Предполагается использование аппаратного ключа HASP или
RuToken (возможно аналогов) для ядра и отдельных программных ключей
лицензирования для подключения отдельных модулей.
</li>

<li>При создании сервера необходимо разработать APIи техническую
документацию для возможности дальнейшей интеграции нашего ПО с
системами СКУД, 1С и т.д.
</li>

<li>Необходима возможность объединения серверов в кластеры,
т.е. несколько локальных серверов на отдельных парковках должны
иметь возможность обмениваться информацией с центральным сервером в
центре управления. Центральный сервер же должен иметь приоритет над
локальными, имея возможность управлять СКД во всём кластере,
тарифами и т.д.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> <span class="todo TODO">TODO</span> Основной функционал сервера:</h3>
<div class="outline-text-3" id="text-9-2">
<p>
В базовом варианте сервер должен иметь собственно ядро, БД и два
основных модуля (интерфейса) - администратора системы и парковщика.
</p>

<p>
Администратор системы должен иметь следующие возможности:
</p>

<ul class="org-ul">
<li>Получать информацию обо всех стойках и терминалах, находящихся в
локальной сети по факту настройки стоек на работу с данным сервером.
</li>

<li>Изменение IP-адресов, ключей шифрования, номеров стоек, управления
секторами, временем, информацией, выводимой на дисплей стоек и
печатаемой на чеках, подключения и удалённого программного
отключения периферийного оборудования на них (торговое
оборудование, светофоры, табло), гибкой настройки логики работы
сенсоров (фотоэлементов, магнитных петель).
</li>

<li>Получение информации агрегируемую сервером со стоек - события
въездов, выездов, оплаты, ошибки и т.п., которая должна писать в лог
и быть доступна для выгрузке по дате в отчёт в формате *.xls.
</li>

<li>Доступ к средствам тестирования работоспособности стоек (аналог
текущего ParkingTest).
</li>

<li>Управление пользователями системы, создание логинов и паролей,
распределение прав доступа к интерфейсам из-под учётных записей и
групп пользователей системы (в том числе и для самого себя).
</li>
</ul>

<p>
Оператор парковки должен иметь следующие возможности:
</p>

<ul class="org-ul">
<li>Открытие и закрытие шлагбаумов, подключённых к стойкам, находящимся
в локальной сети.
</li>

<li>Управление количеством свободных мест на парковке.
</li>

<li>Мониторинг информации, приходящей со стоек (лога) в режиме
реального времени.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> <span class="todo WAIT">WAIT</span> База данных</h3>
</div>
<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4"><span class="section-number-3">9.4</span> <span class="todo TODO">TODO</span> Web-интерфейс сервера</h3>
<div class="outline-text-3" id="text-9-4">
<p>
Сервер выступает в системе аггрегатором данных и хранилищем общих настроек для всех
стоек и терминалов оплаты систем.
</p>

<p>
Через него можно конфигурировать все стойки, уже подключённые к нему и видимые им:
вместо подключения к каждой стойке отдельно через UI или SSH можно выбрать
устройство в <code>списке стоек</code> на сервере и получить дсотуп к её настройкам из общего
интерфейса.
</p>

<p>
Также в разделе <code>список стоек</code> можно увидеть время последней связи со стойкам и
короткий отчёт об их статусах работы.
</p>

<p>
Роли и права доступа к UI сервера описаны в разделе <i>Роли пользователей системы</i>.
</p>

<p>
В UI сервера частично дублируются настройки бизнес-логики, которые можно сделать на самих стойках
(например, простые настройки тарифов), но при этом настройки выставленные на
сервере автоматически рассылаются на все подключённые к нему стойки (если на них
включено автообновление) в соответствии с установленными параметрами. Например, на
сервере возможно создание тарифной сетки по секторам и тарифы рассылаются стойкам в
зависимотсти от того, к каким секторам они относятся.
</p>

<p>
Кроме каскадирования настроек, через UI сервера должны быть реализованы настройки
дполнительных модулей, требующие наличие единого хранилища данных.
См. <i>Дополнительные аппаратно-програмные модули</i>
</p>
</div>
</div>

<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5"><span class="section-number-3">9.5</span> <span class="todo WAIT">WAIT</span> Агреггирующий сервер</h3>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> <span class="todo TODO">TODO</span> Дополнительные аппаратно-програмные модули</h2>
<div class="outline-text-2" id="text-10">
<p>
Мы хотим продавать решение разным людям за разные деньги. Обосновать это им можно
только предоставляя разные версии функционала.
</p>

<p>
Дополнительные модули должны подключаться к системе по запросу клиента в тех или
иных сочетаниях. При этом, каждый из этих установленных модулей подключается
администратором системы конкретному пользователю (группе пользователей). Это
позволяет сегментировать стоимость решения по цене.
</p>
</div>

<div id="outline-container-sec-10-0-1" class="outline-4">
<h4 id="sec-10-0-1"><span class="section-number-4">10.0.1</span> <span class="todo TODO">TODO</span> Модуль <code>платной парковки</code></h4>
<div class="outline-text-4" id="text-10-0-1">
<p>
Добавляет возможность работы с оплатой парковочного времени и управляет тарифами на
парковке.
</p>

<p>
В системы добавляется интерфейс администратор тарифов, с помощью которого можно
изменять почасовую стоимость пребывания на парковке, бесплатное время пребывания на
парковке, время бесплатного выезда с парковки после оплаты услуг и т.д.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-2" class="outline-4">
<h4 id="sec-10-0-2"><span class="section-number-4">10.0.2</span> <span class="todo TODO">TODO</span> Модуль <code>СКУД</code></h4>
<div class="outline-text-4" id="text-10-0-2">
<p>
Добавляет возможность работы с бесконтактными картами доступа в безусловном режиме
разрешения / запрета въезда.
</p>

<p>
В систему добавляется интерфейс администратора СКУД, который позволяет заводить в
систему карты доступа по их индивидуальному номеру, вводить информацию о владельцах
карт (ФИО, гос. номер транспортного средства и т.п.), распределять карты по
различным группам доступа.
</p>

<p>
Группы доступа могут иметь различные права по времени возможного въезда/выезда с
парковки, по посещению тех или иных секторов парковки, а также иметь численное
ограничение количества въездов (т.е. карт выдано в группе 10, но данной группе на
парковке принадлежит только 5 мест и одновременно на парковке / в секторе парковки
может находиться только 5 машин).
</p>

<p>
Карты доступа могут временно блокироваться, переноситься в архивные и окончательно
удаляться администратором. Если установлены другие модули, работающие с б/к
картами, администратор может изменять тип карт с одного на другой (абонемент,
дебетовая).
</p>

<p>
У оператора парковки при подключённом модуле СКУД в логе добавляются сообщения о
въездах и выездах по картам. Также добавляется интерфейс аудитора СКУД, который
позволяет пользователю с данными правами получить доступ к информации о картах
доступа, но не даёт возможности её изменять.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-3" class="outline-4">
<h4 id="sec-10-0-3"><span class="section-number-4">10.0.3</span> <span class="todo WAIT">WAIT</span> Модуль для <code>работы с абонементами</code></h4>
<div class="outline-text-4" id="text-10-0-3">
<p>
Добавляет возможность работы с бесконтактными картами в режиме оплаты услуг
парковки владельцем карты на заданный срок - т.е. оплата на фиксированную сумму
производится один раз в установленный срок.
</p>

<p>
В систему добавляется интерфейс администратора абонементных карт,позволяющий
заводить в систему абонементные карты по их индивидуальному номеру, вводить
информацию о владельцах карт (ФИО, гос. номер транспортного средства, номер
договора на предоставление услуг и т.п.), распределять карты по различным группам
доступа и тарифными группам.
</p>

<p>
Группы доступа используются те же, что и в модуле СКУД.
</p>

<p>
Абонементные карты могут временно блокироваться, переноситься в архивные и
окончательно удаляться администратором.
</p>

<p>
Если установлены другие модули, работающие с б/к картами, администратор может
изменять тип карт с одного на другой (СКУД, дебетовая).
</p>

<p>
В интерфейс администратора тарифов добавляется возможность работы с тарифными
группами, сроками и стоимостью оплаты для абонементов.
</p>

<p>
У оператора парковки, при подключённом модуле работы с абонементами, в логе
добавляются сообщения о въездах и выездах по картам и сроке действия карт.
</p>

<p>
Также добавляется интерфейс аудитора абонементных карт, который позволяет
пользователю с данными правами получить доступ к информации об абонементных картах
и сроках оплаты клиентом услуг, но не даёт возможности её изменять.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-4" class="outline-4">
<h4 id="sec-10-0-4"><span class="section-number-4">10.0.4</span> <span class="todo WAIT">WAIT</span> Модуль для <code>работы по дебетовым картам</code></h4>
<div class="outline-text-4" id="text-10-0-4">
<p>
Добавляет возможность работы с бесконтактными картами в режиме оплаты услуг
парковки владельцем карты по специальному тарифу - т.е. он кладёт деньги на карту
через кассу, сумма фиксируется в платёжной системе парковки и далее деньги
списываются с него исходя из времени пребывания на парковке при выездах, но по
особым тарифам.
</p>

<p>
В систему добавляется интерфейс администратора дебетовых карт,позволяющий заводить
в систему дебетовые карты по их индивидуальному номеру, вводить информацию о
владельцах карт (ФИО, гос. номер транспортного средства, номер договора на
предоставление услуг и т.п.), распределять карты по различным группам доступа и
тарифными группам.
</p>

<p>
Группы доступа используются те же, что и в модуле СКУД.
</p>

<p>
Дебетовые карты могут временно блокироваться, переноситься в архивные и
окончательно удаляться администратором.
</p>

<p>
Если установлены другие модули, работающие с б/к картами, администратор может
изменять тип карт с одного на другой (СКУД, абонементная).
</p>

<p>
В интерфейс администратора тарифов добавляется возможность работы с тарифными
группами и стоимостью времени пребывания на парковке для дебетовых карт.
</p>

<p>
У оператора парковки, при подключённом модуле работы с дебетовыми картами, в логе
добавляются сообщения о въездах и выездах по картам и списанных со счёта средствах.
</p>

<p>
Также добавляется интерфейс аудитора дебетовых карт, который позволяет пользователю
с данными правами получить доступ к информации о дебетовых картах, состоянии счёта
клиента и тарифном плане, но не даёт возможности ничего изменять.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-5" class="outline-4">
<h4 id="sec-10-0-5"><span class="section-number-4">10.0.5</span> <span class="todo WAIT">WAIT</span> Модуль <code>акцептирования</code></h4>
<div class="outline-text-4" id="text-10-0-5">
<p>
Добавляет в систему возможность обнуления требующего оплаты билета со штриховым
кодом через интерфейсную оболочку.
</p>

<p>
В систему добавляется интерфейс акцептирования билета в котором пользователь может
ввести в специальное поле номер билета (или считать номер сканером штрих-кода) и
произвести либо безусловное акцептирование - сделать билет бесплатным для выезда
навсегда изменив информацию о нём на сервере и выездных стойках, либо
акцептирование на выезде- у клиента будет возможность покинуть парковку в течении
бесплатного времени после акцептирования, либо акцептирование по тарифу - данному
билету присваивается специальный тариф (используется список тарифов дебетового
режима) и стоимость пребывания на парковке пересчитывается исходя из него.
</p>

<p>
При акцептировании пользователь вводит комментарий, в котором пишется причина
акцептирования.
</p>

<p>
Вся информация о проведённых акцептированиях билетов (пользователь, номер билета,
время акцептирования, сумма акцептирования) пишется в лог и доступна для
ознакомления в интерфейсе аудитора акцептирования.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-6" class="outline-4">
<h4 id="sec-10-0-6"><span class="section-number-4">10.0.6</span> <span class="todo WAIT">WAIT</span> Модуль <code>арендаторов</code></h4>
<div class="outline-text-4" id="text-10-0-6">
<p>
Добавляет в систему возможность обнуления требующего оплаты билета со штриховым
кодом на кассах, стойках информации или через интерфейсную оболочку с помощью карты
арендатора с последующим списанием обнулённой суммы на счёт владельца карты.
</p>

<p>
В систему добавляется интерфейс администрирования арендаторов, в котором можно
создавать пользователей - "арендаторов" и привязывать их бесконтактным картам и
основным пользователям системы.
</p>

<p>
Каждому арендатору выдаётся своя бесконтактная карта, для которой в системе
администратором установлен режим акцептирования (режимы перечислены в описании
модуля акцептирования, для дебетового режима устанавливается тариф).
</p>

<p>
С помощью этой карты арендатор может акцептировать билет клиента, приложив сначала
билет, а затем карту к стойке информации, кассе или введя номер билета на ПК, а
затем приложив карту к считывателю на ПК. После этого клиент покидает парковку в
соответствии с правилами акцептирования, а акцептированная сумма переводится на
"овердрафтовый счёт" данного арендатора в системе.
</p>

<p>
Все данные по этому счёту отображаются в интерфейсе счета арендаторов. Через этот
интерфейс можно либо списать сумму, которую должен арендатор, либо распечатать
фискальный чек через ККМ, подключённый к ПК, либо выгрузить форму счёта на оплату в
банке.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-7" class="outline-4">
<h4 id="sec-10-0-7"><span class="section-number-4">10.0.7</span> <span class="todo TODO">TODO</span> Модуль <code>кассира</code></h4>
<div class="outline-text-4" id="text-10-0-7">
<p>
Добавляет в систему возможность оплаты услуг парковки через ручную кассу на базе ПК
к которому подключён ККМ и, опционально, денежный ящик и сканер штриховых кодов.
</p>

<p>
В систему добавляются интерфейсы кассир и кассир - парковщик. В интерфейсе кассира
пользователь может провести процедуру оплаты билета - вбить его номер (или считать
номер сканером штрих-кода), выбрать тариф оплаты, принять сумму к оплает и
распечатать выездной фискальный чек с суммой, рассчитанной системой исходя из
времени и тарифа.
</p>

<p>
При этом приём денег и выдача сдачи осуществляется непосредственно человеком.
</p>

<p>
Кассир-парковщик имеет интерфейс оплаты совмещённый с интерфейсом обычного
оператора парковки в котором есть возможность открытия и закрытия шлагбаума, доступ
к логу и т.п.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-8" class="outline-4">
<h4 id="sec-10-0-8"><span class="section-number-4">10.0.8</span> <span class="todo WAIT">WAIT</span> Модуль <code>бухгалтера</code></h4>
<div class="outline-text-4" id="text-10-0-8">
<p>
Добавляет в систему возможность получения финансовых отчётов по парковке и кассовым
аппаратам (нарастающий итог, оборот по кассам и т.п.), а также делает возможным
автоматическое снятие Z-отчётов, печать копий Z-отчётов, изъятие установленной
суммы из автоматической кассы и т.д.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-9" class="outline-4">
<h4 id="sec-10-0-9"><span class="section-number-4">10.0.9</span> <span class="todo WAIT">WAIT</span> Модуль <code>фотофиксации</code></h4>
<div class="outline-text-4" id="text-10-0-9">
<p>
Добавляет в систему фотографирования камерами по событию.
</p>

<p>
В интерфейсе администратора системы добавляется функция привязки камеры к
конкретной стойке и список событий, производимых со стойкой, по которым камера
должна производить фотографирование.
</p>

<p>
Во все логи, в том числе и у оператора парковки, к сообщениям о данных событиях
прикрепляются фотографии.
</p>

<p>
Также добавляются интерфейсы машины на парковке и аудиторфотофиксации в которых
можно посмотреть фотографии всех машин, которые приехали на парковку и находятся на
ней и, соответственно, приехали и уехали с парковки в установленный промежуток
времени.
</p>
</div>
</div>

<div id="outline-container-sec-10-0-10" class="outline-4">
<h4 id="sec-10-0-10"><span class="section-number-4">10.0.10</span> <span class="todo WAIT">WAIT</span> Модуль <code>распознания номеров</code></h4>
</div>
<div id="outline-container-sec-10-0-11" class="outline-4">
<h4 id="sec-10-0-11"><span class="section-number-4">10.0.11</span> <span class="todo TODO">TODO</span> Модуль <code>дуплексной IP связи</code></h4>
<div class="outline-text-4" id="text-10-0-11">
<p>
Интеграция с SIP сервером VoIP связи Asterisk
</p>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> <span class="todo WAIT">WAIT</span> Интеграция со сторонними решениями</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> <span class="todo WAIT">WAIT</span> Выгрузка данных в 1С</h3>
</div>
<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> <span class="todo WAIT">WAIT</span> Интеграция с 1С</h3>
</div>
<div id="outline-container-sec-11-3" class="outline-3">
<h3 id="sec-11-3"><span class="section-number-3">11.3</span> <span class="todo WAIT">WAIT</span> Интеграция со сторонним биллингом</h3>
<div class="outline-text-3" id="text-11-3">
<p>
Интеграция с системами биллинга платёжных терминалов.
</p>
</div>
</div>

<div id="outline-container-sec-11-4" class="outline-3">
<h3 id="sec-11-4"><span class="section-number-3">11.4</span> <span class="todo WAIT">WAIT</span> Интеграция с NOW!</h3>
</div>
<div id="outline-container-sec-11-5" class="outline-3">
<h3 id="sec-11-5"><span class="section-number-3">11.5</span> <span class="todo WAIT">WAIT</span> Интеграция с SOLVO</h3>
</div>
<div id="outline-container-sec-11-6" class="outline-3">
<h3 id="sec-11-6"><span class="section-number-3">11.6</span> <span class="todo WAIT">WAIT</span> API для создания библиотек</h3>
<div class="outline-text-3" id="text-11-6">
<p>
Ориентирование системы на написание библиотек переферии сторонними разработчиками
</p>
</div>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> <span class="todo WAIT">WAIT</span> Тестирование</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1"><span class="section-number-3">12.1</span> <span class="todo TODO">TODO</span> Описать полный цикл работы системы с обработкой ошибок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-12-1">
</div><ol class="org-ol"><li><a id="sec-12-1-0-1"></a><span class="todo TODO">TODO</span> На алгоритмы проезда<br  /></li>
<li><a id="sec-12-1-0-2"></a><span class="todo TODO">TODO</span> На алгоритмы оплаты<br  /></li>
<li><a id="sec-12-1-0-3"></a><span class="todo TODO">TODO</span> Совмещенные алгоритмы<br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> <span class="todo TODO">TODO</span> Глоссарий</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1"><span class="section-number-3">13.1</span> Сигнал</h3>
<div class="outline-text-3" id="text-13-1">
<p>
<code>Сигнал</code> - это то, что поступает на контроллер с перифирийного датчика или что мы
шлем, чтобы включить лампочку, т.е. это замыкание реле и принимаемая на GPIO простая
логика (0 или 1) .
</p>
</div>
</div>

<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2"><span class="section-number-3">13.2</span> Сообщение</h3>
<div class="outline-text-3" id="text-13-2">
<p>
<code>Сообщение</code> - это то, что контроллеры и некоторые периферийные устройства шлют друг
другу, серверу и пользователю. Сообщения могут быть <code>синхронными</code> и <code>асинхронными</code>
</p>
</div>
</div>

<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3"><span class="section-number-3">13.3</span> Событие</h3>
<div class="outline-text-3" id="text-13-3">
<p>
<code>Событие</code> - это то, что внезапно произошло и на что надо отреагировать (обработать
событие). Сигнал или сообщение может спровоцировать возникновение события. События
обрабатываются синхронно.
</p>
</div>
</div>

<div id="outline-container-sec-13-4" class="outline-3">
<h3 id="sec-13-4"><span class="section-number-3">13.4</span> Состояние</h3>
<div class="outline-text-3" id="text-13-4">
<p>
<code>Состояние</code> определяет реакции на события - к примеру, когда пользователь нажимает
на кнопку стойки - реакция разная, в зависимости от того в каком состоянии находится
стойка. Переходы из одного состояния в другое производятся при обработке событий
</p>
</div>
</div>

<div id="outline-container-sec-13-5" class="outline-3">
<h3 id="sec-13-5"><span class="section-number-3">13.5</span> Процедура</h3>
<div class="outline-text-3" id="text-13-5">
<p>
<code>Процедура</code> - это последовательность взаимодействий элементов системы включая
пользователей и операторов для достижения результата.
</p>
</div>
</div>

<div id="outline-container-sec-13-6" class="outline-3">
<h3 id="sec-13-6"><span class="section-number-3">13.6</span> Датчик</h3>
<div class="outline-text-3" id="text-13-6">
<p>
<code>Датчик</code> это внешнее переферийное устройство или его часть, предназначенное для
сбора данных и выработки на их основе <code>сигналов</code>, реже - <code>сообщений</code>, передаваемых
на контроллер.
</p>
</div>

<div id="outline-container-sec-13-6-1" class="outline-4">
<h4 id="sec-13-6-1"><span class="section-number-4">13.6.1</span> Датчик присутствия автомобиля</h4>
<div class="outline-text-4" id="text-13-6-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Датчик присутствия автомобиля</caption>

<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">выход</td>
<td class="left">сухой контакт</td>
</tr>
</tbody>
</table>

<p>
Устройство, отслеживающее наличие объекта, соответствующего по установленным
характеристикам автомобиля (петля индуктивности, датчик магнитного поля,
фотоэлемент безопасности)
</p>
</div>
</div>

<div id="outline-container-sec-13-6-2" class="outline-4">
<h4 id="sec-13-6-2"><span class="section-number-4">13.6.2</span> Датчик (фотоэлемент) безопасности</h4>
<div class="outline-text-4" id="text-13-6-2">
<p>
Устройство, отслеивающее наличие любого объекта в зоне или на линии контроля
(фотоэлемент безопасности)
</p>
</div>
</div>

<div id="outline-container-sec-13-6-3" class="outline-4">
<h4 id="sec-13-6-3"><span class="section-number-4">13.6.3</span> Датчик контроля состояния стрелы шлакбаума</h4>
<div class="outline-text-4" id="text-13-6-3">
<p>
Часть конструкции автоматичекого шлагбаума, отслеживающая состояние
открытия/закрытия стрелы шлагбаума (концевики или релейная развязка)
</p>
</div>
</div>
</div>

<div id="outline-container-sec-13-7" class="outline-3">
<h3 id="sec-13-7"><span class="section-number-3">13.7</span> <span class="todo TODO">TODO</span> Стойка&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-7">
<p>
<code>Стойка</code> - это корпус устройства в который собирается вся периферия и контроллер.
</p>

<p>
Стойки бывают:
</p>
<ul class="org-ul">
<li><code>въезда</code> - стойки устанавлеваемые на въезде, характеризуются возможностью выдавать
билеты(или mifare карты), управлять шлагбаумом.
</li>
<li><code>выезда</code> - стойки устанавлеваемые на выезде, характеризуются возможностью
сканировать билеты(или принимать mifare карты), управлять шлагбаумом.
</li>
<li><code>проезда</code> - стойки устанавлеваемые на территори характеризуются возможностью сканировать
билеты (или mifare/em-marine карты), управлять шлагбаумом, регулировать работу зон
парковки.
</li>
<li><code>оплаты</code> - стойка с функционалом <code>кассы</code>, устанавливаемая на территори парковки, характеризуемая
возможностью сканировать билеты (или mifare/em-marine карты), принимать оплату и
печатать фискальный чек.
</li>
<li><code>оплаты совмещенная с въездом</code> - это стойка с функционалом <code>кассы</code>, устанавливаемая
на въезд на парковку, характеризуемая возможностью выдачи билетов (mifare карт),
приёма оплаты, печатати фискального чека и управления шлагбаумом.
</li>
<li><code>оплата совмещенная с выездом</code> - это стойка с функционалом <code>кассы</code>, устанавливаемая
на выезде с парковки, характеризуемая возможность сканирования билетов (приёма mifare карт),
приёма оплаты, печатати фискального чека и управления шлагбаумом.
</li>
<li><code>СКУД</code> - стойки устанавлеваемые на территори/въезде/выезде парковки,
характеризуются возможностью сканировать mifare/em-marine карты), управлять
шлагбаумом.
</li>
<li><code>информации</code> - стойки устанавливаемые на территори парковки, характеризуются
возможностью сканировать билеты (или mifare карты), выводить на дисплей данные по
ним и различные проводить операции со временем или внутренним счетом билета
(карты)
</li>
</ul>

<p>
У стойки есть:
</p>

<p>
[TODO:pyub] - Здесь надо перечислить все данные, которые мы храним по стойке.
</p>

<p>
[TODO:rigidus] - По стойке или всё-таки по <code>контроллеру</code>? Уверен, что этому место в
глоссарии?
</p>

<p>
[TODO:pyub] - Данные связанные с местом проезда. Может быть этому
не место в глоссарии, но эти данные мне нужны сейчас чтобы построить модель стойки,
если что - перенести не проблема. Добавь их плиз в таблицу ниже:
</p>

<table id="checkpoint_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Данные стойки</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">никнейм стойки (номер)</td>
</tr>
</tbody>
</table>

<p>
s/n контроллера который мы загружаем
номер сектора
</p>
</div>
</div>

<div id="outline-container-sec-13-8" class="outline-3">
<h3 id="sec-13-8"><span class="section-number-3">13.8</span> Периферийные устройства</h3>
<div class="outline-text-3" id="text-13-8">
<p>
<code>Периферийные устройства</code> - это устройства подключаемые к контроллеру парковки,
получающие от него и отсылающие ему <code>сигналы</code> или <code>сообщения</code>.
</p>

<p>
Периферийные устройства бывают:
</p>

<p>
<code>внутренние</code> - устройства подключаемые к контроллеру парковки, характеризуемые
расположением внутри стойки
</p>

<p>
<code>внешние</code> - устройства подключаемые к контроллеру парковки, характеризуемые
расположением вне стойки стойки
</p>

<p>
<code>торговые</code> - любое устройство, подключаемое к контроллеру парковки или ПК,
работающее с деньгами (монеты/купюры/банковские карты)
</p>

<p>
<code>опросные</code> - устройство, статус которого постоянно проверяется системой и при выходе
из строя которого так или иначе изменяется функционал и принцип работы системы
</p>

<p>
<code>критичное для работы</code> - частный случай опросного устройства, при выходе из строя
которого стойка автоматически уходит в состояние "Заблокирована"
</p>
</div>
</div>

<div id="outline-container-sec-13-9" class="outline-3">
<h3 id="sec-13-9"><span class="section-number-3">13.9</span> Касса</h3>
<div class="outline-text-3" id="text-13-9">
<p>
<code>Касса</code> (или <code>платежный терминал</code>) - это комплекс устройств (возможно - стойка)
обеспечивающих оплату пребывания посетителя на парковки и дополнительных услуг.
</p>

<ul class="org-ul">
<li><code>автоматическая касса</code> - это <code>стойка</code> устанавливаемая на территории парковки,
обепечиает полностью автоматизированный цикл оплаты пользователем услуг парковки.
</li>

<li><code>автоматическая каасса совмещенная с въездом</code> - это то же, что  <code>стойка оплаты совмещённая с въездом</code>.
</li>

<li><code>автоматическая касса совмещенная с выездом</code>  - это то же, что  <code>стойка оплаты совмещённая с выездом</code>.
</li>

<li><code>ручная касса</code> - это имеющее собственный корпус устроство под управлением
<code>контроллера</code> с встроенным в него сканером штрих-кодов (считыватель карт
em-marine/mifare), денежным ящиком и фискальным регистратором. Все операции
получения денег и выдачи сдачи производит оператор (кассир) без автоматизирующего
процесс торгового оборудования.
</li>

<li><code>касса на базе ПК</code> - это настольный персональный компьютер с подключенными к нему
настольными сканером штрих-кодов (считыватель карт em-marine/mifare), денежный
ящик и фискальный регистратор. Все операции получения денег и выдачи сдачи
производит оператор (кассир) без автоматизирующего процесс торгового оборудования.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-10" class="outline-3">
<h3 id="sec-13-10"><span class="section-number-3">13.10</span> Проездной документ</h3>
<div class="outline-text-3" id="text-13-10">
<p>
Это носитель информации, выдаваемый посетителю парковки, на котором находится (в
т.ч. шифруется) информация о времени и терминале въезда на парковку, а также данные,
необходимые для автономного функционированния парковки и реализации различных
механизмов монетизации.
</p>

<p>
Проездные билеты можно разделить разовости прмменения, по материалам из которых они
сделаны, по
</p>

<p>
Типы:
</p>
<ul class="org-ul">
<li><code>одноразовый</code> - единоразово создаваемый и выдаваемый клиенту носитель информации,
который несёт на себе информацию о времени въезда и терминале въезда
</li>
<li><code>многоразовый</code> - многоразово используемый проездной документ, с помощью которого
посетитель паркови может посещать её не пользуясь одноразовыми въездными билетами=
</li>
</ul>

<p>
Материалы:
</p>
<ul class="org-ul">
<li><code>бумажный</code> - напечатанный на термобумаге или картоне, информация зашифрована в
штриховом коде
</li>
<li><code>пластиковый</code> - карта стандарта EM-Marine или Mifare, информация зашифрована на
чипе карты
</li>
</ul>
</div>

<div id="outline-container-sec-13-10-1" class="outline-4">
<h4 id="sec-13-10-1"><span class="section-number-4">13.10.1</span> Категории:</h4>
<div class="outline-text-4" id="text-13-10-1">
<p>
<code>въездной</code> - разновидность билета получаемого при въезде на парковку
</p>

<p>
<code>выездной</code> - разновидность билета получаемого (или перведенимого в данный статус из
въездного) при оплате парковки, как правило совмещён с фискальным чеком
</p>
</div>
</div>

<div id="outline-container-sec-13-10-2" class="outline-4">
<h4 id="sec-13-10-2"><span class="section-number-4">13.10.2</span> Статусы:</h4>
<div class="outline-text-4" id="text-13-10-2">
<p>
<code>с бесплатным временем</code> - билет на котором еще не закончеллось бесплатное время
стоянки
</p>

<p>
<code>неоплаченный</code> - билет на котором закончелось бесплатное время и началось платное
время стоянки
</p>

<p>
<code>оплаченный</code> - билет по которому была произведена оплата
</p>

<p>
<code>использованный</code> - билет который уже использовали для выезда с парковки
</p>

<p>
<code>фискальный чек</code> - документ выдаваеммый кассой при проведении операции оплаты, может
быть сомещен с оплаченным билетом при использовании бумажных носителей
</p>
</div>
</div>
</div>

<div id="outline-container-sec-13-11" class="outline-3">
<h3 id="sec-13-11"><span class="section-number-3">13.11</span> Контроллер</h3>
<div class="outline-text-3" id="text-13-11">
<p>
Это устройство, контролирующее работу ряда переферийных элементов автоматизированной
парковки, регламентирующее работу стоек системы парковки и всех подключенных
переферийных устройств. Контроллер устанавливется в стойках.
</p>
</div>
</div>

<div id="outline-container-sec-13-12" class="outline-3">
<h3 id="sec-13-12"><span class="section-number-3">13.12</span> Системы навигациии</h3>
<div class="outline-text-3" id="text-13-12">
<p>
Контроллер, регламентирующий работу устройств, входящих в систему навигации и учёта
сводных мест с помощью УДПА
</p>

<p>
[TODO:pyub] - WTF УДПА?
</p>
</div>
</div>

<div id="outline-container-sec-13-13" class="outline-3">
<h3 id="sec-13-13"><span class="section-number-3">13.13</span> <span class="todo TODO">TODO</span> Сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-13">
<p>
Сервера бывают:
</p>
<ul class="org-ul">
<li><code>парковочной системы</code>
</li>
<li><code>агрегирующий</code>
</li>
<li><code>сторонний</code>
</li>
<li><code>навигационной системы</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-14" class="outline-3">
<h3 id="sec-13-14"><span class="section-number-3">13.14</span> Время</h3>
<div class="outline-text-3" id="text-13-14">
<p>
Время - это промежуток времени установленный в ситеме (следовательно и внесенный на
носитель информации - билет)
</p>

<p>
Время бывает:
</p>
<ul class="org-ul">
<li><code>бесплатное</code> - промежуток в течении которого посетитель парковки может
беспрепятственно выехать по текущему носителю информации
</li>
<li><code>платное</code> - промежуток в течении которого начисляется оплата согласно тарифам
парковки
</li>
<li><code>оплаченное</code> - промежуток платного времени который оплатил посетитель
</li>
<li><code>на выезд</code> - промежуток бесплатного времени начисленный на носитель информации
после оплаты платного времени, начинаестся сразу после превода платного в
оплаченное время.
</li>
<li><code>акцептированное</code> - промежуток дополнительного бесплатного времени начисленный на
носитель информации, учитывается при расчете платного времени.
</li>
<li><code>сверх оплаченного</code> - промежуток платного времени начинающийся после окончания
времни на выезд.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-15" class="outline-3">
<h3 id="sec-13-15"><span class="section-number-3">13.15</span> Группы</h3>
<div class="outline-text-3" id="text-13-15">
<p>
Группы - это группа стоек и перефериного оборудования устанавлваемого в точке
проезда автомобиля или прохода посетителя.
</p>

<p>
Группы бывают:
</p>
<ul class="org-ul">
<li><code>въездная</code> - характеризуется установкой на въездах на территорию парковки
</li>
<li><code>выездная</code> - характеризуется установкой на выездах с территории парковки
</li>
<li><code>проездная</code> - характеризуется установкой на переездах  на территорию парковки
</li>
<li><code>реверсивная</code> - характеризуется установкой на реверсивных проездах (въезд и выезд по
одной полосе) может быть одновременно и проездной
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-16" class="outline-3">
<h3 id="sec-13-16"><span class="section-number-3">13.16</span> Парковка</h3>
<div class="outline-text-3" id="text-13-16">
<p>
<code>Территория парковки (парковка)</code> - комплекс инфраструктурных и дорожных объектов
являющаяся отдельной территорией и оснащаемым АСПП.
</p>

<p>
Территория парковки делится на сегменты согласно ряду признаков:
</p>
<ul class="org-ul">
<li><code>сектор</code> - физический сегмент парковки, применим в системе подсчета свободных мест
и/или ограничении типа проезжаемых автомабилий в данный сегмент.
</li>
<li><code>тарифные зоны</code> - логический сегмент парковки, применим при описании различных
тарифов в зависимости от фактического места и времени стоянки и/или проезда автомобиля.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-17" class="outline-3">
<h3 id="sec-13-17"><span class="section-number-3">13.17</span> <span class="todo TODO">TODO</span> Посетитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-17">
<p>
Посетитель - это водитель автомобиля посетившего парковку.
</p>

<ul class="org-ul">
<li><code>разовый</code> - водитель, однократно вопользовавшийся услугой парковки и использующий
одноразовые идентификатор. [TODO:pyub] - Ссылка на определение одноразового
идентификатора
</li>
<li><code>постоянный</code> - водитель многократно и неограниченно пользующийся услугой парковки
и использущий многоразовый идентификатор запрограммированный на определённый
тип предотсвляемых услуг
</li>
<li><code>с картой доступа</code>
</li>
<li><code>с абонементом</code> -водитель многократно и неогранниченно пользующийся услугой парковк
и использущий многоразовый носитель информации, и ежемесячно оплачивающий эти услуги
через АСПП внося на внутренний счет носителя.
</li>
<li><code>с картой предоплаты</code> -водитель многократно пользующийся услугой парковк и
использущий многоразовый носитель информации, оплачивающий фактической время
пребывания со внутреннего счета носителя информации, и пополняющий его через АСПП
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-18" class="outline-3">
<h3 id="sec-13-18"><span class="section-number-3">13.18</span> <span class="todo TODO">TODO</span> Деление парковкочных мест&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-18">
<ul class="org-ul">
<li><code>линия</code>
</li>
<li><code>объём</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-19" class="outline-3">
<h3 id="sec-13-19"><span class="section-number-3">13.19</span> <span class="todo TODO">TODO</span> Тариф&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-19">
<ul class="org-ul">
<li><code>типы проездов через шл</code>
</li>
<li><code>переферия стоек внешняя</code>
</li>
<li><code>внутренний счет</code>
</li>
<li><code>мифаре</code>
</li>
<li><code>емарине</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13-20" class="outline-3">
<h3 id="sec-13-20"><span class="section-number-3">13.20</span> <span class="todo TODO">TODO</span> Роли&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-13-21" class="outline-3">
<h3 id="sec-13-21"><span class="section-number-3">13.21</span> <span class="todo TODO">TODO</span> Внешний носитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-13-22" class="outline-3">
<h3 id="sec-13-22"><span class="section-number-3">13.22</span> <span class="todo TODO">TODO</span> УДПА&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-13-23" class="outline-3">
<h3 id="sec-13-23"><span class="section-number-3">13.23</span> <span class="todo TODO">TODO</span> Процесс&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-13-24" class="outline-3">
<h3 id="sec-13-24"><span class="section-number-3">13.24</span> <span class="todo TODO">TODO</span> Рампа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-24">
<p>
Когда шлагбаум располагается после стойки и после-после стойки
</p>
</div>
</div>
<div id="outline-container-sec-13-25" class="outline-3">
<h3 id="sec-13-25"><span class="section-number-3">13.25</span> <span class="todo TODO">TODO</span> Шлюз&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-13-25">
<p>
Когда шлагбаум располагается до стойки и после стойки
</p>
</div>
</div>
<div id="outline-container-sec-13-26" class="outline-3">
<h3 id="sec-13-26"><span class="section-number-3">13.26</span> <span class="todo TODO">TODO</span> Реверсивный проезд&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> Данные по первому поколению системы</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1"><span class="section-number-3">14.1</span> <span class="done DONE">DONE</span> Старая версия сервера</h3>
<div class="outline-text-3" id="text-14-1">
<p>
Доступ к текущей реализации сервера и БД для ознакомления:
<a href="http://31.28.10.26:8889/">http://31.28.10.26:8889/</a>
admin | 8812
<a href="http://31.28.10.26:8889/phpmyadmin/">http://31.28.10.26:8889/phpmyadmin/</a>
root | gThy77gG
</p>

<p>
[TODO:pyub] Изъять из общего доступа github?
</p>
</div>
</div>
</div>

<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> Сущности</h2>
<div class="outline-text-2" id="text-15">
<p>
Соберем все сущности и автоматы в один файл <code>src/entityes.lisp</code>
</p>
</div>

<div id="outline-container-sec-15-1" class="outline-3">
<h3 id="sec-15-1"><span class="section-number-3">15.1</span> Функции для кодогенерации сущностей</h3>
<div class="outline-text-3" id="text-15-1">
<p>
Эти функции будут кодогенерировать сущности и автоматы из таблиц с наименованием и
типами полей внутри этого файла.
</p>

<p>
Чтобы емакс не запрашивал подтверждение на каждое исполнение кода, установим эту
настройку:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_org_confirm">(setq org-confirm-babel-evaluate nil)
</pre>
</div>

<p>
Начнем с генерации кода из таблицы полей:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_fields">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">gen-fields</span> (rows)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result))
    (push <span style="color: #cdcd00;">"\n"</span> result)
    (push (format <span style="color: #cdcd00;">"  (%s\n"</span> (butlast (car rows))) result)
    (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                (push (format <span style="color: #cdcd00;">"   %s\n"</span> (butlast x)) result))
            (butlast (cdr rows)))
    (push (format <span style="color: #cdcd00;">"   %s)"</span> (butlast (car (last rows)))) result)
    (mapconcat 'identity (reverse result) <span style="color: #cdcd00;">""</span>)))
</pre>
</div>

<p>
Теперь напишем код, который генерирует код для состояний конечного автомата:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_states">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">gen-states</span> (rows)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result)
        (hash (make-hash-table <span style="color: #00cdcd; font-weight: bold;">:test</span> #'equal))
        (states))
    (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (elt rows nil)
      (puthash (cadr elt) nil hash)
      (puthash (cadr (cdr elt))  nil hash))
    (maphash (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (k v)
               (push k states))
             hash)
    (push <span style="color: #cdcd00;">"\n"</span> result)
    (push <span style="color: #cdcd00;">"  ("</span> result)
    (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (elt (butlast states))
      (push (format <span style="color: #cdcd00;">":%s "</span> elt) result))
    (push (format <span style="color: #cdcd00;">":%s)"</span> (car (last states))) result)
    (mapconcat 'identity (reverse result) <span style="color: #cdcd00;">""</span>)))
</pre>
</div>

<p>
И добавим к этом генератор действий - т.е. переходов между состояниями:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_actions">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">gen-actions</span> (rows)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result))
    (push <span style="color: #cdcd00;">"\n"</span> result)
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((x (car rows)))
      (push (format <span style="color: #cdcd00;">"  ((:%s :%s :%s)"</span> (cadr x) (cadr (cdr x)) (car x)) result))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 1 (length rows))
        (push <span style="color: #cdcd00;">")"</span> result)
      (<span style="color: #00cdcd; font-weight: bold;">progn</span>
        (push <span style="color: #cdcd00;">"\n"</span> result)
        (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                    (push (format <span style="color: #cdcd00;">"   (:%s :%s :%s)\n"</span> (cadr x) (cadr (cdr x)) (car x)) result))
                (cdr (butlast rows)))
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((x (car (last rows))))
          (push (format <span style="color: #cdcd00;">"   (:%s :%s :%s))"</span> (cadr x) (cadr (cdr x)) (car x)) result))))
    (mapconcat 'identity (reverse result) <span style="color: #cdcd00;">""</span>)))
</pre>
</div>

<p>
Соберем все это в один файл, чтобы загружать перед кодогенерацией проекта:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators"><span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&lt;&lt;copyright&gt;&gt;</span>

&lt;&lt;gen_org_confirm&gt;&gt;

&lt;&lt;gen_fields&gt;&gt;

&lt;&lt;gen_states&gt;&gt;

&lt;&lt;gen_actions&gt;&gt;
</pre>
</div>

<p>
И загрузим его:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators">(load-file <span style="color: #cdcd00;">"generators.el"</span>)
</pre>
</div>

<p>
Теперь у нас есть все необходимое, чтобы написать вызываемые при
tangle генераторы сущностей и автоматов:
</p>
</div>
</div>
</div>

<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> Тесты</h2>
<div class="outline-text-2" id="text-16">
<div class="org-src-container">

<pre class="src src-lisp" id="asp_test"><span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; asp</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">asp-test</span> ()
  &lt;&lt;asp_test_contents&gt;&gt;
  (dbg <span style="color: #cdcd00;">"passed: asp-test~%"</span>))
(asp-test)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="asp_test_contents">&lt;&lt;test_make_checkpoint&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> Сборка</h2>
<div class="outline-text-2" id="text-17">
</div><div id="outline-container-sec-17-1" class="outline-3">
<h3 id="sec-17-1"><span class="section-number-3">17.1</span> Каркас проекта</h3>
<div class="outline-text-3" id="text-17-1">
<p>
Для генерации "с чистого листа" необходимы функции генерации сущностей, они лежат в
файле <code>generators.el</code>
</p>

<p>
Чтобы их подключить - можно сделать M-x load-file generators.el в emacs-е.
</p>

<p>
Эти функции помещаются в <code>generators.el</code> при <code>tangle</code> и редактировать их можно в
соответствующем разделе этого файла. Для успешной генерации сущностей, они должны быть
загружены в emacs.
</p>

<p>
Файл <code>prepare</code> должен идти до файла <code>util</code> и остальных, так как в нем компилируются
шаблоны, от которых зависит <code>util</code>
</p>

<p>
Файл <code>globals</code> должен идти до файла <code>entity</code> так как в нем происходит подключение к базе
данных, которое используют тесты сущностей и автоматов.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defsystem">     <span style="color: #cdcd00; font-style: italic;">;;;; </span><span style="color: #cdcd00; font-style: italic;">&lt;&lt;copyright&gt;&gt;</span>
     <span style="color: #cdcd00; font-style: italic;">;;;; </span><span style="color: #cdcd00; font-style: italic;">asp.asd</span>

(asdf:defsystem #<span style="color: #00cdcd; font-weight: bold;">:asp</span>
  <span style="color: #00cdcd; font-weight: bold;">:serial</span> t
  <span style="color: #00cdcd; font-weight: bold;">:pathname</span> <span style="color: #cdcd00;">"src"</span>
  <span style="color: #00cdcd; font-weight: bold;">:depends-on</span> (#<span style="color: #00cdcd; font-weight: bold;">:closer-mop</span>
               #<span style="color: #00cdcd; font-weight: bold;">:postmodern</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-mysql</span>
               #<span style="color: #00cdcd; font-weight: bold;">:anaphora</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-ppcre</span>
               #<span style="color: #00cdcd; font-weight: bold;">:restas</span>
               #<span style="color: #00cdcd; font-weight: bold;">:restas-directory-publisher</span>
               #<span style="color: #00cdcd; font-weight: bold;">:closure-template</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-json</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-base64</span>
               #<span style="color: #00cdcd; font-weight: bold;">:drakma</span>
               #<span style="color: #00cdcd; font-weight: bold;">:split-sequence</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-html5-parser</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-who</span>
               #<span style="color: #00cdcd; font-weight: bold;">:parenscript</span>
               #<span style="color: #00cdcd; font-weight: bold;">:cl-fad</span>
               #<span style="color: #00cdcd; font-weight: bold;">:optima</span>
               #<span style="color: #00cdcd; font-weight: bold;">:fare-quasiquote-extras</span>
               #<span style="color: #00cdcd; font-weight: bold;">:fare-quasiquote-optima</span>
               )
  <span style="color: #00cdcd; font-weight: bold;">:description</span> <span style="color: #cdcd00;">"asp"</span>
  <span style="color: #00cdcd; font-weight: bold;">:author</span> <span style="color: #cdcd00;">"rigidus"</span>
  <span style="color: #00cdcd; font-weight: bold;">:version</span> <span style="color: #cdcd00;">"0.0.3"</span>
  <span style="color: #00cdcd; font-weight: bold;">:license</span> <span style="color: #cdcd00;">"GNU AGPLv3"</span>
  <span style="color: #00cdcd; font-weight: bold;">:components</span> ((<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"package"</span>)    <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1092;&#1072;&#1081;&#1083; &#1087;&#1072;&#1082;&#1077;&#1090;&#1086;&#1074;</span>
               (<span style="color: #00cdcd; font-weight: bold;">:static-file</span> <span style="color: #cdcd00;">"templates.htm"</span>)
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"prepare"</span>)    <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1087;&#1086;&#1076;&#1075;&#1086;&#1090;&#1086;&#1074;&#1082;&#1072; &#1082; &#1089;&#1090;&#1072;&#1088;&#1090;&#1091;</span>
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"util"</span>)       <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1092;&#1072;&#1081;&#1083; &#1089; &#1091;&#1090;&#1080;&#1083;&#1080;&#1090;&#1072;&#1084;&#1080;</span>
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"globals"</span>)    <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1092;&#1072;&#1081;&#1083; &#1089; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1099;&#1084;&#1080; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1103;&#1084;&#1080;</span>
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"bricks"</span>)     <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1082;&#1086;&#1084;&#1087;&#1086;&#1085;&#1077;&#1085;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1103; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1086;&#1074;</span>
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081;, &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1086;&#1074; &#1080; &#1080;&#1093; &#1090;&#1077;&#1089;&#1090;&#1086;&#1074;</span>
               &lt;&lt;mod_entity&gt;&gt;
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"entityes"</span>)   <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1057;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1080; &#1080; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1099;</span>
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"start"</span>)      <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1089;&#1090;&#1072;&#1088;&#1090;&#1086;&#1074;&#1099;&#1081; &#1092;&#1072;&#1081;&#1083;</span>
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1072;&#1074;&#1090;&#1086;&#1088;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080; (&#1079;&#1072;&#1074;&#1080;&#1089;&#1080;&#1090; &#1086;&#1090; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081; &#1074; &#1089;&#1090;&#1072;&#1088;&#1090;&#1086;&#1074;&#1086;&#1084; &#1092;&#1072;&#1081;&#1083;&#1077;)</span>
               &lt;&lt;mod_auth&gt;&gt;
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1086;&#1095;&#1077;&#1088;&#1077;&#1076;&#1077;&#1081;</span>
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&lt;&lt;mod_que&gt;&gt;</span>
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1081;</span>
               &lt;&lt;mod_msg&gt;&gt;
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; trend</span>
               &lt;&lt;mod_trend&gt;&gt;
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1084;&#1086;&#1090;&#1086;&#1073;&#1088;&#1072;&#1090;&#1072;&#1085;</span>
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&lt;&lt;mod_bratan&gt;&gt;</span>
               <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; HeadHunter</span>
               &lt;&lt;mod_hh&gt;&gt;
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"events"</span>)     <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1089;&#1086;&#1073;&#1099;&#1090;&#1080;&#1103; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;</span>
               (<span style="color: #00cdcd; font-weight: bold;">:file</span> <span style="color: #cdcd00;">"iface"</span>)      <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1092;&#1072;&#1081;&#1083; &#1074;&#1077;&#1073;-&#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1072;</span>
               ))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-17-2" class="outline-3">
<h3 id="sec-17-2"><span class="section-number-3">17.2</span> Пакеты</h3>
<div class="outline-text-3" id="text-17-2">
<p>
Соберем весь код в пакет:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="package"><span style="color: #cdcd00; font-style: italic;">;;;; </span><span style="color: #cdcd00; font-style: italic;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #cdcd00; font-style: italic;">;;;; </span><span style="color: #cdcd00; font-style: italic;">package.lisp</span>

(<span style="color: #00cdcd; font-weight: bold;">restas:define-module</span> #<span style="color: #00cdcd; font-weight: bold;">:asp</span>
  (<span style="color: #00cdcd; font-weight: bold;">:use</span>  #<span style="color: #00cdcd; font-weight: bold;">:cl</span> #<span style="color: #00cdcd; font-weight: bold;">:closer-mop</span> #<span style="color: #00cdcd; font-weight: bold;">:postmodern</span> #<span style="color: #00cdcd; font-weight: bold;">:anaphora</span> #<span style="color: #00cdcd; font-weight: bold;">:hunchentoot</span> #<span style="color: #00cdcd; font-weight: bold;">:cl-who</span> #<span style="color: #00cdcd; font-weight: bold;">:parenscript</span> #<span style="color: #00cdcd; font-weight: bold;">:cl-fad</span> #<span style="color: #00cdcd; font-weight: bold;">:optima</span>)
  (<span style="color: #00cdcd; font-weight: bold;">:shadowing-import-from</span> #<span style="color: #00cdcd; font-weight: bold;">:closer-mop</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:defclass</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:defmethod</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:standard-class</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:ensure-generic-function</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:defgeneric</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:standard-generic-function</span>
                          #<span style="color: #00cdcd; font-weight: bold;">:class-name</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-17-3" class="outline-3">
<h3 id="sec-17-3"><span class="section-number-3">17.3</span> Подготовка к старту</h3>
<div class="outline-text-3" id="text-17-3">
<p>
Подготовка включает в себя загрузку всех необходимых библиотек, компиляцию шаблонов, и,
возможно, инициализацию окружения.
</p>
</div>
</div>

<div id="outline-container-sec-17-4" class="outline-3">
<h3 id="sec-17-4"><span class="section-number-3">17.4</span> Точка входа</h3>
<div class="outline-text-3" id="text-17-4">
<p>
Отсюда все начинается
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="enter_point"><span style="color: #cdcd00; font-style: italic;">;;;; </span><span style="color: #cdcd00; font-style: italic;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #cdcd00; font-style: italic;">;;;; </span><span style="color: #cdcd00; font-style: italic;">start.lisp</span>

(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #00cdcd; font-weight: bold;">:asp</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #00cdcd; font-size: 110%; font-weight: bold;">main</span> ()
  <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">start</span>
  (restas:start '#<span style="color: #00cdcd; font-weight: bold;">:asp</span> <span style="color: #00cdcd; font-weight: bold;">:port</span> 3999)
  (restas:debug-mode-on)
  <span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">(restas:debugg-mode-off)</span>
  (setf hunchentoot:*catch-errors-p* t)
  (make-event <span style="color: #00cdcd; font-weight: bold;">:name</span> <span style="color: #cdcd00;">"restart"</span>
              <span style="color: #00cdcd; font-weight: bold;">:tag</span> <span style="color: #cdcd00;">"restart"</span>
              <span style="color: #00cdcd; font-weight: bold;">:msg</span> (format nil <span style="color: #cdcd00;">"&#1057;&#1077;&#1088;&#1074;&#1077;&#1088; &#1087;&#1077;&#1088;&#1077;&#1079;&#1072;&#1087;&#1091;&#1097;&#1077;&#1085;"</span>)
              <span style="color: #00cdcd; font-weight: bold;">:author-id</span> 0
              <span style="color: #00cdcd; font-weight: bold;">:ts-create</span> (get-universal-time)))

(main)

<span style="color: #cdcd00; font-style: italic;">;; </span><span style="color: #cdcd00; font-style: italic;">&#1058;&#1077;&#1089;&#1090;&#1099;</span>
&lt;&lt;asp_test&gt;&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-17-5" class="outline-3">
<h3 id="sec-17-5"><span class="section-number-3">17.5</span> Copyright</h3>
<div class="outline-text-3" id="text-17-5">
<div class="org-src-container">

<pre class="src src-lisp" id="copyright">Copyright &#169; 2014-2015 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: pyub</p>
<p class="date">Created: 2016-01-30 Сб. 18:22</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
