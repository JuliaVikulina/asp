Прошивка выезда унифицированная.

Добавлена настройка использования считывателя штрихкодов:
 Настройки -> Общие 1 -> Использовать считыватель штрихкодов
Релиз с секторами свободных мест.
 Настройки -> Общие 1 -> Система подсчета свободных мест
  задается свой и соседний сектора (по умолчанию свой сектор 1, соседний сектор 0)
 Если номер сектора 0, то соответствующее сообщение не отправляется.
 Если стойка въездная, она отправляет сообщения о въезде со своим номером сектора и о выезде с соседним номером сектора.
 Если стойка выездная, она отправляет сообщения о выезде со своим номером сектора и о въезде с соседним номером сектора.
Стойки внутри себя автономно ведут подсчет мест, принимая сообщения о въезде / выезде только со своим номером сектора.
При каждом запуске стойка сообщает серверу номера своего и соседнего секторов.

Данные передаются UDP пакетами.
EBSM_PING заменен на EBSM_REQ_PING и EBSM_REPLY_PING.
Исправлена широковещательная рассылка данных.

Доработан алгоритм счетчика:
 при въезде на вторую петлю обязательно дожидаемся завершения проезда, не сбрасывая алгоритм.
Введено сообщение "Авто перед стойкой" при занятии петли перед стойкой.

Доработаны алгоритмы управления шлагбаумом.
Длительность импульса настраивается в программе установок.
Импульс выдается на шлагбаум до 3-х раз с паузой в 300ms до срабатывания соответствующего концевика.
После отработки цикла шлагбаума, реле "стоп" срабатывает в соответствии с настройками:
 рабочее состояние (нормально замкнутое / разомкнутое) и срабатывание только на фотоэлемент безопасности.
Работа концевиков отслеживается.
 В случае не подключения или не корректной работы выдаются соответствующие сообщения.
 Сообщения выдаются только 1 раз. Далее если активности от концевиков нет, выдача сообщений прекращается.
 Если концевики начнут работать и потом опять появятся ошибки - сообщения будут выданы снова.
Функция дожима шлагбаума (включается после срабатывания концевика) по умолчанию 0сек.
 Задерживает на заданное время сигнал открытия / закрытия шлагбаума, после срабатывания соответствующего концевика.
 Контроль фотоэлемента ведется до завершения функции дожима.
Если используется шлагбаум без концевиков, открываемый и закрываемый импульсом, то
 нужно замкнуть входы концевиков и выставить дожим шлагбаума на соответсвтующее нужному импульсу время.

Добавлено проигрывание по событиям аудио-файлов с SD-карты.
Список файлов и событий.
Формат: название файла - пауза перед проигрышем, пауза перед повтором - момент проигрывания.
not_wrk.wav - 1,5 - "Извините, парковка не работает..."
drv_busy.wav - 2,3 - "Проезд занят, нужно отъехать..."
go_drive.wav - 4,3 - После открытия шлагбаума. "Проезжайте..."
ex_auto.wav - 2,3 - "Поднесите штрих-код или карту"
ex_hello.wav - 2,0 - "Выездная стойка"
Если соответствующего файла нет на SD-карте, ничего не проигрывается.
Паузы перед проигрыванием файла и между повторами файлов можно поменять в прошивке.
Если пауза повтора = 0 - файл проигрывается по событию 1 раз, без повторов.
Формат файла звукового сэмпла должен быть PCM/8кГц/8бит/Моно.
Записать можно, например, в стандартной программе звукозаписи win:
Все программы -> Стандартные -> Развлечения -> Звукозапись.
Там же можно увеличить громкость и обрезать лишнее.
Перед каждой записью необходимо выставить формат аудио: PCM 8,000 кГц; 8 бит; Моно.
Это можно сделать в меню файл -> свойства.
При сохранении файла нужно убедиться, что формат: PCM 8,000 кГц; 8 бит; Моно.

Увеличена допустимая длительность внешнего запроса выезда (от 0 до 3 секунд).

Отключен счет проездов при арбитраже для реверсивного проезда и обратном проезде.
Модифицированы списки карт доступа.
Объединены все карты доступа в один список с разными типами.
Добавлено 2 сектора для системы подсчета свободных мест (свой сектор и соседний сектор).

Переработана функция контроля и принудительного закрытия шлагбаума для реверсивного проезда:
 при включении режима арбитража для реверсивного проезда отключается
 контроль и принудительное закрытие шлагбаума при занятом арбитраже.

Добавлена поддержка 4-строчного дисплея: Настройки -> Общие 2 -> галка "Дисплей 4 строки"
Также добавлены "Строка производителя оборудования" и "Информационная строка".
"Строка производителя оборудования" - выводится при старте стойки на короткое время и постоянно 4-й строкой.
"Информационная строка" - выводится постоянно 3-й строкой.

Добавлена настройка арбитража для реверсивного проезда:
 в настройках шлагбаума пункт: "Арбитраж для реверсивного проезда"
  - при установке галки арбитраж срабатывает и проверяется сразу и в случае
    проигрыша арбитража стойка предлагает клиенту "Проезд занят, нужно отъехать..."
  - при снятии галки арбитраж срабатывает и проверяется только при готовности стойки
    к пропуску клинета: в случае если арбитраж занят, пишет клиенту "Ожидайте очереди проезда..."
Модифицирована работа шлагбаума на предмет скорости реакции на срабатывание концевиков и безопасности.
Добавлена проверка на срабатывание фотоэлемента безопасности, при его использовании для закрытия шлагбаума
 (в настройках галка "Закрытие шлагбаума без контроля фотоэлемента безопасности").
 Если эта галка сброшена и фотоэлемент работает (то есть меняет свое состояние), то закрытие шлагбаума
 будет выполняться после србабатывания петли за шлагбаумом и освобождения фотоэлемента безопасности.
 Если фотоэлемент неисправен и не меняет свое состояние, то закрытие шлагбаума будет выполняться только
 после срабатывания петли за шлагбаумом и ее освобождения, то есть как в варианте с установленой настройкой.
 Контроль срабатывания фотоэлемента безопасности производится каждый раз после открытия шлагбаума.
 То есть если шлагбаум для машины открыли, петля за шлагбаумом замкнулась, а фотоэлемент не срабатывал,
 то закрытие произойдет только по освобождению петли за шлагбаумом.
 Дополнительная степень безопасности, на случай если петля за шлагбаумом сработает раньше, чем фотоэлемент.

Добавлено сообщение при выезде по акцептированому билету.

Убрана ошибка с ложным сообщением "задержка на петле перед шлагбаумом стойки".
Добавлена задержка 0.5 сек. на срабатывание петлей шлагбаума, для устранения ложных срабатываний.
Оптимизирован и ускорен алгоритм выезда по билетам.
Оптимизирован и ускорен алгоритм выезда по картам.
Убрана ошибка с повторным получением сообщения.

Поправлен алгоритм обработки акцептированых билетов.

Установлена пауза 3 секунды на срабатывание концевиков шлагбаума.
Исправлено открытие и закрытие шлагбаума из программы установок.
Сделан независимый счетчик проездов по петлям.
Добавлены секторы для подсчета свободных мест.
Возвращено сообщение EDEV_CARD_EXIT.

Добавлены настройки шлагбаума:

 Использование сигнала "стоп" при нормальной работе шлагбаума.
 Реле "стоп" срабатывает только на фотоэлемент безопасности [по умолчанию включено]:
  если включить этот параметр, реле "стоп" срабатывает только по фотоэлементу безопасности;
  если отключить этот параметр, реле "стоп" срабатывает по концевикам и по фотоэлементу безопасности.

 Реле "стоп" нормально замкнутое (NC / NO) [по умолчанию NO]:
  при установке галки реле "стоп" NC (то есть все свободное время замкнуто, а при команде "стоп" размыкается),
  при снятии галки реле "стоп" NO (то есть все свободное время разомкнуто, а при команде "стоп" замыкается).

 Закрытие шлагбаума без контроля фотоэлемента безопасности [по умолчанию отключено]:
  при установке галки закрытие шлагбаума будет выполняться после съезда авто с петли за шлагбаумом,
  при снятии галки закрытие шлагбаума будет выполняться при въезде авто на петлю за шлагбаумом и освобождении фотоэлемента безопасности шлагбаума.

Изменен алгоритм вывода сообщений сервера, для устранения задержек при проезде.
Доработан тест.

Переведено на оптимизированную схему периферии.
Отключено открытие шлагбаума при срабатывании фотоэлемента безопасности (только останавливается закрытие).
Настроено закрытие шлагбаума на момент въезда на петлю за стойкой и освобождения фотоэлемента безопасности.
Убрано отображение номеров считаных карт доступа.

Добавлен режим тестового проезда.
Добавлена настройка контроля состояния карт доступа (на парковке / вне парковки).
 (настройка: "Общие"->"Отключить проверку состояния карты доступа").
Введена настройка срока действия билетов арендаторов
 (настройка: "Время работы"->"Срок действия билетов арендаторов", или непосредственно с web).
Билеты, напечатаные на терминале 15 (билеты для арендаторов) и укладывающиеся в срок действия - выпускаются на выезд.
Добавлена возможность широковещательной рассылки времени (раз в 5 минут)
 (настройка: "Время работы"->"Широковещательная рассылка времени").
Также, если на стойке включена широковещательная рассылка времени, на web выдается сообщение с текущим временем стойки.
Введена настройка задержки после завершения проезда через стойку (настройка: "Шлагбаум"->"Задержка после проезда").
Исправлена ошибка с тарифом акцептированных билетов - учет дополнительного бесплатного времени при акцептировании билета
 (настройка: "Тарифы"->"Акцептирование"->"Доп.бесплатное время").
Исправлена ошибка со старым билетом.
Исправлено время работы - оставлено общее время работы, убрано время работы по картам и по билетам для выезда.
Не обрабатываются билеты от терминала "арендатор" 15 (для системы выезда по напечатанным билетам).
В заставке пишем "(с)2014 АвтоПарк".
Модификация с новым табло "свободно/мест нет" mbus с мультишины устройств v1.3.
Открытие шлагбаума производится после его полного закрытия или через 5сек с сообщением на сервер об ошибке.
При возникновении ошибки тарифа добавлено сообщение с информацией об ошибочном билете.
Внесены улучшения в работу по картам.
Добавлены времена работы парковки.
Изменена схема работы светофоров.
 Зеленый светофор загорается при открытии шлагбаума и гаснет после въезда на петлю за шлагбаумом, или при закрытии шлагбаума.
 Красный светофор загорается:
  при блокировке стойки,
  при блокировке въезда на парковку по времени,
  при нажатии кнопки печати билета вне времени работы по билетам,
  при считывании карты доступа вне времени работы по картам доступа,
  при невозможности проезда по какой-либо причине,
  при проигрыше арбитража.
Карты доступа (1000шт) в локальной памяти.
Режим арбитража проезда - вход S4 / выход Light GND

Прошивка работает комплектом по UDP.

==================================================

IP по умолчанию: 192.168.0.92

Кнопки:
B1 - вызов оператора / звуковая связь
B2 - внешний запрос выезда
B3 - разблокировка

Датчики:
S1 - токовая петля перед стойкой
S2 - токовая петля после шлагбаума стойки
S4 - арбитраж проезда
S5 - шлагбаум стойки открыт
S6 - шлагбаум стойки закрыт
S7 - шлагбаум стойки безопасность (НЗ)

Реле:
R1 - шлагбаум после выездной стойки вверх
R2 - шлагбаум после выездной стойки вниз
R3 - шлагбаум стоп
Шлагбаум открывается и закрывается импульсами (длительность задается в настройках) до срабатывания концевиков или защиты.
Если нет срабатывания концевиков, выполняется 3 попытки (с паузой 0.2сек между импульсами).
После завершения операции закрытия / открытия или при срабатывании защиты, выдается короткий (0.2сек) импульс стоп.
R4 - красный светофор
R5 - зеленый светофор

Выход:
Light GND - запрос арбитража проезда

Оборудование:
COM2 - считыватель штрихкодов
Card Reader - бесконтактный считыватель Wiegand
RS485 - новое табло
Звук
